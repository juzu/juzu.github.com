<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="generator" content="Asciidoctor 0.1.3">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Juzu Reference Guide</title>
<link rel="stylesheet" href="./foundation-lime.css">
<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/3.1.0/css/font-awesome.min.css">
<style>
.CodeRay {
  background-color: hsl(0,0%,95%);
  border: 1px solid silver;
  color: black;
}
.CodeRay pre {
  margin: 0px;
}

span.CodeRay { white-space: pre; border: 0px; padding: 2px; }

table.CodeRay { border-collapse: collapse; width: 100%; padding: 2px; }
table.CodeRay td { padding: 2px 4px; vertical-align: top; }

.CodeRay .line-numbers {
  background-color: hsl(180,65%,90%);
  color: gray;
  text-align: right;
  -webkit-user-select: none;
  -moz-user-select: none;
  user-select: none;
}
.CodeRay .line-numbers a {
  background-color: hsl(180,65%,90%) !important;
  color: gray !important;
  text-decoration: none !important;
}
.CodeRay .line-numbers a:target { color: blue !important; }
.CodeRay .line-numbers .highlighted { color: red !important; }
.CodeRay .line-numbers .highlighted a { color: red !important; }
.CodeRay span.line-numbers { padding: 0px 4px; }
.CodeRay .line { display: block; float: left; width: 100%; }
.CodeRay .code { width: 100%; }

.CodeRay .debug { color: white !important; background: blue !important; }

.CodeRay .annotation { color:#007 }
.CodeRay .attribute-name { color:#b48 }
.CodeRay .attribute-value { color:#700 }
.CodeRay .binary { color:#509 }
.CodeRay .char .content { color:#D20 }
.CodeRay .char .delimiter { color:#710 }
.CodeRay .char { color:#D20 }
.CodeRay .class { color:#B06; font-weight:bold }
.CodeRay .class-variable { color:#369 }
.CodeRay .color { color:#0A0 }
.CodeRay .comment { color:#777 }
.CodeRay .comment .char { color:#444 }
.CodeRay .comment .delimiter { color:#444 }
.CodeRay .complex { color:#A08 }
.CodeRay .constant { color:#036; font-weight:bold }
.CodeRay .decorator { color:#B0B }
.CodeRay .definition { color:#099; font-weight:bold }
.CodeRay .delimiter { color:black }
.CodeRay .directive { color:#088; font-weight:bold }
.CodeRay .doc { color:#970 }
.CodeRay .doc-string { color:#D42; font-weight:bold }
.CodeRay .doctype { color:#34b }
.CodeRay .entity { color:#800; font-weight:bold }
.CodeRay .error { color:#F00; background-color:#FAA }
.CodeRay .escape  { color:#666 }
.CodeRay .exception { color:#C00; font-weight:bold }
.CodeRay .float { color:#60E }
.CodeRay .function { color:#06B; font-weight:bold }
.CodeRay .global-variable { color:#d70 }
.CodeRay .hex { color:#02b }
.CodeRay .imaginary { color:#f00 }
.CodeRay .include { color:#B44; font-weight:bold }
.CodeRay .inline { background-color: hsla(0,0%,0%,0.07); color: black }
.CodeRay .inline-delimiter { font-weight: bold; color: #666 }
.CodeRay .instance-variable { color:#33B }
.CodeRay .integer  { color:#00D }
.CodeRay .key .char { color: #60f }
.CodeRay .key .delimiter { color: #404 }
.CodeRay .key { color: #606 }
.CodeRay .keyword { color:#080; font-weight:bold }
.CodeRay .label { color:#970; font-weight:bold }
.CodeRay .local-variable { color:#963 }
.CodeRay .namespace { color:#707; font-weight:bold }
.CodeRay .octal { color:#40E }
.CodeRay .operator { }
.CodeRay .predefined { color:#369; font-weight:bold }
.CodeRay .predefined-constant { color:#069 }
.CodeRay .predefined-type { color:#0a5; font-weight:bold }
.CodeRay .preprocessor { color:#579 }
.CodeRay .pseudo-class { color:#00C; font-weight:bold }
.CodeRay .regexp .content { color:#808 }
.CodeRay .regexp .delimiter { color:#404 }
.CodeRay .regexp .modifier { color:#C2C }
.CodeRay .regexp { background-color:hsla(300,100%,50%,0.06); }
.CodeRay .reserved { color:#080; font-weight:bold }
.CodeRay .shell .content { color:#2B2 }
.CodeRay .shell .delimiter { color:#161 }
.CodeRay .shell { background-color:hsla(120,100%,50%,0.06); }
.CodeRay .string .char { color: #b0b }
.CodeRay .string .content { color: #D20 }
.CodeRay .string .delimiter { color: #710 }
.CodeRay .string .modifier { color: #E40 }
.CodeRay .string { background-color:hsla(0,100%,50%,0.05); }
.CodeRay .symbol .content { color:#A60 }
.CodeRay .symbol .delimiter { color:#630 }
.CodeRay .symbol { color:#A60 }
.CodeRay .tag { color:#070 }
.CodeRay .type { color:#339; font-weight:bold }
.CodeRay .value { color: #088; }
.CodeRay .variable  { color:#037 }

.CodeRay .insert { background: hsla(120,100%,50%,0.12) }
.CodeRay .delete { background: hsla(0,100%,50%,0.12) }
.CodeRay .change { color: #bbf; background: #007; }
.CodeRay .head { color: #f8f; background: #505 }
.CodeRay .head .filename { color: white; }

.CodeRay .delete .eyecatcher { background-color: hsla(0,100%,50%,0.2); border: 1px solid hsla(0,100%,45%,0.5); margin: -1px; border-bottom: none; border-top-left-radius: 5px; border-top-right-radius: 5px; }
.CodeRay .insert .eyecatcher { background-color: hsla(120,100%,50%,0.2); border: 1px solid hsla(120,100%,25%,0.5); margin: -1px; border-top: none; border-bottom-left-radius: 5px; border-bottom-right-radius: 5px; }

.CodeRay .insert .insert { color: #0c0; background:transparent; font-weight:bold }
.CodeRay .delete .delete { color: #c00; background:transparent; font-weight:bold }
.CodeRay .change .change { color: #88f }
.CodeRay .head .head { color: #f4f }

</style>
</head>
<body class="book toc2">
<div id="header">
<h1>Juzu Reference Guide</h1>
<span id="author">Julien Viet</span><br>
<span id="email"><a href="http://www.julienviet.com">http://www.julienviet.com</a></span><br>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ol type="none" class="sectlevel0">
<li><a href="#builddeployrun">Build, deploy and run</a></li>
<li>
<ol type="none" class="sectlevel1">
<li><a href="#_build">Build</a></li>
<li>
<ol type="none" class="sectlevel2">
<li><a href="#_with_maven">With Maven</a></li>
<li><a href="#_using_a_prepackaged_application">Using a prepackaged application</a></li>
<li><a href="#_using_an_ide">Using an IDE</a></li>
</ol>
</li>
<li><a href="#_deploy">Deploy</a></li>
<li>
<ol type="none" class="sectlevel2">
<li><a href="#_tomcat">Tomcat</a></li>
<li><a href="#_gatein">GateIn</a></li>
<li><a href="#_liferay">Liferay</a></li>
</ol>
</li>
<li><a href="#_run">Run</a></li>
<li>
<ol type="none" class="sectlevel2">
<li><a href="#_run_modes">Run modes</a></li>
<li><a href="#_how_to_choose_the_right_run_mode">How to choose the right run mode</a></li>
<li><a href="#_configuring_the_run_mode">Configuring the run mode</a></li>
</ol>
</li>
</ol>
</li>
<li><a href="#phases">Phases</a></li>
<li>
<ol type="none" class="sectlevel1">
<li><a href="#_phases">Phases</a></li>
<li>
<ol type="none" class="sectlevel2">
<li><a href="#_view_phase">View phase</a></li>
<li><a href="#_action_phase">Action phase</a></li>
<li><a href="#_resource_phase">Resource phase</a></li>
</ol>
</li>
<li><a href="#_interactions">Interactions</a></li>
<li><a href="#_mapping_onto_http">Mapping onto HTTP</a></li>
<li>
<ol type="none" class="sectlevel2">
<li><a href="#_view_phase_2">View phase</a></li>
<li><a href="#_action_phase_2">Action phase</a></li>
<li><a href="#_resource_phase_2">Resource phase</a></li>
</ol>
</li>
</ol>
</li>
<li><a href="#controllers">Controllers</a></li>
<li>
<ol type="none" class="sectlevel1">
<li><a href="#_overview">Overview</a></li>
<li><a href="#_request_routing">Request routing</a></li>
<li>
<ol type="none" class="sectlevel2">
<li><a href="#_http_request_routing">Http request routing</a></li>
<li><a href="#_portlet_request_routing">Portlet request routing</a></li>
</ol>
</li>
<li><a href="#_controller_phases">Controller phases</a></li>
<li>
<ol type="none" class="sectlevel2">
<li><a href="#_view_controllers">View controllers</a></li>
<li><a href="#_action_controllers">Action controllers</a></li>
<li><a href="#_resource_controllers">Resource controllers</a></li>
<li><a href="#_event_controllers">Event controllers</a></li>
</ol>
</li>
<li><a href="#_controller_classes">Controller classes</a></li>
<li>
<ol type="none" class="sectlevel2">
<li><a href="#_controller_life_cycle">Controller life cycle</a></li>
<li><a href="#_controller_dispatch">Controller dispatch</a></li>
</ol>
</li>
</ol>
</li>
<li><a href="#responses">Responses</a></li>
<li>
<ol type="none" class="sectlevel1">
<li><a href="#_content_responses">Content responses</a></li>
<li><a href="#_render_response">Render response</a></li>
<li><a href="#_view_response">View response</a></li>
<li><a href="#_redirect_response">Redirect response</a></li>
<li><a href="#_error_response">Error response</a></li>
</ol>
</li>
<li><a href="#bridges">Bridges</a></li>
<li>
<ol type="none" class="sectlevel1">
<li><a href="#_servlet_bridge">Servlet bridge</a></li>
<li>
<ol type="none" class="sectlevel2">
<li><a href="#_juzu_servlet">Juzu servlet</a></li>
<li><a href="#_servlet_configuration">Servlet configuration</a></li>
</ol>
</li>
<li><a href="#_portlet_bridge">Portlet bridge</a></li>
<li>
<ol type="none" class="sectlevel2">
<li><a href="#_juzu_portlet">Juzu portlet</a></li>
<li><a href="#_portlet_configuration">Portlet configuration</a></li>
</ol>
</li>
<li><a href="#ioc">Inversion of Control</a></li>
</ol>
</li>
<li><a href="#_containers">Containers</a></li>
<li>
<ol type="none" class="sectlevel1">
<li><a href="#_inversion_of_control">Inversion Of Control</a></li>
<li>
<ol type="none" class="sectlevel2">
<li><a href="#_beans">Beans</a></li>
<li><a href="#_scopes">Scopes</a></li>
<li><a href="#_qualifiers">Qualifiers</a></li>
</ol>
</li>
<li><a href="#_beans_in_action">Beans in action</a></li>
<li>
<ol type="none" class="sectlevel2">
<li><a href="#_template_beans">Template beans</a></li>
<li><a href="#_controller_beans">Controller beans</a></li>
<li><a href="#_application_beans">Application beans</a></li>
</ol>
</li>
<li><a href="#_provider_factories">Provider factories</a></li>
<li><a href="#_provided_container">Provided container</a></li>
<li>
<ol type="none" class="sectlevel2">
<li><a href="#_provided_spring">Provided Spring</a></li>
<li><a href="#_provided_cdi">Provided CDI</a></li>
</ol>
</li>
</ol>
</li>
<li><a href="#templating">Templating</a></li>
<li>
<ol type="none" class="sectlevel1">
<li><a href="#_the_templating_engines">The templating engines</a></li>
<li>
<ol type="none" class="sectlevel2">
<li><a href="#_the_native_template_engine">The native template engine</a></li>
<li><a href="#_the_mustache_template_engine">The Mustache template engine</a></li>
</ol>
</li>
<li><a href="#_using_templates">Using templates</a></li>
<li>
<ol type="none" class="sectlevel2">
<li><a href="#_template_declaration">Template declaration</a></li>
<li><a href="#_template_reuse">Template reuse</a></li>
<li><a href="#_type_safe_parameters">Type safe parameters</a></li>
<li><a href="#_expression_resolution">Expression resolution</a></li>
</ol>
</li>
</ol>
</li>
<li><a href="#taglib">Taglib</a></li>
<li>
<ol type="none" class="sectlevel1">
<li><a href="#_taglib_syntax">Taglib syntax</a></li>
<li><a href="#_include_tag">Include tag</a></li>
<li><a href="#_decorate_insert_tag">Decorate / Insert tag</a></li>
<li><a href="#_title_tag">Title tag</a></li>
<li><a href="#_param_tag">Param tag</a></li>
<li><a href="#_custom_tags">Custom tags</a></li>
<li>
<ol type="none" class="sectlevel2">
<li><a href="#_simple_tags">Simple tags</a></li>
<li><a href="#_java_tags">Java tags</a></li>
</ol>
</li>
</ol>
</li>
<li><a href="#templatespi">Templating SPI</a></li>
<li>
<ol type="none" class="sectlevel1">
<li><a href="#_compiling_a_groovy_template">Compiling a Groovy template</a></li>
<li><a href="#_type_safe_url_resolution">Type safe URL resolution</a></li>
<li><a href="#_template_service_provider_interface">Template Service Provider Interface</a></li>
<li>
<ol type="none" class="sectlevel2">
<li><a href="#_template_providers">Template providers</a></li>
<li><a href="#_template_stub">Template stub</a></li>
</ol>
</li>
<li><a href="#_template_at_work">Template at work</a></li>
<li><a href="#_qualified_template_class">Qualified template class</a></li>
</ol>
</li>
<li><a href="#assets">Assets</a></li>
<li>
<ol type="none" class="sectlevel1">
<li><a href="#_asset_plugin">Asset plugin</a></li>
<li><a href="#_asset_declaration">Asset declaration</a></li>
<li>
<ol type="none" class="sectlevel2">
<li><a href="#_asset_id">Asset id</a></li>
<li><a href="#_application_assets">Application assets</a></li>
<li><a href="#_server_assets">Server assets</a></li>
<li><a href="#_external_assets">External assets</a></li>
</ol>
</li>
<li><a href="#_asset_serving">Asset serving</a></li>
<li>
<ol type="none" class="sectlevel2">
<li><a href="#_declarative_asset_serving">Declarative asset serving</a></li>
<li><a href="#_dynamic_asset_serving">Dynamic asset serving</a></li>
</ol>
</li>
<li><a href="#_asset_server">Asset server</a></li>
<li><a href="#_asset_manager">Asset manager</a></li>
</ol>
</li>
<li><a href="#amd">Javascript modularity</a></li>
<li>
<ol type="none" class="sectlevel1">
<li><a href="#_introduction_to_modules">Introduction to modules</a></li>
<li><a href="#_defining_a_module">Defining a module</a></li>
<li><a href="#_requiring_a_module">Requiring a module</a></li>
</ol>
</li>
<li><a href="#_file_upload_plugin">File upload plugin</a></li>
<li>
<ol type="none" class="sectlevel1">
<li><a href="#_juzu_file_upload_plugin">Juzu File Upload Plugin</a></li>
<li>
<ol type="none" class="sectlevel2">
<li><a href="#_file_upload_in_an_action_phase">File upload in an action phase</a></li>
<li><a href="#_file_upload_in_a_resource_phase">File upload in a resource phase</a></li>
</ol>
</li>
</ol>
</li>
<li><a href="#_less_plugin">Less plugin</a></li>
<li>
<ol type="none" class="sectlevel1">
<li><a href="#_juzu_less_plugin">Juzu Less Plugin</a></li>
<li><a href="#_usage">Usage</a></li>
<li>
<ol type="none" class="sectlevel2">
<li><a href="#_building">Building</a></li>
</ol>
</li>
</ol>
</li>
<li><a href="#_webjars_plugin">WebJars plugin</a></li>
<li>
<ol type="none" class="sectlevel1">
<li><a href="#_juzu_webjars_plugin">Juzu WebJars Plugin</a></li>
<li>
<ol type="none" class="sectlevel2">
<li><a href="#_usage_2">Usage</a></li>
<li><a href="#_building_2">Building</a></li>
</ol>
</li>
</ol>
</li>
<li><a href="#_servlet">Servlet</a></li>
<li>
<ol type="none" class="sectlevel1">
<li><a href="#_juzu_servlet_plugin">Juzu Servlet Plugin</a></li>
<li>
<ol type="none" class="sectlevel2">
<li><a href="#_servlet_class_generation">Servlet class generation</a></li>
<li><a href="#_asset_server_automatic_registration">Asset server automatic registration</a></li>
</ol>
</li>
</ol>
</li>
<li><a href="#_portlet">Portlet</a></li>
<li>
<ol type="none" class="sectlevel1">
<li><a href="#_juzu_portlet_plugin">Juzu Portlet Plugin</a></li>
<li>
<ol type="none" class="sectlevel2">
<li><a href="#_portlet_class_generation">Portlet class generation</a></li>
<li><a href="#_portlet_preferences_injection">Portlet preferences injection</a></li>
<li><a href="#_resource_bundle_injection">Resource bundle injection</a></li>
<li><a href="#_building_3">Building</a></li>
</ol>
</li>
</ol>
</li>
</ol>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Juzu is a web framework based on MVC concepts for developing applications. Juzu is an
open source project developed on <a href="https://github.com/juzu/juzu">GitHub</a> licensed under the
<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache 2 License</a>.</p>
</div>

</div>
</div>
<h1 id="builddeployrun" class="sect0"><a class="anchor" href="#builddeployrun"></a>Build, deploy and run</h1>
<div class="paragraph">
<p>We will study in this chapter how to build and deploy a Juzu application.</p>
</div>
<div class="sect1">
<h2 id="_build"><a class="anchor" href="#_build"></a>Build</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Building a Juzu application is usually done in two steps:</p>
</div>
<div class="ulist">

<ul>
<li>
<p>Compile the application to its binary representation</p>
</li>
<li>
<p>Package the application as a war file</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Compiling an application requires a few jars to be present on the compilation classpath:</p>
</div>
<div class="ulist">

<ul>
<li>
<p>The Juzu core jar for the Juzu API</p>
</li>
<li>
<p>The JSR-330 jar for the @Inject API</p>
</li>
<li>
<p>Any Juzu extension jar such as plugins or additinal template engines</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>After compilation, classes need to be packaged as a web application archive (<em>war</em>) and then deployed in a server. We
will show several ways to package your Juzu application.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">

At the moment Juzu focuses on Maven because it is built with Maven, however that does not mean that Juzu is coupled
to Maven, in the future we will provide additional examples or quickstart for alternative build systems.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_with_maven"><a class="anchor" href="#_with_maven"></a>With Maven</h3>
<div class="paragraph">
<p>Juzu libraries are deployed in the &gt;&gt;http://search.maven.org/[Maven Central repository], compiling an application
 require a few dependencies to find the correct jars.</p>
</div>
<div class="sect3">
<h4 id="_using_the_juzu_maven_em_bom_em"><a class="anchor" href="#_using_the_juzu_maven_em_bom_em"></a>Using the Juzu Maven <em>bom</em></h4>
<div class="paragraph">
<p>The <em>bom</em> is a Juzu artifact that serves the purpose of building and packaging an application:</p>
</div>
<div class="olist arabic">

<ol class="arabic">
<li>
<p>provide a set of dependencies that will be sufficient for compiling the application using its Maven transitive dependencies</p>
</li>
<li>
<p>provide a predefined assembly descriptor that creates a war file containing the application classes, resources and libraries</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>To achieve the first step, we simply declare the following dependency in a Maven artifact:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="xml language-xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.juzu<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>juzu-bom-core<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>$[juzu.version]<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Assembling the application requires more XML but is very straightforward:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="xml language-xml"><span class="tag">&lt;plugin&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>maven-assembly-plugin<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;dependencies&gt;</span>
    <span class="tag">&lt;dependency&gt;</span>
      <span class="tag">&lt;groupId&gt;</span>org.juzu<span class="tag">&lt;/groupId&gt;</span>
      <span class="tag">&lt;artifactId&gt;</span>juzu-bom-core<span class="tag">&lt;/artifactId&gt;</span>
      <span class="tag">&lt;version&gt;</span>$[juzu.version]<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;/dependency&gt;</span>
  <span class="tag">&lt;/dependencies&gt;</span>
  <span class="tag">&lt;executions&gt;</span>
    <span class="tag">&lt;execution&gt;</span>
      <span class="tag">&lt;goals&gt;</span>
        <span class="tag">&lt;goal&gt;</span>single<span class="tag">&lt;/goal&gt;</span>
      <span class="tag">&lt;/goals&gt;</span>
      <span class="tag">&lt;phase&gt;</span>package<span class="tag">&lt;/phase&gt;</span>
      <span class="tag">&lt;configuration&gt;</span>
        <span class="tag">&lt;descriptorRefs&gt;</span>
          <span class="tag">&lt;descriptorRef&gt;</span>tomcat-guice<span class="tag">&lt;/descriptorRef&gt;</span>
        <span class="tag">&lt;/descriptorRefs&gt;</span>
      <span class="tag">&lt;/configuration&gt;</span>
    <span class="tag">&lt;/execution&gt;</span>
  <span class="tag">&lt;/executions&gt;</span>
<span class="tag">&lt;/plugin&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>assembly</em> plugin takes care of packaging the application:</p>
</div>
<div class="olist arabic">

<ol class="arabic">
<li>
<p>The plugin dependency declares on the <em>juzu-bom-core</em> artifact because it contains the predefined descriptors such
as the <code>tomcat-guice</code> descriptor</p>
</li>
<li>
<p>The goal <em>single</em> of the assembly plugin is executed during the <em>package</em> phase</p>
</li>
<li>
<p>The predefined descriptor <em>tomcat-guice</em> packages the application for the Tomcat server and with the Guice framework</p>
<div class="olist loweralpha">

<ol class="loweralpha" type="a">
<li>
<p>Any dependency on the application is packaged in <em>WEB-INF/lib</em></p>
</li>
<li>
<p>The application classes are copied in <em>WEB-INF/classes</em></p>
</li>
<li>
<p>The web application <em>src/main/webapp</em> files are copied to the root of the archive</p>
</li>
<li>
<p>Specific deployment descriptors may be copied in the war file depending on the predefined descriptor</p>
</li>
</ol>
</div>

</li>
</ol>
</div>
<div class="paragraph">
<p>In this example we used the <em>tomcat-guice</em> predefined descriptor. The bom relies on the
<a href="http://maven.apache.org/plugins/maven-assembly-plugin/">Maven Assembly plugin</a>, Juzu provides the
<a href="http://maven.apache.org/plugins/maven-assembly-plugin/descriptor-refs.html">predefined assembly descriptors</a>
that makes easy to package a Juzu application:</p>
</div>
<table class="tableblock frame-all grid-all" style="width:100%; ">
<caption class="title">Table 1. The predefined descriptors</caption>
<colgroup>
<col style="width:25%;">
<col style="width:25%;">
<col style="width:25%;">
<col style="width:25%;"> 
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">tomcat</th>
<th class="tableblock halign-left valign-top">gatein</th>
<th class="tableblock halign-left valign-top">liferay</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">all</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">tomcat</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">gatein</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">liferay</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">guice</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">tomcat-guice</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">gatein-guice</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">liferay-guice</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">tomcat-spring</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">gatein-spring</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">liferay-spring</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cdi</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">tomcat-cdi</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">gatein-cdi</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">liferay-cdi</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">

The predefined assembly descriptor does a similar job to the Maven //war// packaging but with more flexibility. To achieve
the same result, the usage of a war packaging with the overlay feature.
</td>
</tr>
</table>
</div>

</div>
<div class="sect3">
<h4 id="_juzu_archetype"><a class="anchor" href="#_juzu_archetype"></a>Juzu archetype</h4>
<div class="paragraph">
<p>The following creates a base Juzu application for Tomcat with the Guice injection container:</p>
</div>
<div class="listingblock">
<div class="title">Generating an application for the Tomcat server and the Guice injection container</div>
<div class="content monospaced">
<pre>mvn archetype:generate \\
   -DarchetypeGroupId=org.juzu \\
   -DarchetypeArtifactId=juzu-archetype \\
   -DarchetypeVersion=$[juzu.version] \\
   -DgroupId=org.example \\
   -DartifactId=myapp \\
   -DpackageName=org.example.myapp \\
   -Dversion=1.0.0-SNAPSHOT</pre>
</div>
</div>
<div class="paragraph">
<p>The generated application is a quickstart ready to can be customzed for developing more complex applications.
The archetype uses the packager described in the previous section.</p>
</div>
<div class="paragraph">
<p>It is possible to generate the application for a different server and injection container:</p>
</div>
<div class="listingblock">
<div class="title">Generating an application for the Tomcat server and the Spring injection container</div>
<div class="content monospaced">
<pre>mvn archetype:generate \\
   -DarchetypeGroupId=org.juzu \\
   -DarchetypeArtifactId=juzu-archetype \\
   -DarchetypeVersion=$[juzu.version] \\
   -DgroupId=org.example \\
   -DartifactId=myapp \\
   -DpackageName=org.example.myapp \\
   -Dversion=1.0.0-SNAPSHOT \\
   -DjuzuServer=tomcat \\
   -DjuzuInject=spring</pre>
</div>
</div>

</div>

</div>
<div class="sect2">
<h3 id="_using_a_prepackaged_application"><a class="anchor" href="#_using_a_prepackaged_application"></a>Using a prepackaged application</h3>
<div class="paragraph">
<p>The Juzu distribution contains the Booking and Tutorial applications for GateIn and Liferay servers. They can be used
as basis to create applications.</p>
</div>

</div>
<div class="sect2">
<h3 id="_using_an_ide"><a class="anchor" href="#_using_an_ide"></a>Using an IDE</h3>
<div class="paragraph">
<p>Juzu uses Annotation Processing Tool to perform many tasks at compilation time. APT is a standard extension of a Java compiler.
All Java IDE (Eclipse, Intellij and Netbeans) provide good support for APT, we will show in the section how to configure
and uses APT within those IDEs.</p>
</div>
<div class="paragraph">
<p>IDEs provide also Maven support, we will focus in this section on using APT without the Maven support. Indeed the APT support
may work differently when using Maven in your project, the Maven and APT support within IDEs has a dedicated section.</p>
</div>
<div class="sect3">
<h4 id="_intellij_support"><a class="anchor" href="#_intellij_support"></a>Intellij support</h4>
<div class="paragraph">
<p>todo</p>
</div>

</div>
<div class="sect3">
<h4 id="_eclipse_support"><a class="anchor" href="#_eclipse_support"></a>Eclipse support</h4>
<div class="paragraph">
<p>todo</p>
</div>

</div>
<div class="sect3">
<h4 id="_netbeans_support"><a class="anchor" href="#_netbeans_support"></a>Netbeans support</h4>
<div class="paragraph">
<p>todo</p>
</div>

</div>

</div>

</div>
</div>
<div class="sect1">
<h2 id="_deploy"><a class="anchor" href="#_deploy"></a>Deploy</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At the moment the supported (i.e tested) portal servers are</p>
</div>
<div class="ulist">

<ul>
<li>
<p>Tomcat 6.x and 7.x</p>
</li>
<li>
<p>GateIn 3.2 / 3.3 / 3.4 and 3.5</p>
</li>
<li>
<p>Liferay 6.1</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Other server may work but we are not aware of that as it was not tested in other environments.</p>
</div>
<div class="sect2">
<h3 id="_tomcat"><a class="anchor" href="#_tomcat"></a>Tomcat</h3>
<div class="paragraph">
<p>No specific deployment instruction.</p>
</div>

</div>
<div class="sect2">
<h3 id="_gatein"><a class="anchor" href="#_gatein"></a>GateIn</h3>
<div class="sect3">
<h4 id="_gatein_on_tomcat_6_7"><a class="anchor" href="#_gatein_on_tomcat_6_7"></a>GateIn on Tomcat 6/7</h4>
<div class="paragraph">
<p>No specific deployment instruction.</p>
</div>

</div>
<div class="sect3">
<h4 id="_gatein_on_jboss_as_7"><a class="anchor" href="#_gatein_on_jboss_as_7"></a>GateIn on JBoss AS 7</h4>
<div class="paragraph">
<p>GateIn on JBoss AS7 requires a little modification to do:</p>
</div>
<div class="paragraph">
<p>Open the file <em>modules/javax/api/main/module.xml</em> and add <em>&lt;path name="javax/annotation/processing"/&gt;</em> among the <em>paths</em>
declaration:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="xml language-xml"><span class="tag">&lt;module</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:module:1.1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">javax.api</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;dependencies&gt;</span>
    <span class="tag">&lt;system</span> <span class="attribute-name">export</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;paths&gt;</span>
        <span class="tag">&lt;path</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">javax/annotation/processing</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        ...
      <span class="tag">&lt;/paths&gt;</span>
    <span class="tag">&lt;/system&gt;</span>
  <span class="tag">&lt;/dependencies&gt;</span>
<span class="tag">&lt;/module&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This configuration exposes the <code>javax.annotation.processing</code> package to the classes seen by Juzu.</p>
</div>

</div>

</div>
<div class="sect2">
<h3 id="_liferay"><a class="anchor" href="#_liferay"></a>Liferay</h3>
<div class="paragraph">
<p>Liferay has been tested extensively with the Tomcat version, no specific deployment instruction is required.</p>
</div>

</div>

</div>
</div>
<div class="sect1">
<h2 id="_run"><a class="anchor" href="#_run"></a>Run</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_run_modes"><a class="anchor" href="#_run_modes"></a>Run modes</h3>
<div class="paragraph">
<p>Juzu defines three modes for running an application, called <em>run modes</em>:</p>
</div>
<div class="ulist">

<ul>
<li>
<p>Production (<em>prod</em>): error reporting is minimal</p>
</li>
<li>
<p>Development (<em>dev</em>): provides verbose error reporting</p>
</li>
<li>
<p>Live (<em>live</em>): allow to develop the application live with verbose error reporting</p>
</li>
</ul>
</div>

</div>
<div class="sect2">
<h3 id="_how_to_choose_the_right_run_mode"><a class="anchor" href="#_how_to_choose_the_right_run_mode"></a>How to choose the right run mode</h3>
<div class="ulist">

<ul>
<li>
<p>When you are running an application use the <em>prod</em> run mode</p>
</li>
<li>
<p>When you are developing an application with a build system use the <em>dev</em> run mode</p>
</li>
<li>
<p>When you are live developing an application use the <em>live</em> run mode</p>
</li>
</ul>
</div>

</div>
<div class="sect2">
<h3 id="_configuring_the_run_mode"><a class="anchor" href="#_configuring_the_run_mode"></a>Configuring the run mode</h3>
<div class="paragraph">
<p>Run mode is configured via servlet context parameters, by default the <em>prod</em> mode is enabled:</p>
</div>
<div class="ulist">

<ul>
<li>
<p><em>juzu.run_mode</em> : possible values <em>prod</em>, <em>dev</em> or <em>live</em></p>
</li>
<li>
<p><em>juzu.src_path</em> : the source path of the source to compile for the live mode</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Configuring the dev mode in web.xml</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="xml language-xml"><span class="tag">&lt;context-param&gt;</span>
  <span class="tag">&lt;param-name&gt;</span>juzu.run_mode<span class="tag">&lt;/param-name&gt;</span>
  <span class="tag">&lt;param-value&gt;</span>dev<span class="tag">&lt;/param-value&gt;</span>
<span class="tag">&lt;/context-param&gt;</span></code></pre>
</div>
</div>

</div>

</div>
</div>

<h1 id="phases" class="sect0"><a class="anchor" href="#phases"></a>Phases</h1>
<div class="paragraph">
<p>Request life cycle is the most important concept to get right when developping a web application,
whether it is a Juzu application or not. Juzu maps a request to a phase, in this chapter we will explain
the phase concept and its importance.</p>
</div>
<div class="sect1">
<h2 id="_phases"><a class="anchor" href="#_phases"></a>Phases</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Juzu request life cycle is composed of four phases, we will explain three of them in this chapter, the last one
will be explained in another chapter of this guide.</p>
</div>
<div class="ulist">

<ul>
<li>
<p>The view phase : invoke the application to produce markup output aggregated within a page</p>
</li>
<li>
<p>The action phase : invoke the application to process an action</p>
</li>
<li>
<p>The resource phase : invoke the application to produce any kind of output as a full response (i.e not in a page)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>During the execution of a phase, parameters are provided by Juzu to execute the phase. Those parameters are set
by the application itself, for instance when it creates a link. The scope of the parameters (i.e when the validity
of the parameters) depends on the phase.</p>
</div>
<div class="sect2">
<h3 id="_view_phase"><a class="anchor" href="#_view_phase"></a>View phase</h3>
<div class="paragraph">
<p>The view phase invokes the application for the purpose of creating markup. This phase is indempotent, it means that
repeated invocation of the same phase with the same parameters should produce the same markup (supposing than the
application does not depend on some other state, like a database that could change over time).</p>
</div>
<div class="paragraph">
<p>View parameters are associated with the current URL, it means that they are somehow persistent. For instance
you interact with an application to change its view parameters on each request and then you interact with another
application on the same page: the view parameters will remain the same accross the invocation of the view phase of the
application when the second application is used.</p>
</div>

</div>
<div class="sect2">
<h3 id="_action_phase"><a class="anchor" href="#_action_phase"></a>Action phase</h3>
<div class="paragraph">
<p>The action phase invokes the application for processing an action. During the invocation, action parameters are provided
and their validity is limited to the current action phase being executed, after they will not be anymore available.</p>
</div>
<div class="paragraph">
<p>The action phase is not idempotent, invoking several times an action phase could have side effects such as inserting
several times the same data in a database.</p>
</div>
<div class="paragraph">
<p>Juzu does not expect markup returned during this phase, however it provides the opportunity to configure the view
parameters of the next view phase.</p>
</div>

</div>
<div class="sect2">
<h3 id="_resource_phase"><a class="anchor" href="#_resource_phase"></a>Resource phase</h3>
<div class="paragraph">
<p>The resource phase allows the application to produce a web resource such as an image or a full page. When this phase
is invoked, a set of resources parameters are provided in the URL producing the resource.</p>
</div>

</div>

</div>
</div>
<div class="sect1">
<h2 id="_interactions"><a class="anchor" href="#_interactions"></a>Interactions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we have an overview of the phase, it is time to connect them and explain the interactions between the phases.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/request/phases.png" alt="Interactions" width="600">
</div>
<div class="title">Figure 1. Interaction between phases</div>
</div>
<div class="olist arabic">

<ol class="arabic">
<li>
<p>An action phase is invoked by an URL produced during a view phase, this URL contains the action parameters</p>
</li>
<li>
<p>After an action phase a view phase is executed and the view parameters are updated</p>
</li>
<li>
<p>A resource phase is invoked by anURL produced during a view phase, this URL contains the resource parameters</p>
</li>
</ol>
</div>

</div>
</div>
<div class="sect1">
<h2 id="_mapping_onto_http"><a class="anchor" href="#_mapping_onto_http"></a>Mapping onto HTTP</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As said before, phases and interactions have a natural mapping with the HTTP protocol. It is worthy to explain it because it will
 help you to understand fully the interations managed by Juzu.</p>
</div>
<div class="sect2">
<h3 id="_view_phase_2"><a class="anchor" href="#_view_phase_2"></a>View phase</h3>
<div class="paragraph">
<p>View phases are mapped on <em>GET</em> requests:</p>
</div>
<div class="ulist">

<ul>
<li>
<p>The view phase is idempotent like GET</p>
</li>
<li>
<p>View parameters are identified to query parameters</p>
</li>
<li>
<p>The response returned by a GET request should remain identical for the same parameters</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>During a view phase, the application produces URL which can invoke any application phase.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/request/interaction1.png" alt="View phase" width="250">
</div>
<div class="title">Figure 2. View phase</div>
</div>
<div class="paragraph">
<p>In this example the view phase produce markup parameterized by the <code>color</code> parameter having the <em>red</em> value.</p>
</div>

</div>
<div class="sect2">
<h3 id="_action_phase_2"><a class="anchor" href="#_action_phase_2"></a>Action phase</h3>
<div class="paragraph">
<p>Action phase are created from view phase by processing a link that was found in the markup response. The action phase
is mapped on <em>POST</em> requests:</p>
</div>
<div class="ulist">

<ul>
<li>
<p>Both action phases and POST request are not idempotent</p>
</li>
<li>
<p>Action parameters are identified to form parameters</p>
</li>
<li>
<p>Action phase and POST requests should not be invoked more than one time</p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/request/interaction2.png" alt="Action phase" width="250">
</div>
<div class="title">Figure 3. Action phase</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s update our example and suppose that the application returns markup with a form that invokes
an action phase. When the user submits the form it triggers the action phase, which in returns updates the <code>color</code> view
parameter of the next view phase to the value <em>blue</em>.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/request/interaction3.png" alt="View phase after action phase" width="250">
</div>
<div class="title">Figure 4. View phase after action phase</div>
</div>
<div class="paragraph">
<p>The HTTP redirection will update the browser to show the next view phase with the expected view parameters.</p>
</div>
<div id="redirect_after_post" class="paragraph">
<p>During the action phase, the application configures the parameters of the next view phase. When the invocation of the phase
is over, the server redirects the browser (with an HTTP temporary redirection) to the next view phase URL. This URL
 contains the view parameters. This mechanism is well known as <a href="http://fr.wikipedia.org/wiki/Post-Redirect-Get"><em>Redirect After Post</em></a>
 pattern and is often used to ensure that a POST request is not triggered several times when the refresh button of the
 browser is used.</p>
</div>

</div>
<div class="sect2">
<h3 id="_resource_phase_2"><a class="anchor" href="#_resource_phase_2"></a>Resource phase</h3>
<div class="paragraph">
<p>Resource phases are trivially mapped on <em>GET</em> request pretty much like a view phase. The main difference is that
the resource phase is responsible for managing the entire response instead of just a fragment of the response.</p>
</div>

</div>

</div>
</div>

<h1 id="controllers" class="sect0"><a class="anchor" href="#controllers"></a>Controllers</h1>
<div class="paragraph">
<p>Controllers play an essential role in a Juzu application: they contain the code executed when Juzu processes a
request, this chapter provides an in depth study of Juzu controllers.</p>
</div>
<div class="sect1">
<h2 id="_overview"><a class="anchor" href="#_overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Juzu controllers are simply annotated methods of the application, here is the most basic controller declaration:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Controller</span> {
  <span class="annotation">@View</span> <span class="directive">public</span> Response.Content index() {
     <span class="keyword">return</span> Response.render(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello world</span><span class="delimiter">&quot;</span></span>);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The annotation <code>@juzu.View</code> declares a <em>view</em> controller, the name <code>index</code> has a special meaning as it will
be used when no other controller is specifed in a Juzu request.</p>
</div>
<div class="paragraph">
<p>Controller methods can declare parameters for receiving request parameters:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Controller</span> {
  <span class="annotation">@View</span> <span class="directive">public</span> Response.Content index(<span class="predefined-type">String</span> person) {
     <span class="keyword">return</span> Response.ok(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hello </span><span class="delimiter">&quot;</span></span> + person == <span class="predefined-constant">null</span> ? <span class="string"><span class="delimiter">&quot;</span><span class="content">world</span><span class="delimiter">&quot;</span></span> : person);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Like previously, the <code>index</code> controller returns the <em>hello world</em> value when it is called the first time. When
the controller is called with the <code>person</code> parameter it returns the hello string personalized with the corresponding
parameter value: Juzu use the declared method parameter name to match against the request parameters, in our case
 the <code>person</code> request parameter.</p>
</div>
<div class="paragraph">
<p>Any controller class (any class containing at least one controller method) generates a <em>companion</em> class during the
compilation of the project. Such companion class extends the original controller class to provider companion methods
for the controller method. The companion class has the same name than the original class appended with
the <em>_</em> character:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Controller_</span> {
  <span class="directive">public</span> <span class="directive">static</span> Dispatch index() { <span class="comment">/* Generated code */</span> }
  <span class="directive">public</span> <span class="directive">static</span> Dispatch index(<span class="predefined-type">String</span> person) { <span class="comment">/* Generated code */</span> }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each <code>index</code> methods generated a corresponding <code>index</code> method companion. When any <code>index</code> method is invoked
it returns an <code>juzu.Dispatch</code> object that generates the URL dispatching to the corresponding phase when
the <code>toString()</code> method is invoked. When parameters are provided they will be encoded in the generated URL.</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@View</span> <span class="directive">public</span> Response.Content index() {
  <span class="keyword">return</span> Response.ok(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hello word. &lt;a href='</span><span class="delimiter">&quot;</span></span> + Controller_.index(<span class="string"><span class="delimiter">&quot;</span><span class="content">Juzu</span><span class="delimiter">&quot;</span></span>) + <span class="string"><span class="delimiter">&quot;</span><span class="content">'&gt;Say hello to Juzu&lt;/a&gt;</span><span class="delimiter">&quot;</span></span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>URL companion methods have the same signature of the originating method.</p>
</div>

</div>
</div>
<div class="sect1">
<h2 id="_request_routing"><a class="anchor" href="#_request_routing"></a>Request routing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>During a request, Juzu routes the request to the correct controller method. Previously we have seen
that any unmatched view phase request will be handled by the <code>index</code> controller method.</p>
</div>
<div class="paragraph">
<p>In this section we cover the binding of a controller method to a specific request. This binding is
not the same whether you are writing an application that deploys as a servlet or as a portlet.</p>
</div>
<div class="paragraph">
<p>The main difference between the two environements are the request and responses: servlets
interacts with the http protocol whereas the portlets interacts with the portal (which can turns
into the WSRP prococol in the case of a remote portlet).</p>
</div>
<div class="paragraph">
<p>In practice the main difference between servlet and portlet is the routing of the request: with a servlet
the controller methods needs to be bound to route.</p>
</div>
<div class="sect2">
<h3 id="_http_request_routing"><a class="anchor" href="#_http_request_routing"></a>Http request routing</h3>
<div class="paragraph">
<p>When Juzu handles an http request it routes this request to a controller based on the request path. Request routing
is based on a set of route declarations, each declaration binds a route to a controller method.</p>
</div>
<div class="sect3">
<h4 id="_default_controller"><a class="anchor" href="#_default_controller"></a>Default controller</h4>
<div class="paragraph">
<p>Before discussing routing configuration, we shall remind the default controller method: the <code>index</code> view
controller method of the default controller will handle any unmatched request:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@View</span>
<span class="directive">public</span> <span class="type">void</span> index() {
  <span class="comment">// Handle unmatched request</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the application has a single controller class, the default controller is this controller. When there
are more than one controller, there is an ambiguity. In this situation the default controller should be specified
in the <code>@Application</code> annotation:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@Application</span>(defaultController = Controller.class)</code></pre>
</div>
</div>

</div>
<div class="sect3">
<h4 id="_declaring_a_route"><a class="anchor" href="#_declaring_a_route"></a>Declaring a route</h4>
<div class="paragraph">
<p>The <code>@Route</code> annotation declares the route for a controller with a <code>path</code> and an optional <code>priority</code>:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="comment">/*
 * Copyright 2013 eXo Platform SAS
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

<span class="keyword">package</span> <span class="namespace">juzu</span>;

<span class="keyword">import</span> <span class="include">java.lang.annotation.ElementType</span>;
<span class="keyword">import</span> <span class="include">java.lang.annotation.Retention</span>;
<span class="keyword">import</span> <span class="include">java.lang.annotation.RetentionPolicy</span>;
<span class="keyword">import</span> <span class="include">java.lang.annotation.Target</span>;

<span class="comment">/**
 * Defines a route when Juzu is exposes the application over the HTTP protocol. The route can be used
 * at the application level and at the controller level.
 *
 * &lt;h2&gt;Application routes&lt;/h2&gt;
 *
 * &lt;p&gt;An application package can be annotated to &lt;i&gt;mount&lt;/i&gt; the application, this is useful when a
 * compilation unit contains several applications and each needs to be accessed with a different route&lt;/p&gt;
 *
 * &lt;code&gt;&lt;pre&gt;
 *    &amp;#064;{@link Route}(&quot;/myapplication&quot;)
 *    &amp;#064;{@link Application}
 *    package myapplication;
 * &lt;/pre&gt;&lt;/code&gt;
 *
 * &lt;h2&gt;Controller method routes&lt;/h2&gt;
 *
 * &lt;p&gt;Controller methods can be annotated to &lt;i&gt;mount&lt;/i&gt; the controller:&lt;/p&gt;
 *
 * &lt;code&gt;&lt;pre&gt;
 *    public class MyController {
 *
 *       &amp;#064;{@link Action}
 *       &amp;#064;{@link Route}(&quot;/myaction/{value}&quot;)
 *       public {@link juzu.Response.Content} myAction(String value) { ... }
 *
 *       &amp;#064;{@link View}
 *       &amp;#064;{@link Route}(&quot;/myview&quot;)
 *       public {@link juzu.Response.Content} myView() { ... }
 *
 *       &amp;#064;{@link Resource}
 *       &amp;#064;{@link Route}(&quot;/myresource&quot;)
 *       public {@link juzu.Response.Content} myView() { ... }
 *    }
 * &lt;/pre&gt;&lt;/code&gt;
 *
 * The {@link Param} annotation can be used further more for constraining a parameter in the route path.
 *
 * @author &lt;a href=&quot;mailto:julien.viet@exoplatform.com&quot;&gt;Julien Viet&lt;/a&gt;
 */</span>
<span class="annotation">@Retention</span>(<span class="predefined-type">RetentionPolicy</span>.RUNTIME)
<span class="annotation">@Target</span>({<span class="predefined-type">ElementType</span>.METHOD})
<span class="directive">public</span> <span class="annotation">@interface</span> Route {

  <span class="comment">/**
   * The route path.
   *
   * @return the route path
   */</span>
  <span class="predefined-type">String</span> value();

  <span class="comment">/**
   * The route priority.
   *
   * @return the route priority
   */</span>
  <span class="type">int</span> priority() <span class="keyword">default</span> <span class="integer">0</span>;

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Controller method should declare an <code>@Route</code> annotation, in practice with http the
annotations <code>@View</code>, <code>@Action</code> and <code>@Resource</code> are associated with an <code>@Route</code> annotation.</p>
</div>
<div class="listingblock">
<div class="title">Declaring a controller route</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@View</span> <span class="annotation">@Route</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/show</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">void</span> show() {
  ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The request <em>/show</em> will be dispatched to the <code>show()</code> method.</p>
</div>

</div>
<div class="sect3">
<h4 id="_route_parameters"><a class="anchor" href="#_route_parameters"></a>Route parameters</h4>
<div class="paragraph">
<p>Route can declare parameters:</p>
</div>
<div class="listingblock">
<div class="title">Route parameters</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@View</span> <span class="annotation">@Route</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/show/{id}</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">void</span> show(<span class="predefined-type">String</span> id) {
  ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example the route parameter <code>id</code> will match the controller method parameter <code>id</code> and a request like
<em>/show/123</em> will invoke the <code>show(String id)</code> method with the <em>123</em> value.</p>
</div>

</div>
<div class="sect3">
<h4 id="_route_parameter_pattern_matching"><a class="anchor" href="#_route_parameter_pattern_matching"></a>Route parameter pattern matching</h4>
<div class="paragraph">
<p>Optionally, route parameters can match regular expression. This can be achieved with the <code>@Param</code> annotation:</p>
</div>
<div class="listingblock">
<div class="title">Route parameter matching</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@View</span> <span class="annotation">@Route</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/show/{id}</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">void</span> show(<span class="annotation">@Param</span>(pattern=<span class="string"><span class="delimiter">&quot;</span><span class="content">[0-9]+</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> id) {
  ...
}</code></pre>
</div>
</div>

</div>
<div class="sect3">
<h4 id="_route_overloading"><a class="anchor" href="#_route_overloading"></a>Route overloading</h4>
<div class="paragraph">
<p>The same route can bound to different phases, the dispatch behavior depends on the http method:</p>
</div>
<div class="ulist">

<ul>
<li>
<p>in a <em>GET</em> method the phases priority are <em>view</em>, <em>action</em>, <em>resource</em></p>
</li>
<li>
<p>in a <em>POST</em> method the phases priority are <em>action</em>, <em>view</em>, <em>resource</em></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Route parameter matching</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@View</span> <span class="annotation">@Route</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/show</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">void</span> showWithView() {
  ...
}

<span class="annotation">@Action</span> <span class="annotation">@Route</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/show</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">void</span> showWithAction() {
  ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With those rules:</p>
</div>
<div class="ulist">

<ul>
<li>
<p>A <em>GET</em> request on the <em>/show</em> path will invoke the <code>showWithAction()</code> method</p>
</li>
<li>
<p>A <em>POST</em> request on the <em>/show</em> path will invoke the <code>showWithView()</code> method</p>
</li>
</ul>
</div>

</div>
<div class="sect3">
<h4 id="_route_priorities"><a class="anchor" href="#_route_priorities"></a>Route priorities</h4>
<div class="paragraph">
<p>When several routes match the same request, the router will use the first route found. The <code>priority</code>
parameter of the <code>@Route</code> annotation can be used to increase the priority of a route. This can
be useful, specially when a route contains a parameter that could match another route instead.</p>
</div>
<div class="listingblock">
<div class="title">Route priority</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@View</span> <span class="annotation">@Route</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/show/status</span><span class="delimiter">&quot;</span></span>, priority = <span class="integer">1</span>)
<span class="directive">public</span> <span class="type">void</span> showStatus() {
  ...
}
<span class="annotation">@View</span> <span class="annotation">@Route</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/show/{name}</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">void</span> show(<span class="predefined-type">String</span> name) {
  ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example, the <code>showStatus()</code> controller will be invoked when the route <em>/show/status</em> is requested.
Without this higher priority, the <code>show(String name)</code> controller might be invoked instead. When no priority is
specified, the default priority is 0.</p>
</div>

</div>
<div class="sect3">
<h4 id="_redirect_after_post"><a class="anchor" href="#_redirect_after_post"></a>Redirect after post</h4>
<div class="paragraph">
<p>As explained in the <a href="#phases">Phases</a> chapter, an action never produces markup, instead an action phase
 is followed by a view phase that will return a markup response. Juzu handles this interaction with an http redirection
 to the next view phase via the <a href="#redirect_after_post">[redirect_after_post]</a> pattern.</p>
</div>
<div class="paragraph">
<p>This behavior is good for the user because the browser will be updated with an URL of the view phase that is
bookmarkable and safely refreshable (i.e the user an refresh the page safely).</p>
</div>
<div class="paragraph">
<p>However Juzu does not enforce this behavior and it can be changed to have the view phase immediatly
invoked after the action phase.</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@Action</span>
<span class="annotation">@Route</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/process</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> Response.View process() {
  <span class="keyword">return</span> Controller_.index().withNo(PropertyType.REDIRECT_AFTER_ACTION);
}

<span class="annotation">@juzu</span>.View
<span class="annotation">@Route</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/show</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">void</span> show() {
  <span class="comment">//</span>
}</code></pre>
</div>
</div>

</div>

</div>
<div class="sect2">
<h3 id="_portlet_request_routing"><a class="anchor" href="#_portlet_request_routing"></a>Portlet request routing</h3>
<div class="paragraph">
<p>Unlike the http protocol, the portlet request routing does not require the <code>@Route</code> annotation
because portlet requests are managed by the portal and have no concept of path mapping.</p>
</div>
<div class="paragraph">
<p>To achieve request routing, the portlet uses a special portlet request parameter
named <em>juzu.op</em> . This parameter determines which controller should be called
during a phase. When the <em>juzu.op</em> parameter is not present, Juzu will look for the <code>index</code>
view controller.</p>
</div>

</div>

</div>
</div>
<div class="sect1">
<h2 id="_controller_phases"><a class="anchor" href="#_controller_phases"></a>Controller phases</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are several kinds of controllers bound to a request phase:</p>
</div>
<div class="ulist">

<ul>
<li>
<p>View controllers annoted with the <code>@juzu.View</code> annotation</p>
</li>
<li>
<p>Action controllers annotated with the <code>@juzu.Action</code> annotation</p>
</li>
<li>
<p>Resource controllers annotated with the <code>@juzu.Resource</code> annotation</p>
</li>
<li>
<p>Event controllers annotated with the <code>@juzu.Event</code> annotation (<em>not yet implemented</em>)</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_view_controllers"><a class="anchor" href="#_view_controllers"></a>View controllers</h3>
<div class="paragraph">
<p>A view controller method produces aggregated markup for the application, the invocation of the method
should produce markup that will be aggregated in larger page, therefore it should not care about the overall HTML
structure.</p>
</div>
<div class="paragraph">
<p>View parameters describe the current parameters of the view, they are often used for navigation purpose in the application.
Juzu supports simple data types such as string and structured data types modelled by Java objects.</p>
</div>
<div class="ulist">

<ul>
<li>
<p>Simple data types can be the following types <code>String</code>, <code>List&lt;String&gt;</code> and <code>String[]</code>. Later this will be expanded
to more simple types such as number, etc..</p>
</li>
<li>
<p>Structured data types : todo</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>View controller method should return a <code>juzu.Response</code> object that is the content produced by the method. To be more precise
 it should return a <code>Response.Body</code> or <code>Response.Content</code> object (the latter being a subclass of the former) that contains
 everything Juzu needs to display the application.</p>
</div>
<div class="paragraph">
<p>During the view phase a controller can generate URLs to other phases (except the event phase) by using controller companion
 methods. Companion methods returns a <code>juzu.Dispatch</code> object to represent the URL. The final
 URL is returned by the <code>toString()</code> method of the dispatch object.</p>
</div>

</div>
<div class="sect2">
<h3 id="_action_controllers"><a class="anchor" href="#_action_controllers"></a>Action controllers</h3>
<div class="paragraph">
<p>Action controller are executed during the action phase of a Juzu application. Usually action methods perform two tasks</p>
</div>
<div class="ulist">

<ul>
<li>
<p>implement the logic of the application processing, for instance inserting an entity in the database</p>
</li>
<li>
<p>configure the next view phase: setting the next view controller to display and configuring its view parameters
of the method when they exist</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the following example, the controller method <code>createUser</code>  creates a user and
returns a <code>Response.View</code> object that will tell Juzu to use the <code>showUser</code> view controller during the next view phase:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@Action</span>
<span class="directive">public</span> Response.View addUser(<span class="predefined-type">String</span> userName, <span class="predefined-type">String</span> password) {
  orgService.createUser(userName, password);
  <span class="keyword">return</span> Controller_.showUser(userName);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>showUser</code> is a companion <em>view</em> method that creates a +Response.View_ object configured with the
controller and arguments to use. Like url companion methods, view companion methods are generated during
the compilation of the project by Juzu.</p>
</div>

</div>
<div class="sect2">
<h3 id="_resource_controllers"><a class="anchor" href="#_resource_controllers"></a>Resource controllers</h3>
<div class="paragraph">
<p>Resource controllers are similar to view controllers, however the resource has full control over the target page.
It means that a resource controller must produce the entire resource and it can also chose the mime type returned. Resource
controllers have several use cases:</p>
</div>
<div class="ulist">

<ul>
<li>
<p>Implement ajax resource serving</p>
</li>
<li>
<p>Produce an application resource, such as an image, a script, etc&#8230;</p>
</li>
</ul>
</div>

</div>
<div class="sect2">
<h3 id="_event_controllers"><a class="anchor" href="#_event_controllers"></a>Event controllers</h3>
<div class="paragraph">
<p><em>not yet implemented</em></p>
</div>

</div>

</div>
</div>
<div class="sect1">
<h2 id="_controller_classes"><a class="anchor" href="#_controller_classes"></a>Controller classes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Controller methods belongs to Java classes known as controller classes. Controller classes are ordinary java classes,
any class can be turned into a controller by declaring a controller method. Controller classes are registered in
the IOC container of the Juzu application, we will study later the benefits.</p>
</div>
<div class="sect2">
<h3 id="_controller_life_cycle"><a class="anchor" href="#_controller_life_cycle"></a>Controller life cycle</h3>
<div class="paragraph">
<p>We will study in this section the complete life cycle of a controller object. Juzu relies on the IOC container
for managing the life cycle of controller objects, based on the <code>@javax.inject.Inject</code> annotation. If the
 controller desires, it can receive life cycle callbacks thanks to the <code>@javax.annotation.PostConstruct</code>
 and <code>@javax.annotation.PreDestroy</code> annotations.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s have a look at the complete life cycle of a controller object during a Juzu request:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/controllers/lifecycle.png" alt="Life cycle" width="500">
</div>
<div class="title">Figure 5. Life cycle of a controller object</div>
</div>
<div class="olist arabic">

<ol class="arabic">
<li>
<p>Juzu begins the request, it will need an controller instance for the request and asks the IOC container an instance</p>
</li>
<li>
<p>The IOC container creates a fully operational controller instance in several stesp</p>
<div class="olist loweralpha">

<ol class="loweralpha" type="a">
<li>
<p>It gets a controller object instance either by creating a new instance by using the default constructor
or the constructor annotated with @Inject</p>
</li>
<li>
<p>It injects the controller declared dependencies by the @Inject annotation</p>
</li>
<li>
<p>It invokes any method annotated with @PostConstruct</p>
</li>
</ol>
</div>

</li>
<li>
<p>Juzu obtains a valid controller instance and <a id="dispatches&gt;&gt;#controller_dispatch"></a> that method on the controller</p>
</li>
<li>
<p>After the invocation, Juzu releases the controller instance and delegates it to the IOC container again</p>
<div class="olist loweralpha">

<ol class="loweralpha" type="a">
<li>
<p>It invokes any method annotated with @PreDestroy</p>
</li>
<li>
<p>It makes the instance available to the garbage collector</p>
</li>
</ol>
</div>

</li>
<li>
<p>Juzu ends the request and use the Response objet returned by the controller method</p>
</li>
</ol>
</div>

</div>
<div class="sect2">
<h3 id="_controller_dispatch"><a class="anchor" href="#_controller_dispatch"></a>Controller dispatch</h3>
<div class="paragraph">
<p>The bare minimum Juzu will do when dispatching to a controller method is to invoke this method with the proper
arguments and use the optionally returned object as a response for the request.</p>
</div>
<div class="paragraph">
<p>When the controller wants to deal with the dispatch in a generic manner (i.e detyped), it can implement the
<code>juzu.request.RequestLifeCycle</code> interface that allows to:</p>
</div>
<div class="ulist">

<ul>
<li>
<p>Be aware of the request life cycle around (i.e before and after) the controller method dispatch</p>
</li>
<li>
<p>Control the response for the current request</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">The RequestLifeCycle interface</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">RequestLifeCycle</span> {

  <span class="type">void</span> beginRequest(RequestContext context);

  <span class="type">void</span> endRequest(RequestContext context);

}</code></pre>
</div>
</div>
<div class="ulist">

<ul>
<li>
<p>The <code>beginRequest</code> method is invoked before the controller method invocation and the <code>endRequest</code> is invoked
after the controller method invocation.</p>
</li>
<li>
<p>The <code>RequestContext</code> object provides a read/write access to a <code>juzu.Response</code> object that is set with the
response returned by the controller method invocation. The controller method can declare no return type and instead
set the response directly with the <code>RequestContext#setResponse(juzu.Response)</code> method.</p>
</li>
<li>
<p>When the controller method invocation throws an exception, the <code>endRequest</code> method will be invoked with a
<code>juzu.Response.Error</code> response set on the <code>RequestContext</code>.</p>
</li>
<li>
<p>The <code>beginRequest</code> invocation can optionally set of response on the <code>RequestContext</code>, when it does the dispatch
will stop here and the provided response will be the request response.</p>
</li>
<li>
<p>The <code>endRequest</code> invocation can optionally set a response on the <code>RequestContext</code>, when it does this overrides
the previous response provided during the dispatch to the controller method.</p>
</li>
</ul>
</div>

</div>

</div>
</div>

<h1 id="responses" class="sect0"><a class="anchor" href="#responses"></a>Responses</h1>
<div class="paragraph">
<p>Each request produces a response object: a subclass of the <code>juzu.Response</code> class.</p>
</div>
<div class="paragraph">
<p>Response objects are returned by method processing phases, the class of the object determines the kind of response
sent to the client. A response object may carry additional objects such as assets (css or script).</p>
</div>
<div class="paragraph">
<p>Response object are created thanks to the static factory methods of the <code>juzu.Response</code> class. The <code>Response</code>
class is abstract and it has several subclasses that form a possible hierarchy of response adapted to the phase
being processed.</p>
</div>
<div class="sect1">
<h2 id="_content_responses"><a class="anchor" href="#_content_responses"></a>Content responses</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A <em>content</em> response is a markup or binary data, it can be created with the <code>ok</code> static method:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java">  <span class="directive">public</span> <span class="directive">static</span> Response.Content&lt;Stream.Char&gt; ok(<span class="predefined-type">CharSequence</span> content) { ... }</code></pre>
</div>
</div>
<div class="paragraph">
<p>It can be used during a <em>view</em> or <em>resource</em> phase to return markup:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@View</span>
<span class="directive">public</span> Response.Content index() {
  <span class="keyword">return</span> Response.ok(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hello World</span><span class="delimiter">&quot;</span></span>);
}</code></pre>
</div>
</div>

</div>
</div>
<div class="sect1">
<h2 id="_render_response"><a class="anchor" href="#_render_response"></a>Render response</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A <em>render</em> response extends a <em>content</em> response, it specializes it for aggregated markup, i.e a response where the
 application manages only one portion of the full page such as a portal:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@View</span>
<span class="directive">public</span> Response.Content index() {
  <span class="keyword">return</span> Response.ok(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hello World</span><span class="delimiter">&quot;</span></span>).withTitle(<span class="string"><span class="delimiter">&quot;</span><span class="content">The Hello</span><span class="delimiter">&quot;</span></span>);
}</code></pre>
</div>
</div>

</div>
</div>
<div class="sect1">
<h2 id="_view_response"><a class="anchor" href="#_view_response"></a>View response</h2>
<div class="sectionbody">
<div class="paragraph">
<p><em>View</em> response is returned after the <em>action</em> phase to configure the next <em>view</em> phase. Usually view responses are not
created directly using static factory methods, instead they are created using controller companion static methods, this will
be <a id="explained&gt;&gt;#controller_action_view"></a> in the controller chapter.</p>
</div>

</div>
</div>
<div class="sect1">
<h2 id="_redirect_response"><a class="anchor" href="#_redirect_response"></a>Redirect response</h2>
<div class="sectionbody">
<div class="paragraph">
<p><em>Redirect</em> responses are returned during an <em>action</em> phase to redirect the user agent to an URL, its usage is simple:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@Action</span>
<span class="directive">public</span> Response.Redirect process() {
  <span class="keyword">return</span> Response.redirect(<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.host.com/</span><span class="delimiter">&quot;</span></span>);
}</code></pre>
</div>
</div>

</div>
</div>
<div class="sect1">
<h2 id="_error_response"><a class="anchor" href="#_error_response"></a>Error response</h2>
<div class="sectionbody">
<div class="paragraph">
<p><em>Error</em> response can be returned during any phase to signal an application error. This kind of response is different
from a content response with a 5xx status code, however it can be turned into a 5xx response to the client.</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@View</span>
<span class="directive">public</span> Response index() {
  <span class="keyword">try</span> {
    ...
  } <span class="keyword">catch</span>(<span class="exception">IOException</span> e) {
    <span class="keyword">return</span> Response.error(e);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>An error response can also be generated by the controller method by declaring the exception in its throw clause, so the
previous example is equivalent to:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java">
<span class="annotation">@View</span>
<span class="directive">public</span> Response index() <span class="directive">throws</span> <span class="exception">IOException</span> {
  ...
}</code></pre>
</div>
</div>

</div>
</div>

<h1 id="bridges" class="sect0"><a class="anchor" href="#bridges"></a>Bridges</h1>
<div class="paragraph">
<p>The bridge is the runtime in which Juzu executes, until now Juzu provides two bridges:</p>
</div>
<div class="ulist">

<ul>
<li>
<p>The servlet bridge executes a Juzu application in a servlet container like Tomcat</p>
</li>
<li>
<p>The portlet bridge executes a Juzu application in a portlet container inside a portal</p>
</li>
</ul>
</div>
<div class="sect1">
<h2 id="_servlet_bridge"><a class="anchor" href="#_servlet_bridge"></a>Servlet bridge</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The servlet bridge exposes a Juzu application as a servlet in a Servlet Container.</p>
</div>
<div class="sect2">
<h3 id="_juzu_servlet"><a class="anchor" href="#_juzu_servlet"></a>Juzu servlet</h3>
<div class="paragraph">
<p>The first step for using the servlet bridge is to configure the <code>juzu.bridge.servlet.JuzuServlet</code> servlet for
the application. There is a one to one mapping between a Juzu application and a Juzu servlet. Therefore
if you project contains several applications, you should configure a Juzu servlet for each.</p>
</div>

</div>
<div class="sect2">
<h3 id="_servlet_configuration"><a class="anchor" href="#_servlet_configuration"></a>Servlet configuration</h3>
<div class="paragraph">
<p>Declaring a Juzu servlet is done in the //web.xml// file of the web application:</p>
</div>
<div class="listingblock">
<div class="title">The Juzu servlet configuration</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="xml language-xml"><span class="tag">&lt;servlet&gt;</span>
  <span class="tag">&lt;servlet-name&gt;</span>JuzuServlet<span class="tag">&lt;/servlet-name&gt;</span>
  <span class="tag">&lt;servlet-class&gt;</span>juzu.bridge.servlet.JuzuServlet<span class="tag">&lt;/servlet-class&gt;</span>
  <span class="tag">&lt;init-param&gt;</span>
    <span class="tag">&lt;param-name&gt;</span>juzu.app_name<span class="tag">&lt;/param-name&gt;</span>
    <span class="tag">&lt;param-value&gt;</span>my.application<span class="tag">&lt;/param-value&gt;</span>
  <span class="tag">&lt;/init-param&gt;</span>
<span class="tag">&lt;/servlet&gt;</span>
<span class="tag">&lt;servlet-mapping&gt;</span>
  <span class="tag">&lt;servlet-name&gt;</span>JuzuServlet<span class="tag">&lt;/servlet-name&gt;</span>
  <span class="tag">&lt;url-pattern&gt;</span>/<span class="tag">&lt;/url-pattern&gt;</span>
<span class="tag">&lt;/servlet-mapping&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>juzu.app_name</em> init parameter tells Juzu the package of the application to use. The servlet is bound
on the <em>/</em> pattern as the default servlet of the web application.</p>
</div>
<div class="paragraph">
<p>In case of several applications, each can be configured with a <em>path mapping</em> in addition of the default servlet:</p>
</div>
<div class="listingblock">
<div class="title">Path mapping configuration</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="xml language-xml"><span class="tag">&lt;servlet-mapping&gt;</span>
  <span class="tag">&lt;servlet-name&gt;</span>JuzuServlet<span class="tag">&lt;/servlet-name&gt;</span>
  <span class="tag">&lt;url-pattern&gt;</span>/myapplication/*<span class="tag">&lt;/url-pattern&gt;</span>
<span class="tag">&lt;/servlet-mapping&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="icon-warning" title="Warning"></i>
</td>
<td class="content">

Any other kind of <em>url-pattern</em> than the default servlet (<em>/</em>) or path mapping is not supported
and will raise an error during startup
</td>
</tr>
</table>
</div>

</div>

</div>
</div>
<div class="sect1">
<h2 id="_portlet_bridge"><a class="anchor" href="#_portlet_bridge"></a>Portlet bridge</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The portlet bridge exposes a Juzu application as a portlet in a Portlet Container.</p>
</div>
<div class="sect2">
<h3 id="_juzu_portlet"><a class="anchor" href="#_juzu_portlet"></a>Juzu portlet</h3>
<div class="paragraph">
<p>The first step for using the portlet bridge is to configure the <code>juzu.bridge.portlet.JuzuPortlet</code> portlet for
the application. There is a one to one mapping between a Juzu application and a Juzu portlet. Therefore
if you project contains several applications, you should configure a Juzu portlet for each.</p>
</div>

</div>
<div class="sect2">
<h3 id="_portlet_configuration"><a class="anchor" href="#_portlet_configuration"></a>Portlet configuration</h3>
<div class="paragraph">
<p>Declaring a Juzu portlet is done in the <em>portlet.xml</em> file of the portlet application:</p>
</div>
<div class="listingblock">
<div class="title">The Juzu portlet configuration</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="xml language-xml"><span class="tag">&lt;portlet&gt;</span>
  <span class="tag">&lt;portlet-name&gt;</span>JuzuPortlet<span class="tag">&lt;/portlet-name&gt;</span>
  <span class="tag">&lt;display-name</span> <span class="attribute-name">xml:lang</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">EN</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>Juzu Portlet Application<span class="tag">&lt;/display-name&gt;</span>
  <span class="tag">&lt;portlet-class&gt;</span>juzu.bridge.portlet.PortletBridge<span class="tag">&lt;/portlet-class&gt;</span>
  <span class="tag">&lt;init-param&gt;</span>
    <span class="tag">&lt;param-name&gt;</span>juzu.app_name<span class="tag">&lt;/param-name&gt;</span>
    <span class="tag">&lt;param-value&gt;</span>my.application<span class="tag">&lt;/param-value&gt;</span>
  <span class="tag">&lt;/init-param&gt;</span>
  <span class="tag">&lt;supports&gt;</span>
    <span class="tag">&lt;mime-type&gt;</span>text/html<span class="tag">&lt;/mime-type&gt;</span>
  <span class="tag">&lt;/supports&gt;</span>
  <span class="tag">&lt;portlet-info&gt;</span>
    <span class="tag">&lt;title&gt;</span>Portlet Application<span class="tag">&lt;/title&gt;</span>
  <span class="tag">&lt;/portlet-info&gt;</span>
<span class="tag">&lt;/portlet&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>juzu.app_name</em> init parameter tells Juzu the package of the application to use.</p>
</div>

</div>

</div>
</div>
<div class="sect1">
<h2 id="ioc"><a class="anchor" href="#ioc"></a>Inversion of Control</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Juzu provides native support for Injection of Control (known as <em>IOC</em>) and relies on the specification
<a href="http://docs.oracle.com/javaee/6/api/javax/inject/package-summary.html">JSR 330</a> (known as <em>@Inject</em>).</p>
</div>
<div class="paragraph">
<p>Although the JSR-330 is quite small it provides the necessary ground for building Juzu applications. Juzu relies
on the injection container for wiring the entire Juzu runtime (controllers, templates, plugins, etc&#8230;).</p>
</div>
<div class="paragraph">
<p>We will explain how Juzu uses IOC for its runtime, we suppose the reader is familliar with IOC and with the <code>@Inject</code>
specification, in particular the notion of injection, scope and qualifier should be familliar.</p>
</div>

</div>
</div>

<h1 id="_containers" class="sect0"><a class="anchor" href="#_containers"></a>Containers</h1>
<div class="paragraph">
<p>At the moment Juzu supports three containers implementing the JSR 330:</p>
</div>
<div class="ulist">

<ul>
<li>
<p><a href="http://static.springsource.org/spring/docs/3.1.x/spring-framework-reference/html/">Spring Core 3</a></p>
</li>
<li>
<p>Context and Dependency Injection also know as <em>CDI</em> implemented by the <a href="http://seamframework.org/Weld">Weld</a> project</p>
</li>
<li>
<p><a href="http://code.google.com/p/google-guice/wiki/Guice30">Google Guice 3</a></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">

CDI is a specification that extends the <em>@Inject</em> specification: CDI provides more features than @Inject, however
this specification is only implemented by Weld. Nevertheless if your choice is to use CDI you will be leverage its specific
features in your Juzu application
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Juzu can run with any of those implementation and leaves you the choice of the IOC implementation you want to use. The container
to selection is done via the servlet context parameter <em>juzu.inject</em>:</p>
</div>
<div class="ulist">

<ul>
<li>
<p><em>guice</em> for Google Guice</p>
</li>
<li>
<p><em>spring</em> for Spring</p>
</li>
<li>
<p><em>weld</em> for JBoss Weld</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Configuring the Spring container in web.xml</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="xml language-xml"><span class="tag">&lt;context-param&gt;</span>
  <span class="tag">&lt;param-name&gt;</span>juzu.inject<span class="tag">&lt;/param-name&gt;</span>
  <span class="tag">&lt;param-value&gt;</span>spring<span class="tag">&lt;/param-value&gt;</span>
<span class="tag">&lt;/context-param&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="icon-warning" title="Warning"></i>
</td>
<td class="content">

When no IOC container is specified the Guice container will be used
</td>
</tr>
</table>
</div>
<div class="sect1">
<h2 id="_inversion_of_control"><a class="anchor" href="#_inversion_of_control"></a>Inversion Of Control</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_beans"><a class="anchor" href="#_beans"></a>Beans</h3>
<div class="paragraph">
<p>Beans are simply object managed by the IOC container, any bean can be injected other beans:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@java</span>.inject.Inject
Service service;</code></pre>
</div>
</div>

</div>
<div class="sect2">
<h3 id="_scopes"><a class="anchor" href="#_scopes"></a>Scopes</h3>
<div class="paragraph">
<p>Scopes define how a instances of a bean are managed by the IOC container: for a given bean, shall it be instantiated
 only one time and shared or shall it instantiated everty time it is required ? that&#8217;s the kind of question
 that scope answers.</p>
</div>
<div class="paragraph">
<p>Juzu provides 4 scopes to use within your application:</p>
</div>
<div class="ulist">

<ul>
<li>
<p><code>@javax.inject.Singleton</code> scope: a single bean instance is the same for the whole application</p>
</li>
<li>
<p><code>@juzu.RequestScoped</code> scope: the bean is instantiated once per request</p>
</li>
<li>
<p><code>@juzu.SessionScoped</code> scope: the bean is instantiated once per session</p>
</li>
<li>
<p><code>@juzu.FlashScoped</code> scope: the bean is instantiated once per request but is reused if it was instantiated during
an action request in the next render request and only in the first one</p>
</li>
</ul>
</div>

</div>
<div class="sect2">
<h3 id="_qualifiers"><a class="anchor" href="#_qualifiers"></a>Qualifiers</h3>
<div class="paragraph">
<p>Qualifier are designed to distinguish several instances of a same bean. How does a bean differ from another bean ?
it&#8217;s not really possible to tell, qualifiers simply answer this question, allowing to:</p>
</div>
<div class="ulist">

<ul>
<li>
<p>distinguish beans based upon the qualifier members</p>
</li>
<li>
<p>configure the bean instance for a particular usage</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The JSR-330 specification provides the <code>@Named</code> qualifier whose purpose is to give a name to a bean, for instance</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@Named</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">john</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Inject</span> Person john;

<span class="annotation">@Named</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">peter</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Inject</span> Person peter;</code></pre>
</div>
</div>

</div>

</div>
</div>
<div class="sect1">
<h2 id="_beans_in_action"><a class="anchor" href="#_beans_in_action"></a>Beans in action</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Beans are simply the objects managed by the IOC engine. In a Juzu applications we have several kind of beans:</p>
</div>
<div class="ulist">

<ul>
<li>
<p>Controllers</p>
</li>
<li>
<p>Template</p>
</li>
<li>
<p>Application beans</p>
</li>
<li>
<p>Plugin beans</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_template_beans"><a class="anchor" href="#_template_beans"></a>Template beans</h3>
<div class="paragraph">
<p>Every template has a corresponding <code>juzu.template.Template</code> class at runtime. The template class allows
applications to interact with templates, most of the time for creating a controller ok response:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java">template.ok();</code></pre>
</div>
</div>
<div class="paragraph">
<p>A template bean is always qualified by the <code>@Path</code> qualifier. The path qualifier is simply the value of the path
relative to the <em>templates</em> package, for instance <em>index.gtmpl</em> is a valid qualifier value. The qualifier allows
to have several <code>Template</code> instances and distinguish them.</p>
</div>
<div class="paragraph">
<p>Templates have the <code>@Singleton</code> scope: a single instance of the template object is created and shared in the IOC
container.</p>
</div>

</div>
<div class="sect2">
<h3 id="_controller_beans"><a class="anchor" href="#_controller_beans"></a>Controller beans</h3>
<div class="paragraph">
<p>Each controller class is turned into a bean, that&#8217;s how controllers can be injected with other beans. As soon
as Juzu finds a class annotated by <code>@View</code>, <code>@Action</code> or <code>@Resource</code>, it is automatically turned into a bean.</p>
</div>
<div class="paragraph">
<p>Controller have the <code>Request</code> scope by default: every time a controller instance is required it will be created
for the duration of the request. It is possible to change the scope of a controller by annotating it with another
scope annotation managed by Juzu:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@SessionScoped</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Controller</span> {
   <span class="annotation">@View</span>
   <span class="directive">public</span> <span class="type">void</span> index() { }
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_injection_a_template_into_a_controller"><a class="anchor" href="#_injection_a_template_into_a_controller"></a>Injection a template into a controller</h4>
<div class="paragraph">
<p>Injecting a template bean into a controller bean is probably the most common Juzu pattern:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@Inject</span>
<span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">index.gtmpl</span><span class="delimiter">&quot;</span></span>)
Template index;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The template can then be used for creating a response:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@View</span>
<span class="directive">public</span> Response.Content index() {
   <span class="keyword">return</span> index.ok();
}</code></pre>
</div>
</div>

</div>

</div>
<div class="sect2">
<h3 id="_application_beans"><a class="anchor" href="#_application_beans"></a>Application beans</h3>
<div class="paragraph">
<p>Application beans model the custom logic of an application, they are normally injected in controller beans that use
them when they process requests. The <em>binding</em> plugin allows an application to declare custom beans that can be used
in the application.</p>
</div>
<div class="sect3">
<h4 id="_pojo_bean_binding"><a class="anchor" href="#_pojo_bean_binding"></a>POJO bean binding</h4>
<div class="paragraph">
<p>Binding a Plain Old Java Object (POJO) is a very simple task to accomplish:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@Bindings</span>(<span class="annotation">@Binding</span>(Mailer.class))
<span class="keyword">package</span> <span class="namespace">myapplication</span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The bean will be entirely managed by the IOC container, the binding plugin will just declare it in the IOC container.
The POJO will be created when needed, for instance when it is inserted in a controller.</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="directive">public</span> <span class="type">class</span> <span class="class">MyController</span> {
   <span class="annotation">@Inject</span> Mailer mailer;
   <span class="annotation">@Action</span>
   <span class="directive">public</span> <span class="type">void</span> sendMail(<span class="predefined-type">String</span> recipient, <span class="predefined-type">String</span> subject, <span class="predefined-type">String</span> message) {
      mail.send(recipient, subject, message);
   }
}</code></pre>
</div>
</div>

</div>
<div class="sect3">
<h4 id="_abstract_bean_binding"><a class="anchor" href="#_abstract_bean_binding"></a>Abstract bean binding</h4>
<div class="paragraph">
<p>Binding an abstract class or an interface type is also possible with the <code>implementation</code> member of the <code>@Binding</code>
annotation:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@Bindings</span>(<span class="annotation">@Binding</span>(value=Mailer.class,implementation=MailerImpl.class))
<span class="keyword">package</span> <span class="namespace">myapplication</span>;</code></pre>
</div>
</div>

</div>
<div class="sect3">
<h4 id="_binding_with_a_provider"><a class="anchor" href="#_binding_with_a_provider"></a>Binding with a provider</h4>
<div class="paragraph">
<p>Sometimes the implementation cannot be created by the IOC container, for instance it may not have a correct
constructor, it can only be retrieved using a factory or it should be configured before being used. For such scenarios
the implementation can specify a class implementing the <code>javax.inject.Provider</code> interface.</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="directive">public</span> <span class="type">class</span> <span class="class">ConfiguredMailerProvider</span> <span class="directive">implements</span> javax.inject.Provider&lt;Mailer&gt; {

   <span class="directive">private</span> <span class="predefined-type">String</span> email
   <span class="directive">private</span> <span class="predefined-type">String</span> password;

   <span class="directive">public</span> ConfiguredMailerProvider() {
      <span class="local-variable">this</span>.email = <span class="predefined-type">System</span>.getProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">mailer.email</span><span class="delimiter">&quot;</span></span>);
      <span class="local-variable">this</span>.password = <span class="predefined-type">System</span>.getProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">mailer.password</span><span class="delimiter">&quot;</span></span>);
   }

   <span class="directive">public</span> Mailer get() {
      <span class="keyword">return</span> <span class="keyword">new</span> MailerImpl(email, password);
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Thanks to the provider, we have a <code>Mailer</code> provider that returns a <code>MailerImpl</code> configured before usage.</p>
</div>

</div>
<div class="sect3">
<h4 id="_scoped_binding"><a class="anchor" href="#_scoped_binding"></a>Scoped binding</h4>
<div class="paragraph">
<p>The <code>@Binding</code> annotation provides room for declaring a bean scope:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@Bindings</span>(<span class="annotation">@Binding</span>(value=Mailer.class,scope=Scope.SINGLETON))</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the scope is not specified, the scope is determined from the bean or implementation that should be annotated
with a scope annotation. When it is specified, it overrides the annotation scope the bean could declare.</p>
</div>

</div>
<div class="sect3">
<h4 id="_qualifying_provider"><a class="anchor" href="#_qualifying_provider"></a>Qualifying provider</h4>
<div class="paragraph">
<p>A provider implementation can declare qualifiers on the <code>get</code> method they implement in order to set the qualifiers
of the returned bean:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="directive">public</span> <span class="type">class</span> <span class="class">MailerProvider</span> <span class="directive">implements</span> <span class="predefined-type">Provider</span>&lt;Mailer&gt; {
   <span class="annotation">@Named</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">mailer</span><span class="delimiter">&quot;</span></span>)
   <span class="directive">public</span> Mailer get() {
      <span class="keyword">return</span> <span class="keyword">new</span> MailerImpl();
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is useful for declaring qualifiers on a class that is not annotated by qualifiers, because it is not possible
to declare qualifiers in an <code>@Binding</code> annotation due to limitations of the Java language.</p>
</div>

</div>

</div>

</div>
</div>
<div class="sect1">
<h2 id="_provider_factories"><a class="anchor" href="#_provider_factories"></a>Provider factories</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Provider factories provides plugability for integrating beans that are not managed by the IOC container. The provider
factory is a factory for <code>javax.inject.Provider</code> whose purpose is to return a provider for a specific class. Usually
provider factories will lookup the service in a registry (like another IOC container) and returns a provider that
return them lazily or not.</p>
</div>
<div class="paragraph">
<p>The provider factory defines the <code>getProvider</code> method:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java">  <span class="comment">/**
   * Returns a provider for a specific type or null if it cannot be produced.
   *
   * @param implementationType the implementation class object
   * @param &lt;T&gt;                the implementation generic type
   * @return a provider for this class or null
   * @throws Exception any exception that would prevent to obtain the provider
   */</span>
  &lt;T&gt; <span class="predefined-type">Provider</span>&lt;? <span class="directive">extends</span> T&gt; getProvider(<span class="predefined-type">Class</span>&lt;T&gt; implementationType)
    <span class="directive">throws</span> <span class="exception">Exception</span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The factory implementation must provide a public zero argument constructor and it will be instantiated
during the application boostrap by Juzu to obtain the provider. The returned providers will then be bound into
the IOC container.</p>
</div>
<div class="paragraph">
<p>The IOC container uses the <code>java.util.ServiceLoader</code> discovery mechanism for finding provider factories when
 injection occurs.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s study a simple example with a provider for the current time:</p>
</div>
<div class="listingblock">
<div class="title">Time provider factory</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="keyword">package</span> <span class="namespace">my</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">TimeProviderFactory</span> <span class="directive">implements</span> java.inject.ProviderFactory {
  <span class="directive">public</span> &lt;T&gt; <span class="predefined-type">Provider</span>&lt;? <span class="directive">extends</span> T&gt; getProvider(<span class="directive">final</span> <span class="predefined-type">Class</span>&lt;T&gt; implementationType) <span class="directive">throws</span> <span class="exception">Exception</span> {
    <span class="keyword">if</span> (implementationType == java.util.Date.class) {
      <span class="keyword">return</span> <span class="keyword">new</span> <span class="predefined-type">Provider</span>&lt;T&gt;() {
        <span class="directive">public</span> T get() {
          <span class="keyword">return</span> implementationType.cast(<span class="keyword">new</span> java.util.Date());
        }
      };
    }
    <span class="keyword">else</span> {
      <span class="keyword">return</span> <span class="predefined-constant">null</span>;
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This provider should be declared in the <em>META-INF/services/juzu.inject.ProviderFactory</em> file:</p>
</div>
<div class="listingblock">
<div class="title">Time provider configuration</div>
<div class="content monospaced">
<pre>my.TimeProvider</pre>
</div>
</div>

</div>
</div>
<div class="sect1">
<h2 id="_provided_container"><a class="anchor" href="#_provided_container"></a>Provided container</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Sometimes a Juzu application needs to run with a provided container, i.e a container whose life cycle is not
managed by the framework, allowing Juzu to integratte with existing runtimes.</p>
</div>
<div class="sect2">
<h3 id="_provided_spring"><a class="anchor" href="#_provided_spring"></a>Provided Spring</h3>
<div class="paragraph">
<p>A Juzu application can reuse an existing container scoped to a web application. In this case Juzu will create its
own container with the provided container as parent, as a result, all beans available in the provided container
will be available in the Juzu application.</p>
</div>
<div class="paragraph">
<p>During the startup of the application, the web application attribute <code>org.springframework.web.context.WebApplicationContext.ROOT</code>
is looked up, this is the provided container when it is not null. Such container is usually created by a Spring servlet
or listener, for example:</p>
</div>
<div class="listingblock">
<div class="title">A Spring web application provided by a servlet context listener</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="xml language-xml">  ...
  <span class="tag">&lt;listener&gt;</span>
    <span class="tag">&lt;listener-class&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="tag">&lt;/listener-class&gt;</span>
  <span class="tag">&lt;/listener&gt;</span>
  ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This usually start the beans declared in the <em>/WEB-INF/applicationContext.xml</em>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">

when using a bean from a provided container, you should not declare it with the <code>@Binding</code> annotation or
the bean will be duplicated and you will use the wrong bean instance
</td>
</tr>
</table>
</div>

</div>
<div class="sect2">
<h3 id="_provided_cdi"><a class="anchor" href="#_provided_cdi"></a>Provided CDI</h3>
<div class="paragraph">
<p>todo</p>
</div>

</div>

</div>
</div>

<h1 id="templating" class="sect0"><a class="anchor" href="#templating"></a>Templating</h1>
<div class="paragraph">
<p>Templating is the <em>View</em> part of a Model View Controlle architecture. We will study in this chapter how
the templating system interacts with the Juzu, at compilation time and at runtime, both aspects are very
important.</p>
</div>
<div class="sect1">
<h2 id="_the_templating_engines"><a class="anchor" href="#_the_templating_engines"></a>The templating engines</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Juzu can use several templating engines, it provides a native template engine as well as the Mustache templating engine.
Those engines are not competing, instead they should be seen as alternatives: the native Groovy engine provides the
goodness of the Groovy languages, however sometimes some people prefer logic-less templates and
<a href="http://mustache.github.com/">Mustache</a> is a template engine they should use. Let&#8217;s introduce them briefly.</p>
</div>
<div class="sect2">
<h3 id="_the_native_template_engine"><a class="anchor" href="#_the_native_template_engine"></a>The native template engine</h3>
<div class="paragraph">
<p>The native template engine extends the <a href="http://groovy.codehaus.org/Groovy+Templates">Groovy templating system</a>:
it can include snippet of Groovy code or resolve Groovy expressions:</p>
</div>
<div class="sect3">
<h4 id="_expressions"><a class="anchor" href="#_expressions"></a>Expressions</h4>
<div class="paragraph">
<p>Expressions are simply Groovy expressions wrapped with the <code>${&#8230;}</code> syntax:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre>The sky is ${color}</pre>
</div>
</div>

</div>
<div class="sect3">
<h4 id="_scriplets"><a class="anchor" href="#_scriplets"></a>Scriplets</h4>
<div class="paragraph">
<p>Groovy code can also literaly be used with the <em>scriplet</em> syntax: <code>&lt;% &#8230; %&gt;</code>. Within a scriptlet the <code>out</code> implicit object
can be used for outputting markup:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre>&lt;ul&gt;
&lt;% ["red","green","blue"].each({ color -&gt; out.print("&lt;li&gt;The sky is " + color + "&lt;/li&gt;") }) %&gt;
&lt;/ul&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>The scriplet syntax <code>&lt;%= &#8230; %&gt;</code> can also be used:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre>The sky is &lt;%= color %&gt;</pre>
</div>
</div>

</div>
<div class="sect3">
<h4 id="_controller_urls"><a class="anchor" href="#_controller_urls"></a>Controller urls</h4>
<div class="paragraph">
<p>Controller urls is natively supported by the engine, it allows to create controller URL with a short and compact syntax
<code>@{&#8230;}</code>:</p>
</div>
<div class="listingblock">
<div class="title">Controller URL syntax</div>
<div class="content monospaced">
<pre>&lt;a href="@{index()}"&gt;Home&lt;/a&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>URL expressions can contain parameters and they must be named:</p>
</div>
<div class="listingblock">
<div class="title">Controller URL with parameters</div>
<div class="content monospaced">
<pre>&lt;a href="@{purchase(product=1)}"&gt;Purchase&lt;/a&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>The <em>purchase</em> method refers to a controller method, when the application has several controllers, the controller name
can be used to prefix the url expression and remove the ambiguity:</p>
</div>
<div class="listingblock">
<div class="title">Explicit controller URL</div>
<div class="content monospaced">
<pre>&lt;a href="@{Controller.purchase(product=1)}"&gt;Purchase&lt;/a&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Under the hood the controller URL syntax uses the controller compagnion for creating the URL: the <code>Controller.purchase(product=1)</code>
will uses the controller compagnion <code>Controller_#purchase(String product)</code>.</p>
</div>

</div>
<div class="sect3">
<h4 id="_messages"><a class="anchor" href="#_messages"></a>Messages</h4>
<div class="paragraph">
<p>You can resolve a message in resource bundles in a template with the <code>&amp;{&#8230;}</code> syntax:</p>
</div>
<div class="listingblock">
<div class="title">Message syntax</div>
<div class="content monospaced">
<pre>&lt;label&gt;&amp;{color}&lt;/label&gt;
&lt;input type="text" name="color"&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>When the message is not found, no output will be done. The resource bundle is resolved with
the current user locale.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="icon-warning" title="Warning"></i>
</td>
<td class="content">

This feature at the moment only works with portlets that supports resource bundle
declaration natively
</td>
</tr>
</table>
</div>

</div>
<div class="sect3">
<h4 id="_taglib"><a class="anchor" href="#_taglib"></a>Taglib</h4>
<div class="paragraph">
<p></p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre>#{title value=Hello/}</pre>
</div>
</div>
<div class="paragraph">
<p>Available tags are explained in the <a href="#taglib">Taglib</a>.</p>
</div>

</div>

</div>
<div class="sect2">
<h3 id="_the_mustache_template_engine"><a class="anchor" href="#_the_mustache_template_engine"></a>The Mustache template engine</h3>
<div class="paragraph">
<p>The Mustache template engine uses <em>logic-less</em> templates based on <a href="https://github.com/spullara/mustache.java">Mustache.java&gt;</a>
the Java port of Mustache. Mustache is very easy to use, you can read the <a href="http://mustache.github.com/mustache.5.html">documentation</a>,
however we will have a quick overview of how it can be used in Juzu:</p>
</div>
<div class="sect3">
<h4 id="_variables"><a class="anchor" href="#_variables"></a>Variables</h4>
<div class="paragraph">
<p>Variables uses the <code>{{&#8230;}}</code> syntax, they are resolved against template parameters or beans.</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre>The sky is {{color}}</pre>
</div>
</div>

</div>
<div class="sect3">
<h4 id="_sections"><a class="anchor" href="#_sections"></a>Sections</h4>
<div class="paragraph">
<p>Mustache sections allows to iterate expressions that are multivalued.</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre>todo</pre>
</div>
</div>

</div>

</div>

</div>
</div>
<div class="sect1">
<h2 id="_using_templates"><a class="anchor" href="#_using_templates"></a>Using templates</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A template as seen by an application is a bean managed by the IOC container.</p>
</div>
<div class="sect2">
<h3 id="_template_declaration"><a class="anchor" href="#_template_declaration"></a>Template declaration</h3>
<div class="paragraph">
<p>Applications use a template by injecting a <code>juzu.template.Template</code> object in its controllers qualified by the
<code>juzu.Path</code> annotation:</p>
</div>
<div class="listingblock">
<div class="title">Using a template</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Controller</span> {

  <span class="annotation">@Inject</span>
  <span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">index.gtmpl</span><span class="delimiter">&quot;</span></span>) <span class="comment">// <i class="conum">1</i></span>
  Template index;

  <span class="annotation">@View</span>
  <span class="directive">public</span> Response.Content index() {
    index.ok(); <span class="comment">// <i class="conum">2</i></span>
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">

<table>
<tr>
<td><i class="conum">1</i></td>
<td>Declares the template path</td>
</tr>
<tr>
<td><i class="conum">2</i></td>
<td>Returns a content response from the template</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>@Path</code> declares the template to use, the value is usually a path relative to the <code>templates</code> package. The value
can also be absolute like <code>/my/application/templates/index.gtmpl</code>.</p>
</div>
<div class="paragraph">
<p>The <code>@Inject</code> annotation instructs the injection container the inject the template at runtime, so it can be used
by the controller.</p>
</div>
<div class="paragraph">
<p>The <code>render</code> method of a template returns a <code>juzu.Response.Content</code> response which can also be returned
by the controller method.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">

The <code>juzu.Path</code> annotation is a qualifier annotation managed by the IOC container. It is very much like the
<code>@javax.inject.Named</code> qualifier, but it has a special meaning for Juzu for processing the template.
</td>
</tr>
</table>
</div>

</div>
<div class="sect2">
<h3 id="_template_reuse"><a class="anchor" href="#_template_reuse"></a>Template reuse</h3>
<div class="paragraph">
<p>Template can be shared between applications: one application can reuse the templates of another application
by using an absolute path value instead of a relative path value:</p>
</div>
<div class="listingblock">
<div class="title">Reusing a template</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@Inject</span>
<span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/my/other/application/templates/index.gtmpl</span><span class="delimiter">&quot;</span></span>)
Template index;</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are a few things to keep in mind when using external templates:</p>
</div>
<div class="ulist">

<ul>
<li>
<p>templates will not be compiled by the current application.</p>
</li>
<li>
<p>relative templates references (such as inclusion) are relative to the initial compilation directory, so don&#8217;t expect
this behavior to be dynamic (since it would break compile time safety).</p>
</li>
</ul>
</div>

</div>
<div class="sect2">
<h3 id="_type_safe_parameters"><a class="anchor" href="#_type_safe_parameters"></a>Type safe parameters</h3>
<div class="paragraph">
<p>Template type safe parameters brings more type safety in your applications. Templates can declare parameters and they
are made available on a subclass of the <code>juzu.template.Template</code> class.</p>
</div>
<div class="paragraph">
<p>Parameters are declared using the taglib support of the native template engine</p>
</div>
<div class="listingblock">
<div class="title">Native template parameter declaration</div>
<div class="content monospaced">
<pre>#{param name=color/}
The sky is ${color}.</pre>
</div>
</div>
<div class="paragraph">
<p>or the pragma support of the Mustache engine</p>
</div>
<div class="listingblock">
<div class="title">Mustache template parameter declaration</div>
<div class="content monospaced">
<pre>{{%param color}}
The sky is {{color}}.</pre>
</div>
</div>
<div class="paragraph">
<p>When the template is declared in a controller, a subclass of <code>juzu.template.Template</code> can be used:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="keyword">package</span> <span class="namespace">weather</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">Controller</span> {

  <span class="annotation">@Inject</span>
  <span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">sky.gtmpl</span><span class="delimiter">&quot;</span></span>)
  weather.templates.sky sky; <span class="comment">// <i class="conum">1</i></span>

  <span class="annotation">@View</span>
  <span class="directive">public</span> Response.Content index() {
    sky.with().color(<span class="string"><span class="delimiter">&quot;</span><span class="content">blue</span><span class="delimiter">&quot;</span></span>).ok(); <span class="comment">// <i class="conum">2</i></span>
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">

<table>
<tr>
<td><i class="conum">1</i></td>
<td>The <code>weather.templates.sky</code> typed template class</td>
</tr>
<tr>
<td><i class="conum">2</i></td>
<td>Use the <code>sky</code> template <code>color</code> parameter</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>weather.templates.sky</code> class does not exist in the original source but it is available when the application
is compiled because it will be generated by Juzu compiler integration. The <code>sky</code> templates provides a <em>fluent</em>
syntax to bind parameters: <code>sky.with().color("blue").ok()</code>.</p>
</div>

</div>
<div class="sect2">
<h3 id="_expression_resolution"><a class="anchor" href="#_expression_resolution"></a>Expression resolution</h3>
<div class="paragraph">
<p>When we studied the templating engine syntax but we did not mentioned exactly how expression are resolved.</p>
</div>
<div class="sect3">
<h4 id="_single_name_expressions"><a class="anchor" href="#_single_name_expressions"></a>Single name expressions</h4>
<div class="paragraph">
<p>Both templating system provides a syntax for resolving single name expressions:</p>
</div>
<div class="ulist">

<ul>
<li>
<p><code>${&#8230;}</code> for Groovy</p>
</li>
<li>
<p><code>{{&#8230;}}</code> for Mustache</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Resolution is performed against template parameters or bean named with the <code>javax.inject.Named</code> qualifier.</p>
</div>
<div class="listingblock">
<div class="title">Named bean</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@javax</span>.inject.Named(<span class="string"><span class="delimiter">&quot;</span><span class="content">color</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Color</span> {
  <span class="directive">public</span> <span class="predefined-type">String</span> toString() {
    <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">red</span><span class="delimiter">&quot;</span></span>;
  }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Template parameters</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java">index.with().set(<span class="string"><span class="delimiter">&quot;</span><span class="content">color</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">red</span><span class="delimiter">&quot;</span></span>).ok(); <span class="comment">// <i class="conum">1</i></span>
index.with().color(<span class="string"><span class="delimiter">&quot;</span><span class="content">red</span><span class="delimiter">&quot;</span></span>).ok(); <span class="comment">// <i class="conum">2</i></span></code></pre>
</div>
</div>
<div class="colist arabic">

<table>
<tr>
<td><i class="conum">1</i></td>
<td>Detyped version</td>
</tr>
<tr>
<td><i class="conum">2</i></td>
<td>Type safe version</td>
</tr>
</table>
</div>

</div>
<div class="sect3">
<h4 id="_compound_expressions"><a class="anchor" href="#_compound_expressions"></a>Compound expressions</h4>
<div class="paragraph">
<p>Compound expressions are resolved the same way for the first name and the expression resolve will attempt to
navigate the rest of the expressions from this object:</p>
</div>
<div class="ulist">

<ul>
<li>
<p><code>${weather.color}</code> for Groovy</p>
</li>
<li>
<p><code>{{#weather}}{{color}}{{/weather}}</code> for Mustache</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Named bean</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@javax</span>.inject.Named(<span class="string"><span class="delimiter">&quot;</span><span class="content">weather</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Weather</span> {

  <span class="directive">private</span> <span class="predefined-type">String</span> color;

  <span class="directive">public</span> Weather(<span class="predefined-type">String</span> color) {
    <span class="local-variable">this</span>.color = color;
  }

  <span class="directive">public</span> Weather() {
    <span class="local-variable">this</span>.color = <span class="string"><span class="delimiter">&quot;</span><span class="content">red</span><span class="delimiter">&quot;</span></span>;
  }

  <span class="directive">public</span> <span class="predefined-type">String</span> getColor() {
    <span class="keyword">return</span> color;
  }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Template parameters</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java">index.with().set(<span class="string"><span class="delimiter">&quot;</span><span class="content">weather</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> Weather(<span class="string"><span class="delimiter">&quot;</span><span class="content">blue</span><span class="delimiter">&quot;</span></span>)).ok(); <span class="comment">// <i class="conum">1</i></span>
index.with().color(<span class="keyword">new</span> Weather(<span class="string"><span class="delimiter">&quot;</span><span class="content">blue</span><span class="delimiter">&quot;</span></span>)).ok(); <span class="comment">// <i class="conum">2</i></span></code></pre>
</div>
</div>
<div class="colist arabic">

<table>
<tr>
<td><i class="conum">1</i></td>
<td>Detyped version</td>
</tr>
<tr>
<td><i class="conum">2</i></td>
<td>Type safe version</td>
</tr>
</table>
</div>

</div>

</div>

</div>
</div>

<h1 id="taglib" class="sect0"><a class="anchor" href="#taglib"></a>Taglib</h1>
<div class="paragraph">
<p>A tag library is an essential component of a templating system, allowing to enrich a templating by encapsulating reusable programmable
logic.</p>
</div>
<div class="sect1">
<h2 id="_taglib_syntax"><a class="anchor" href="#_taglib_syntax"></a>Taglib syntax</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Like most taglib syntaxes, Juzu provides two syntaxes for invoking a tag:</p>
</div>
<div class="listingblock">
<div class="title">Start and end tag syntax</div>
<div class="content monospaced">
<pre>#{foo}bar#{/foo}</pre>
</div>
</div>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>A tag can also be empty:</p>
</div>
<div class="listingblock">
<div class="title">Empty tag syntax</div>
<div class="content monospaced">
<pre>#{foo/}</pre>
</div>
</div>
<div class="paragraph">
<p>A tag can also be invoked empty with the <code>#{foo/}</code> syntax.</p>
</div>

</div>
</div>
<div class="sect1">
<h2 id="_include_tag"><a class="anchor" href="#_include_tag"></a>Include tag</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <em>include</em> tag simply includes a template inside the current template. The inclusion is dynamic and not static, meaning
 that the content of the included template is not <em>inserted</em> in the calling template, instead when inclusion is performed
 the control is passed to the included template.</p>
</div>
<div class="listingblock">
<div class="title">The include tag</div>
<div class="content monospaced">
<pre>#{include path=dispatched.gtmpl/}</pre>
</div>
</div>
<div class="paragraph">
<p>The <em>path</em> attribute determines the template to include, the path value is relative to the templates package.</p>
</div>

</div>
</div>
<div class="sect1">
<h2 id="_decorate_insert_tag"><a class="anchor" href="#_decorate_insert_tag"></a>Decorate / Insert tag</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <em>decorate</em> tag allows the content of the decorating template to wrap the content of the template invoking the tag.
 The <em>insert</em> tag should be used in the decorating template to specify the place where to insert the markup produced
 by the template to decorate.</p>
</div>
<div class="listingblock">
<div class="title">The wrapped template</div>
<div class="content monospaced">
<pre>#{decorate path=box.gtmpl/}</pre>
</div>
</div>
<div class="listingblock">
<div class="title">The decoraring template</div>
<div class="content monospaced">
<pre>&lt;div style="border: 1px solid black"&gt;
#{insert/}
&lt;/div&gt;</pre>
</div>
</div>

</div>
</div>
<div class="sect1">
<h2 id="_title_tag"><a class="anchor" href="#_title_tag"></a>Title tag</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <em>title</em> tag specifies a title to insert in the <code>juzu.Response.Content</code> object the template will produce.</p>
</div>
<div class="listingblock">
<div class="title">Setting the title</div>
<div class="content monospaced">
<pre>#{title value=Home/}</pre>
</div>
</div>

</div>
</div>
<div class="sect1">
<h2 id="_param_tag"><a class="anchor" href="#_param_tag"></a>Param tag</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <em>param</em> tag enhances the type safety of templates, allowing to declare parameters for executing a template. When
such a parameter is declared, the generated template class companion will have a fluent parameter for setting the
value of the parameter:</p>
</div>
<div class="listingblock">
<div class="title">Declaring a template parameter</div>
<div class="content monospaced">
<pre>#{param name=color/}</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Using the template parameter</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@Inject</span> my.templates.index index;

<span class="annotation">@View</span>
<span class="directive">public</span> Content.Response index() {
  <span class="keyword">return</span> index.with().color(<span class="string"><span class="delimiter">&quot;</span><span class="content">red</span><span class="delimiter">&quot;</span></span>).ok();
}</code></pre>
</div>
</div>

</div>
</div>
<div class="sect1">
<h2 id="_custom_tags"><a class="anchor" href="#_custom_tags"></a>Custom tags</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Since Juzu 0.7.0, custom tags can be implemented, either as Java class or as templates, we will study both ways in this section.</p>
</div>
<div class="sect2">
<h3 id="_simple_tags"><a class="anchor" href="#_simple_tags"></a>Simple tags</h3>
<div class="paragraph">
<p>Simple tags allow creation of custom tags with templates located in the <code>tags</code> package of your application.</p>
</div>
<div class="listingblock">
<div class="title">Our simple tag</div>
<div class="content monospaced">
<pre class="CodeRay"><code>My simple tag</code></pre>
</div>
</div>
<div class="paragraph">
<p>Put this content in the <em>tags/mytag.gtmpl</em> file of the application.</p>
</div>
<div class="paragraph">
<p>Obviously Juzu needs to be aware of the existence of this tag, this is achieved using the <code>@Tag</code>/<code>@Tags</code> annotations:</p>
</div>
<div class="listingblock">
<div class="title">Declaring our simple tag</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@Application</span>
<span class="annotation">@Tags</span>(<span class="annotation">@Tag</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">mytag</span><span class="delimiter">&quot;</span></span>, path = <span class="string"><span class="delimiter">&quot;</span><span class="content">mytag.gtmpl</span><span class="delimiter">&quot;</span></span>))
<span class="keyword">package</span> <span class="namespace">my.application</span>;

<span class="keyword">import</span> <span class="include">juzu.Application</span>;
<span class="keyword">import</span> <span class="include">juzu.template.Tags</span>;
<span class="keyword">import</span> <span class="include">juzu.template.Tag</span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Simple tags are templates so most of the tag syntax applies here, however there are a few differences between application
templates and simple tags:</p>
</div>
<div class="ulist">

<ul>
<li>
<p>Simple tags are in the <em>tags</em> package instead of the <em>templates</em> package</p>
</li>
<li>
<p>Simple tags cannot reference other templates, the tag syntax must be used instead</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_simple_tag_parameters"><a class="anchor" href="#_simple_tag_parameters"></a>Simple tag parameters</h4>
<div class="paragraph">
<p>Simple tags can have parameters, to access them use the implicit <code>parameters</code> map property in the tag template.</p>
</div>
<div class="listingblock">
<div class="title">Accessing the simple tag parameters</div>
<div class="content monospaced">
<pre class="CodeRay"><code>Hello ${parameters.name}</code></pre>
</div>
</div>

</div>
<div class="sect3">
<h4 id="_simple_tag_body"><a class="anchor" href="#_simple_tag_body"></a>Simple tag body</h4>
<div class="paragraph">
<p>Simple tags can have a body that can be evaluated within the tag body using the <code>insert</code> tag (this tag is also be used
by the <code>decorate</code> tag).</p>
</div>
<div class="listingblock">
<div class="title">Evaluating the simple tag body</div>
<div class="content monospaced">
<pre class="CodeRay"><code>&lt;foo&gt;#{insert/}&lt;/foo&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The body can be evaluated as much as you want, allowing to create loop tags.</p>
</div>

</div>

</div>
<div class="sect2">
<h3 id="_java_tags"><a class="anchor" href="#_java_tags"></a>Java tags</h3>
<div class="paragraph">
<p>Tags can also be implemented with Java code, let&#8217;s look at the actual implementation of the <em>title</em> tag:</p>
</div>
<div class="listingblock">
<div class="title">The title tag implementation</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="directive">public</span> <span class="type">class</span> <span class="class">TitleTag</span> <span class="directive">extends</span> TagHandler {

  <span class="directive">public</span> TitleTag() {
    <span class="local-variable">super</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>);
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">void</span> render(TemplateRenderContext context, Renderable body, <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; args) <span class="directive">throws</span> <span class="exception">IOException</span> {
    <span class="predefined-type">String</span> title = args.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>);

    <span class="comment">//</span>
    <span class="keyword">if</span> (title != <span class="predefined-constant">null</span>) {
      context.setTitle(title);
    }

    <span class="comment">//</span>
    body.render(context);
  }
}</code></pre>
</div>
</div>
<div class="ulist">

<ul>
<li>
<p>The class extends the <code>juzu.template.TagHandler</code> abstract class</p>
</li>
<li>
<p>The constructor must provide the tag name to the <code>TagHandler</code> super constructor</p>
</li>
<li>
<p>The tag is rendered with the <code>render</code> method</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Finally the tag must be declared as a <a href="http://docs.oracle.com/javase/6/docs/technotes/guides/jar/jar.html#Service%20Provider">Java Service Provider API</a> which is achieved by having the following content in the
<em>META-INF/services/juzu.template.TagHandler</em> file:</p>
</div>
<div class="listingblock">
<div class="title">The tag declaration</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java">juzu.impl.tags.TitleTag <span class="error">#</span> the tag service provider</code></pre>
</div>
</div>

</div>

</div>
</div>

<h1 id="templatespi" class="sect0"><a class="anchor" href="#templatespi"></a>Templating SPI</h1>
<div class="paragraph">
<p>This chapter dives into the template life cycle from the compilation time to the run time. We will describe the
template Service Provider Interface (SPI), the SPI is designed to make Juzu templating extensible and integrating
template engines in Juzu. This chapter is optional is you are only writing ab application with Juzu, however it is
a must read if you want to know more Juzu internals or if you want to understand how to integrate a
template engine in Juzu.</p>
</div>
<div class="paragraph">
<p>When a Juzu application is compiled, the Juzu annotation processor detects the <code>@Path</code> annotations and triggers
the compilation of the related templates. The template compilation can be split in two parts:</p>
</div>
<div class="ulist">

<ul>
<li>
<p>Generating the template companion class that inherits the <code>juzu.template.Template</code> class. This part is generic
and works with any templating system, it is entirely managed by Juzu.</p>
</li>
<li>
<p>Processing the template file, this task is delegated to the <code>TemplateProvider</code> interface and is extensible.
The provider allows to have several templating system in Juzu and decouples the template compilation process
from the details of the templating engine.</p>
</li>
</ul>
</div>
<div class="sect1">
<h2 id="_compiling_a_groovy_template"><a class="anchor" href="#_compiling_a_groovy_template"></a>Compiling a Groovy template</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s study an example with the Groovy template at compilation time.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/templatespi/lifecycle1.png" alt="Life cycle" width="700">
</div>
<div class="title">Figure 6. Compiling a Groovy template</div>
</div>
<div class="paragraph">
<p>When the Java compiler is invoked, the following steps are executed</p>
</div>
<div class="olist arabic">

<ol class="arabic">
<li>
<p>The Java compiler triggers the Juzu annotation processor when it finds the <code>@Path</code> annotation</p>
</li>
<li>
<p>Juzu resolves the relative path to the <code>templates</code> package of the application</p>
<div class="olist loweralpha">

<ol class="loweralpha" type="a">
<li>
<p>When the template cannot be resolved a compilation error is triggered</p>
</li>
<li>
<p>Otherwise the template is loaded</p>
</li>
</ol>
</div>

</li>
<li>
<p>The template provider is looked up according to the file name extension, it generates the <em>index</em>.groovy_ source file</p>
</li>
<li>
<p>Juzu creates the <code>index</code> class that extends the <code>juzu.template.Template</code> class annotated by the <code>@Path("index.gtmpl")</code> annotation</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>After that the only remaining part is to compile the <em>index</em>.groovy_ source to a class. It can be achieved either at build time
using the <em>groovyc</em> compiler or at load time when the <code>index</code> template is loaded using a <code>GroovyClassLoader</code>. The former
approach makes the build a bit more complex (but not much as Groovy compilation is fairly well supported in build systems or IDEs)
as it requires to run a Groovy compilation but it will perform additional validation of the template as well as reduce the load
time of the template. The later approach will detect any compilation error (such as Groovy syntax error) at runtime
and the <em>index</em>.groovy_ compilation will take a few milliseconds.</p>
</div>
<div class="paragraph">
<p>This flexibility allows to use the lazy approach during development and when the application is released then the Groovy compiler
can be used to compile the <em>index</em>.groovy_.</p>
</div>

</div>
</div>
<div class="sect1">
<h2 id="_type_safe_url_resolution"><a class="anchor" href="#_type_safe_url_resolution"></a>Type safe URL resolution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Groovy templates provides the <code>@{&#8230;}</code> syntax for generating URL from the application controllers. This section gives
an overview of the underlying resolution mechanism.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/templatespi/lifecycle2.png" alt="URL resolution" width="750">
</div>
<div class="title">Figure 7. Template URL resolution during compilation</div>
</div>
<div class="ulist">

<ul>
<li>
<p>Parse: the template is parsed into its model representation</p>
</li>
<li>
<p>Resolve: the <code>index</code> link is resolved againt the controller meta model</p>
</li>
<li>
<p>Validate: the <code>index</code> link is validated</p>
</li>
<li>
<p>Emit: the corresponding <em>index</em>.groovy_ file is emitted and save on the class output</p>
</li>
<li>
<p>Compile: the Groovy source is compiled into a class by the <em>groovyc</em> compiler (this part is done after <em>javac</em>)</p>
</li>
</ul>
</div>

</div>
</div>
<div class="sect1">
<h2 id="_template_service_provider_interface"><a class="anchor" href="#_template_service_provider_interface"></a>Template Service Provider Interface</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Juzu provides a Service Provider Interface (SPI) for integrating thirdparty template engine. Actually all template
system are integrated with the SPI. We will study briefly the integration points so you can integrate a template engine
of your choice in Juzu.</p>
</div>
<div class="sect2">
<h3 id="_template_providers"><a class="anchor" href="#_template_providers"></a>Template providers</h3>
<div class="paragraph">
<p>The <code>juzu.impl.template.spi.TemplateProvider</code> is the main entry point when a templating system is integrated. The
provider is triggered during the compilation phase by the APT system built into the Java compiler.</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">TemplateProvider</span>&lt;M <span class="directive">extends</span> <span class="predefined-type">Serializable</span>&gt; {
  ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The provider must declare the template model <code>&lt;M&gt;</code> generic type, this type must be a serializable as Juzu will sometimes
write template models on the disk during the compilation. This usually happens only in Eclipse due its incremental
compiler architecture. The type specified by the provider is privately managed (i.e it is opaque for Juzu) and it
symbolizes an internal representation of the parsed source (usually an Abstract Syntax Tree), it will be used in
various methods of the provider.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s have a review of the methods of this class to have a better understanding.</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java">  <span class="comment">/**
   * Returns the template source extension without the dot recognised by
   * this provider. For instance it should return &lt;code&gt;gtmpl&lt;/code&gt;
   * for groovy templates.
   *
   * @return the source extension
   */</span>
  <span class="directive">public</span> <span class="directive">abstract</span> <span class="predefined-type">String</span> getSourceExtension();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>getSourceExtension()</code> method is used to determine what file extension the provider can compile. The implementation
 should return a constant value, for instance the Groovy provide simply returns the <code>gtmpl</code> value.</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java">  <span class="comment">/**
   * Parse the provided char sequence and return the corresponding template model.
   *
   * @param context the parse context
   * @param source the source to parse
   * @return the corresponding template model
   * @throws TemplateException any template related exception
   */</span>
  <span class="directive">public</span> <span class="directive">abstract</span> M parse(
      ParseContext context,
      <span class="predefined-type">CharSequence</span> source) <span class="directive">throws</span> TemplateException;

  <span class="comment">/**
   * Process the template.
   *
   * @param context the process context
   * @param template  the template to process
   * @throws TemplateException any template related exception
   */</span>
  <span class="directive">public</span> <span class="directive">abstract</span> <span class="type">void</span> process(
      ProcessContext context,
      Template&lt;M&gt; template) <span class="directive">throws</span> TemplateException;

  <span class="comment">/**
   * Provide an opportunity for emitting a file on the disk.
   *
   * @param context the emit context
   * @param template the template
   * @throws TemplateException any template related exception
   * @throws IOException any io exception
   */</span>
  <span class="directive">public</span> <span class="directive">abstract</span> <span class="type">void</span> emit(
      EmitContext context,
      Template&lt;M&gt; template) <span class="directive">throws</span> TemplateException, <span class="exception">IOException</span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>parse</code>, <code>process</code> and <code>emit</code> methods care about transforming the template source to its final representation:
the compiled template.</p>
</div>
<div class="ulist">

<ul>
<li>
<p>The <code>parse</code> method is invoked with the content of the template and returns a template model. The representation returned
by the parse method is a parsed representation of the template source. If a parsing error occurs the method can throw
a <code>TemplateException</code>.</p>
</li>
<li>
<p>The <code>process</code> method is invoked after the template is parsed with the necessary context for performing further
processing of the template, for instance the Groovy templating engine performs the resolution of type safe URLs or type
safe parameters declaration at this moment. During the process:</p>
<div class="ulist">

<ul>
<li>
<p>The provider can resolve other templates using the <code>ProcessContext</code>, if the template to resolve is not
yet loaded it will trigger the <code>parse</code>/<code>process</code>/<code>emit</code> lifecycle, it if was already processed the template
is simply returned</p>
</li>
<li>
<p>The implementation can resolve controller methods and translate them into method invocation, this is used for
checking type safe URL and translating them into controller companion invocation</p>
</li>
<li>
<p>The <code>juzu.impl.template.spi.Template</code> argument represents the template, it has several fields such as the template
model or the template path</p>
</li>
<li>
<p>The implementation can declare type safe parameters using the <code>Template#addParameter(String)</code> method. The declared
parameters will be generated on the <code>juzu.template.Template</code> subclass</p>
</li>
</ul>
</div>

</li>
<li>
<p>The <code>emit</code> method is invoked when the template processing is over. The <code>EmitContext</code> interface can be used
to create resources during this round.</p>
</li>
</ul>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java">  <span class="comment">/**
   * Return the template stub type.
   *
   * @return the template stub class
   */</span>
  <span class="directive">public</span> <span class="directive">abstract</span> <span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> TemplateStub&gt; getTemplateStubType();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally the <code>getTemplateStubType()</code> returns the type of a java class that will be used for creating a template stub.
For each template, a stub is created, the stub is responsible for loading the template at runtime, i.e the original
template or the compiled template that may have been generated during compilation during the <code>emit</code> callback.</p>
</div>

</div>
<div class="sect2">
<h3 id="_template_stub"><a class="anchor" href="#_template_stub"></a>Template stub</h3>
<div class="paragraph">
<p>Template stubs are java classes created by Juzu for managing a template at runtime on behalf of the provider.
Each provider provides its own stub implementation as a <code>juzu.impl.template.spi.TemplateStub</code> subclass.</p>
</div>
<div class="paragraph">
<p>A stub must provide a public constructor accepting a <code>java.lang.String</code> argument: the template id. The template
 id if the class name of the generated template. In addition, a stub must implement two abstract methods:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java">  <span class="comment">/**
   * Init the template with the associated resource.
   *
   * @param loader   the class loader
   */</span>
  <span class="directive">protected</span> <span class="directive">abstract</span> <span class="type">void</span> doInit(<span class="predefined-type">ClassLoader</span> loader);

  <span class="comment">/**
   * Performs template rendering.
   *
   * @param renderContext the render context
   * @throws TemplateExecutionException any execution exception
   * @throws IOException any io exception
   */</span>
  <span class="directive">protected</span> <span class="directive">abstract</span> <span class="type">void</span> doRender(TemplateRenderContext renderContext)
      <span class="directive">throws</span> TemplateExecutionException, <span class="exception">IOException</span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>doInit</code> method loads the template using the provided <code>ClassLoader</code>, it will be call only once before the
template is rendered. Usually it uses the template id provided during the construction of the template to
locate the template on the disk, in its original form or in its compiled form.</p>
</div>
<div class="paragraph">
<p>The <code>doRender</code> method renders the template using the provided <code>TemplateRenderContext</code>. The render context
provides the necessary hooks such as:</p>
</div>
<div class="ulist">

<ul>
<li>
<p>Producing markup</p>
</li>
<li>
<p>Setting the title</p>
</li>
<li>
<p>Obtaining the locale</p>
</li>
<li>
<p>Accessing parameters or application beans for resolving expressions</p>
</li>
</ul>
</div>

</div>

</div>
</div>
<div class="sect1">
<h2 id="_template_at_work"><a class="anchor" href="#_template_at_work"></a>Template at work</h2>
<div class="sectionbody">
<div class="paragraph">
<p>After having described the various pieces of the templating SPI, let&#8217;s look at how the template generated stubs
 are used by Juzu templating system at runtime.</p>
</div>
<div class="paragraph">
<p>When the controller declares the <em>index.gtmpl</em> template the compiler produces three artifacts
* the <code>index</code> class template inherits <code>juzu.template.Template</code>: it is the only class visible from the
controller and the whole application
* the <em>index</em>.groovy_ Groovy template is the effective template code: it produces the markup, resolve expressions, etc&#8230;</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/request/interaction3.png" alt="At work" width="250">
</div>
<div class="title">Figure 8. index groovy at work</div>
</div>
<div class="paragraph">
<p>When a controller is instantiated, the <code>index</code> template instance is injected into the controller, the <code>@Path</code> annotation
plays an essential role because it&#8217;s a qualifier and that qualifier is used to distinguish the correct subclass to inject
in the controller.</p>
</div>
<div class="paragraph">
<p>When the template is created, the corresponding template stub is instantiated. When the template needs to be
rendered, the <code>doInit(ClassLoader)</code> method of the stub is invoked. At this moment the Groovy <code>index_</code> class is
loaded from the  class loader, when the class is not found, the <em>index</em>.groovy_ is loaded and it is compiled
on the fly.</p>
</div>

</div>
</div>
<div class="sect1">
<h2 id="_qualified_template_class"><a class="anchor" href="#_qualified_template_class"></a>Qualified template class</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Controller can be injected with the <code>juzu.template.Template</code> class, however they can also be injected with
the template subclass that was genereted by Juzu: instead of using the qualified template injection,
the controller declares the template <em>index</em> subclass. This approach cab be used when type safe parameters
are used as only the <code>index</code> type declares the fluent API.</p>
</div>
<div class="paragraph">
<p>For instance if the <em>index.gtmpl</em> declares the <em>color</em> parameter the <code>index</code> class will look like:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">index.gtmpl</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">index</span> <span class="directive">extends</span> Template {

  ...

  public index with() {
    <span class="keyword">return</span> <span class="keyword">new</span> index.Builder();
  }

  <span class="directive">public</span> <span class="type">class</span> <span class="class">Builder</span> <span class="directive">extends</span> Template.Builder {

    <span class="directive">public</span> Builder color(<span class="predefined-type">String</span> color) {
      <span class="comment">// Generated code</span>
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The controller can then use the fluent API:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Controller</span> {

  <span class="annotation">@Inject</span>
  <span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">index.gtmpl</span><span class="delimiter">&quot;</span></span>)
  Template index;

  <span class="annotation">@View</span>
  <span class="directive">public</span> Response.Content index() {
    <span class="keyword">return</span> index.with().color(<span class="string"><span class="delimiter">&quot;</span><span class="content">red</span><span class="delimiter">&quot;</span></span>).ok();
  }
}</code></pre>
</div>
</div>

</div>
</div>

<h1 id="assets" class="sect0"><a class="anchor" href="#assets"></a>Assets</h1>
<div class="paragraph">
<p>Web assets are resources used over the web such as stylesheet and script files. Using an asset is done in two steps:</p>
</div>
<div class="ulist">

<ul>
<li>
<p>declare the asset</p>
</li>
<li>
<p>serve the asset</p>
</li>
</ul>
</div>
<div class="sect1">
<h2 id="_asset_plugin"><a class="anchor" href="#_asset_plugin"></a>Asset plugin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The asset plugin provides declarative asset configuration. The <code>@Assets</code> annotation declares a list of assets used by
the an application.</p>
</div>
<div class="listingblock">
<div class="title">jQuery UI declarative asset configuration</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@Assets</span>({
  <span class="annotation">@Asset</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">jquery</span><span class="delimiter">&quot;</span></span>, value = <span class="string"><span class="delimiter">&quot;</span><span class="content">javascripts/jquery-1.7.1.min.js</span><span class="delimiter">&quot;</span></span>), <span class="comment">// <i class="conum">1</i></span>
  <span class="annotation">@Asset</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">jquery-ui.css</span><span class="delimiter">&quot;</span></span>, value = <span class="string"><span class="delimiter">&quot;</span><span class="content">ui-lightness/jquery-ui-1.7.2.custom.css</span><span class="delimiter">&quot;</span></span>), <span class="comment">// <i class="conum">2</i></span>
  <span class="annotation">@Asset</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">javascripts/jquery-ui-1.7.2.custom.min.js</span><span class="delimiter">&quot;</span></span>, <span class="comment">// <i class="conum">3</i></span>
         depends = {<span class="string"><span class="delimiter">&quot;</span><span class="content">jquery</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">jquery-ui.css</span><span class="delimiter">&quot;</span></span>}) <span class="comment">// <i class="conum">4</i></span>
  }}
)
<span class="keyword">package</span> <span class="namespace">my.application</span>;</code></pre>
</div>
</div>
<div class="colist arabic">

<table>
<tr>
<td><i class="conum">1</i></td>
<td>Declares the <em>jQuery</em> asset</td>
</tr>
<tr>
<td><i class="conum">2</i></td>
<td>Declare the <em>jQuery-UI</em> stylesheet asset</td>
</tr>
<tr>
<td><i class="conum">3</i></td>
<td>Declares the <em>jQuery-UI</em> asset</td>
</tr>
<tr>
<td><i class="conum">4</i></td>
<td>depends on <code>jquery</code> and <code>jquery-ui.css</code> assets</td>
</tr>
</table>
</div>

</div>
</div>
<div class="sect1">
<h2 id="_asset_declaration"><a class="anchor" href="#_asset_declaration"></a>Asset declaration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Assets are declared and used by the application with the following attributes:</p>
</div>
<div class="ulist">

<ul>
<li>
<p>an <em>id</em> to reference it within the application</p>
</li>
<li>
<p>a <em>location</em> and <em>source</em> for resolving the asset file</p>
</li>
<li>
<p>a list of <em>dependencies</em> referencing other assets that are needed by the asset</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, the <em>jQuery-UI</em> plugin could be identified by <em>jquery-ui</em> with the dependency onto the <em>jquery</em> js asset and
the <em>jQuery-UI</em> stylesheet. Its physical location would be the <code>asset</code> package with the <code>jquery-ui-1.4.2.min.js</code> name.</p>
</div>
<div class="sect2">
<h3 id="_asset_id"><a class="anchor" href="#_asset_id"></a>Asset id</h3>
<div class="paragraph">
<p>The asset id must be unique within the application, this value is however optional. When no id is declared, the asset value
is used for creating an id from the asset file name:</p>
</div>
<div class="ulist">

<ul>
<li>
<p>The value <code>jquery-ui-1.7.2.custom.min.js</code> produces the same <code>jquery-ui-1.7.2.custom.min.js</code> value</p>
</li>
<li>
<p>The value <code>js/jquery-ui-1.7.2.custom.min.js</code> produces the <code>jquery-ui-1.7.2.custom.min.js</code>  value</p>
</li>
</ul>
</div>

</div>
<div class="sect2">
<h3 id="_application_assets"><a class="anchor" href="#_application_assets"></a>Application assets</h3>
<div class="paragraph">
<p>Applications assets can be located anywhere on the application classpath, they can be either absolute or relatives. Relative
assets declared by the asset plugin must be located in the <code>assets</code> package of the application, for instance
an application packaged under <code>my.application</code> will have its relative assets located under <code>my.application.assets</code>.</p>
</div>
<div class="listingblock">
<div class="title">Declarative relative application asset configuration</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@Assets</span>(<span class="annotation">@Asset</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">myscript.js</span><span class="delimiter">&quot;</span></span>))
<span class="keyword">package</span> <span class="namespace">my.application</span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The location <code>AssetLocation.APPLICATION</code> is not declared because it is the default one.</p>
</div>

</div>
<div class="sect2">
<h3 id="_server_assets"><a class="anchor" href="#_server_assets"></a>Server assets</h3>
<div class="paragraph">
<p>Server assets are served by the webserver in which the application is deployed. Relative server assets are served from
the war file containing the application.</p>
</div>
<div class="listingblock">
<div class="title">Declarative relative server asset configuration</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@Assets</span>(<span class="annotation">@Asset</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">myscript.js</span><span class="delimiter">&quot;</span></span>, location = AssetLocation.SERVER))
<span class="keyword">package</span> <span class="namespace">my.application</span>;</code></pre>
</div>
</div>

</div>
<div class="sect2">
<h3 id="_external_assets"><a class="anchor" href="#_external_assets"></a>External assets</h3>
<div class="paragraph">
<p>External assets declares an opaque URL for Juzu.</p>
</div>
<div class="listingblock">
<div class="title">External classpath asset configuration</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@Assets</span>(<span class="annotation">@Asset</span>(
  value = <span class="string"><span class="delimiter">&quot;</span><span class="content">https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js</span><span class="delimiter">&quot;</span></span>,
  location = AssetLocation.URL))
<span class="keyword">package</span> <span class="namespace">my.application</span>;</code></pre>
</div>
</div>

</div>

</div>
</div>
<div class="sect1">
<h2 id="_asset_serving"><a class="anchor" href="#_asset_serving"></a>Asset serving</h2>
<div class="sectionbody">
<div class="paragraph">
<p>During a request, asset identifiers are added to the response. At the end of the request, Juzu translates the assets into
a list of uri to add to the page.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/assets/assets1.png" alt="Assets in request" width="700">
</div>
<div class="title">Figure 9. Using assets in a request</div>
</div>
<div class="paragraph">
<p>An asset reference is a link to an asset value that is configured externally, thus an asset of any kind will always resolve
to a location and an uri. Let&#8217;s examine the different possible asset location:</p>
</div>
<div class="ulist">

<ul>
<li>
<p><code>AssetLocation.URL</code>: the value is opaque to Juzu, for instance the a CDN hosted script such as <em><a href="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js">https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js</a></em>.</p>
</li>
<li>
<p><code>AssetLocation.SERVER</code>: the asset is served by the same web server in which Juzu is deployed. If the asset value is relative, the final uri will
resolve relatively to the web archive context address.</p>
</li>
<li>
<p><code>AssetLocation.APPLICATION</code>: the asset is served by Juzu <em>asset server</em> (a servlet configured in the web application) and the resource is located
on the classpath.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Asset serving can either be done declaratively with the <code>@WithAssets</code> annotation or with methods of the <code>juzu.Response.Content</code>
class.</p>
</div>
<div class="sect2">
<h3 id="_declarative_asset_serving"><a class="anchor" href="#_declarative_asset_serving"></a>Declarative asset serving</h3>
<div class="paragraph">
<p>The <code>WithAssets</code> annotation tells Juzu to add an asset to a content response, it takes asset ids as arguments:</p>
</div>
<div class="listingblock">
<div class="title">Serve jQuery and Twitter Bootstrap with the application index page</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@WithAssets</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">jquery</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">bootstrap</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@View</span>
<span class="directive">public</span> Response.Content index() {
  ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The annotation can be declared on <em>controller methods</em>, <em>classes</em> or <em>packages</em>. When the declaration occurs on
classes or packages, the declaration is <em>cascaded</em> on the nested controller.</p>
</div>
<div class="paragraph">
<p>The annotation can also be used with the <code><strong></code> pattern, matching all application declared assets, which is equivalent
to use the <code>@WithAssets</code> annotation without parameters as <code></strong></code> is this annotation default value.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="icon-tip" title="Tip"></i>
</td>
<td class="content">

Annotating the application package with <code>#WithAsset</code> will serve all assets declared in the application for all controllers.
If you need finer grained serving, remove it and use it on controller directly.
</td>
</tr>
</table>
</div>

</div>
<div class="sect2">
<h3 id="_dynamic_asset_serving"><a class="anchor" href="#_dynamic_asset_serving"></a>Dynamic asset serving</h3>
<div class="paragraph">
<p>Asset serving can be achieved programmatically when the application does not know the assets to serve at compilation
time:</p>
</div>
<div class="listingblock">
<div class="title">Serve <em>jQuery</em> and <em>Twitter Bootstrap</em> with the application index</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@View</span>
<span class="directive">public</span> Response.Content index() {
  ...
  return content.withAssets(<span class="string"><span class="delimiter">&quot;</span><span class="content">jquery</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">bootstrap</span><span class="delimiter">&quot;</span></span>);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>withAssets</code> method does exactly the same job than the <code>WithAssets</code> annotation.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">

The <code>@WithAssets</code> annotation and the <code>withAssets</code> method are cumulative.{{/note}}
</td>
</tr>
</table>
</div>

</div>

</div>
</div>
<div class="sect1">
<h2 id="_asset_server"><a class="anchor" href="#_asset_server"></a>Asset server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For serving classpath assets, Juzu requires the configuration of the asset server as a servlet declaration:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="xml language-xml"><span class="tag">&lt;servlet&gt;</span>
  <span class="tag">&lt;servlet-name&gt;</span>AssetServlet<span class="tag">&lt;/servlet-name&gt;</span>
  <span class="tag">&lt;servlet-class&gt;</span>juzu.impl.asset.AssetServlet<span class="tag">&lt;/servlet-class&gt;</span>
  <span class="tag">&lt;load-on-startup&gt;</span>0<span class="tag">&lt;/load-on-startup&gt;</span>
<span class="tag">&lt;/servlet&gt;</span>
<span class="tag">&lt;servlet-mapping&gt;</span>
  <span class="tag">&lt;servlet-name&gt;</span>AssetServlet<span class="tag">&lt;/servlet-name&gt;</span>
  <span class="tag">&lt;url-pattern&gt;</span>/assets/*<span class="tag">&lt;/url-pattern&gt;</span>
<span class="tag">&lt;/servlet-mapping&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This declaration should be in the <em>web.xml</em> of the application whether it is a servlet or a portlet application.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">

If you are using Servlet 3.0, this declaration is not necessary.
</td>
</tr>
</table>
</div>

</div>
</div>
<div class="sect1">
<h2 id="_asset_manager"><a class="anchor" href="#_asset_manager"></a>Asset manager</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When an application is deployed, assets are registered against the <em>asset manager</em>. The asset manager has several
 responsibilities:</p>
</div>
<div class="ulist">

<ul>
<li>
<p>manage asset dependencies: the order in which assets are literaly declared when they are served. For instance
the <em>jquery-ui</em> asset depends on the <em>jquery</em> asset because the jquery script must be loaded before the <em>jquery-ui</em>
script.</p>
</li>
<li>
<p>resolve asset references: each asset reference must be resolved and produce a final web url that will produce the resource
when it is resolved by the web browsers</p>
</li>
</ul>
</div>

</div>
</div>

<h1 id="amd" class="sect0"><a class="anchor" href="#amd"></a>Javascript modularity</h1>
<div class="paragraph">
<p>The AMD plugin provides declarative support for JavaScript modules using annotations. It relies on the
<a href="https://github.com/amdjs/amdjs-api/wiki/AMD">Asynchronous Module Definition</a> specification implemented by the
<a href="http://requirejs.org/">RequireJS</a> project.</p>
</div>
<div class="sect1">
<h2 id="_introduction_to_modules"><a class="anchor" href="#_introduction_to_modules"></a>Introduction to modules</h2>
<div class="sectionbody">
<div class="paragraph">
<p>JavaScript does not provide a natural way for namespacing, the notion of module was designed to solve this problem.
This natural lack of namespacing can be perceived as a lack, instead it should be seen as an advantage as modules
provide namespacing and more: indeed the module pattern allows to create dependencies between modules and resolve
them at runtime enabling on demand and parallel loading of JavaScript resources.</p>
</div>
<div class="paragraph">
<p>This guide will not explain modules because we haven’t designed a module system for Juzu. Instead Juzu uses the RequireJS
library and integrates it. Therefore the best documentation you can read about modules is the RequireJS documentation
you can also read the excellent <a href="http://www.adequatelygood.com/JavaScript-Module-Pattern-In-Depth.html">article</a>
about modules in depth.</p>
</div>
<div class="paragraph">
<p>In the essence the notion of module can be viewed as:</p>
</div>
<div class="ulist">

<ul>
<li>
<p>An identifier</p>
</li>
<li>
<p>A list of dependencies on the modules required by the module to work properly</p>
</li>
<li>
<p>The code packaged usually expressed as a self-executing function</p>
</li>
<li>
<p>The product which is an object produced by the module that is usually consumed by other modules</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>At runtime the dependency system defines a graph of function to execute, the product of each module being injected in
the other modules. It can be seen as a simple dependency injection system able to load modules in an asynchronous and
parallel fashion providing parallel loading, namespacing and dependency management.</p>
</div>

</div>
</div>
<div class="sect1">
<h2 id="_defining_a_module"><a class="anchor" href="#_defining_a_module"></a>Defining a module</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>@Defines</code> and <code>@Define</code> are used to declare the JavaScript which is either a canonical module as defined
 by the AMD specification or a simple self-executing function.</p>
</div>
<div class="paragraph">
<p>When the javascript is self-executing function, this script is wrapped to provide the expected RequireJS format, let&#8217;s
study a quick example with a module:</p>
</div>
<div class="listingblock">
<div class="title">Defining a simple module</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@Defines</span>(value={<span class="annotation">@Define</span>(name=<span class="string"><span class="delimiter">&quot;</span><span class="content">Foo</span><span class="delimiter">&quot;</span></span>, path=<span class="string"><span class="delimiter">&quot;</span><span class="content">foo.js</span><span class="delimiter">&quot;</span></span>)})
<span class="keyword">package</span> <span class="namespace">my.application</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">The <code>foo.js</code> self-executing function</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java">(function () {
  <span class="comment">//Do something</span>
})();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Equivalent to this declaration in the RequireJS format:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java">define(<span class="string"><span class="delimiter">&quot;</span><span class="content">Foo</span><span class="delimiter">&quot;</span></span>, function() {
  <span class="keyword">return</span> <span class="comment">//Something</span>
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Modularity allows to define cross dependencies between modules, the <code>@Define</code> annotation allows that:</p>
</div>
<div class="listingblock">
<div class="title">Defining a module with dependencies</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@Defines</span>(
  value = {
    <span class="annotation">@Define</span>(name=<span class="string"><span class="delimiter">&quot;</span><span class="content">Foo</span><span class="delimiter">&quot;</span></span>, path=<span class="string"><span class="delimiter">&quot;</span><span class="content">foo.js</span><span class="delimiter">&quot;</span></span>),
    <span class="annotation">@Define</span>(name=<span class="string"><span class="delimiter">&quot;</span><span class="content">Bar</span><span class="delimiter">&quot;</span></span>, path=<span class="string"><span class="delimiter">&quot;</span><span class="content">bar.js</span><span class="delimiter">&quot;</span></span>, dependencies={<span class="annotation">@Dependency</span>(name=<span class="string"><span class="delimiter">&quot;</span><span class="content">Foo</span><span class="delimiter">&quot;</span></span>, alias=<span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span>)}}
)</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">The <code>bar.js</code> self-executing function</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java">(function(foo) {
  <span class="comment">//Do something</span>
})(foo);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Equivalent to this declaration in the RequireJS format:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java">define(<span class="string"><span class="delimiter">&quot;</span><span class="content">Bar</span><span class="delimiter">&quot;</span></span>, [<span class="string"><span class="delimiter">&quot;</span><span class="content">Foo</span><span class="delimiter">&quot;</span></span>], function(foo) {
  <span class="keyword">return</span> <span class="comment">//Something</span>
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Juzu AMD plugin allows to provide custom adapter for adapting the script to the expected format. With this flexibility
it is possible to declare an adapter wrapping the adapted script. The jQuery library is a good example of how a custom
adapter can be useful. Thanks to the adapter feature we can reuse the jQuery without any change:</p>
</div>
<div class="listingblock">
<div class="title">The jQuery uses the following construct for defining itself</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java">(function(window, undefined) {
})(window);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The main issue with this construct is that it will bind jQuery to the window but most importantly it will not return any
value as expected by the dependency system. Thanks to the custom adapter we can integrate it easily:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@Define</span>(
  id = <span class="string"><span class="delimiter">&quot;</span><span class="content">jquery</span><span class="delimiter">&quot;</span></span>,
  path=<span class="string"><span class="delimiter">&quot;</span><span class="content">jquery-1.7.1.js</span><span class="delimiter">&quot;</span></span>,
  adapter=<span class="string"><span class="delimiter">&quot;</span><span class="content">(function() { @{include} return jQuery.noConflict(true);})();</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>of the original jQuery script in the resulting module:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java">define(<span class="string"><span class="delimiter">&quot;</span><span class="content">jquery</span><span class="delimiter">&quot;</span></span>, <span class="type">[]</span>, function() {
  <span class="keyword">return</span> (function() {
    (function(window, undefined) {
    })(window);
    <span class="keyword">return</span> jQuery.noConflict(<span class="predefined-constant">true</span>);
  })();
});</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">

The Juzu AMD definition adapts only the javascript located at <code>AssetLocation.APPLICATION</code>. The <code>@Require</code> annotation
must be used for other kind of locations.
</td>
</tr>
</table>
</div>

</div>
</div>
<div class="sect1">
<h2 id="_requiring_a_module"><a class="anchor" href="#_requiring_a_module"></a>Requiring a module</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Juzu AMD <code>@Require</code> annotation only register a JavaScript module for RequireJS Loader. It does not wrap or adapt
content and does not manage module dependencies.</p>
</div>
<div class="paragraph">
<p>Here is an example of using <code>@Requires</code> and <code>@Require</code> to register the <code>foo.js</code> script and the <code>bar.js</code> scripts
that depends on <code>foo.js</code>.</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@Requires</span> (
  value = {
    <span class="annotation">@Require</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">Foo</span><span class="delimiter">&quot;</span></span>, path = <span class="string"><span class="delimiter">&quot;</span><span class="content">foo.js</span><span class="delimiter">&quot;</span></span>),
    <span class="annotation">@Require</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">Bar</span><span class="delimiter">&quot;</span></span>, path = <span class="string"><span class="delimiter">&quot;</span><span class="content">bar.js</span><span class="delimiter">&quot;</span></span>)}
)
<span class="keyword">package</span> <span class="namespace">my.application</span>;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">The <code>foo.js</code> module declaration</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java">define(<span class="string"><span class="delimiter">&quot;</span><span class="content">Foo</span><span class="delimiter">&quot;</span></span>, function() {
  <span class="keyword">return</span> {
    text: <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello</span><span class="delimiter">&quot;</span></span>
  };
});</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">The <code>bar.js</code> module declaration</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java">define(<span class="string"><span class="delimiter">&quot;</span><span class="content">Bar</span><span class="delimiter">&quot;</span></span>, [<span class="string"><span class="delimiter">&quot;</span><span class="content">Foo</span><span class="delimiter">&quot;</span></span>], function(foo) {
  <span class="keyword">return</span> {
    text : foo.text + <span class="string"><span class="delimiter">&quot;</span><span class="content"> World</span><span class="delimiter">&quot;</span></span>
  };
});</code></pre>
</div>
</div>

</div>
</div>

<h1 id="_file_upload_plugin" class="sect0"><a class="anchor" href="#_file_upload_plugin"></a>File upload plugin</h1>
<div class="sect1">
<h2 id="_juzu_file_upload_plugin"><a class="anchor" href="#_juzu_file_upload_plugin"></a>Juzu File Upload Plugin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The file upload plugin integrates <a href="http://commons.apache.org/fileupload/">Apache Commons FileUpload</a> in Juzu. The plugin
decodes multipart requests as file objects and can inject them as controller method parameters. This plugin works
with the servlet bridge and the portlet bridge.</p>
</div>
<div class="sect2">
<h3 id="_file_upload_in_an_action_phase"><a class="anchor" href="#_file_upload_in_an_action_phase"></a>File upload in an action phase</h3>
<div class="paragraph">
<p>File upload can be handled during an action of a portlet or a servlet:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@Action</span>
<span class="annotation">@Route</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/upload</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">void</span> upload(org.apache.commons.fileupload.FileItem file) {
   <span class="keyword">if</span> (file != <span class="predefined-constant">null</span>) {
      <span class="comment">// Handle the file upload</span>
   }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">

The <code>@Route</code> annotation is only meaningfull for the servlet bridge. In case of a portlet, the URL
is managed by the portal.
</td>
</tr>
</table>
</div>

</div>
<div class="sect2">
<h3 id="_file_upload_in_a_resource_phase"><a class="anchor" href="#_file_upload_in_a_resource_phase"></a>File upload in a resource phase</h3>
<div class="paragraph">
<p>File upload can also be handled in a resource phase.</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@Resource</span>
<span class="annotation">@Route</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/upload</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> Response.Content upload(org.apache.commons.fileupload.FileItem file) {
   <span class="keyword">if</span> (file != <span class="predefined-constant">null</span>) {
      <span class="comment">// Handle the file upload</span>
   }
   <span class="keyword">return</span> Response.ok(<span class="string"><span class="delimiter">&quot;</span><span class="content">Upload is done</span><span class="delimiter">&quot;</span></span>);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Handling upload in a resource phase can be used when the file is uploaded via Ajax: the application
 does not want a view phase to be triggered after the upload.</p>
</div>

</div>

</div>
</div>

<h1 id="_less_plugin" class="sect0"><a class="anchor" href="#_less_plugin"></a>Less plugin</h1>
<div class="sect1">
<h2 id="_juzu_less_plugin"><a class="anchor" href="#_juzu_less_plugin"></a>Juzu Less Plugin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>LESS is a dynamic stylesheet language which extends CSS with dynamic behavior such as variables, mixins, operations
and functions. LESS is easy to learn thanks to the <a href="http://lesscss.org/">online documentation</a>.</p>
</div>
<div class="paragraph">
<p>Juzu provides a LESS plugin that takes care of compiling a LESS stylesheet into a CSS stylesheet which
are then served by the Asset plugin. This chapter explains how to use LESS and combine it with the <a href="#assets">Assets</a> plugin.</p>
</div>

</div>
</div>
<div class="sect1">
<h2 id="_usage"><a class="anchor" href="#_usage"></a>Usage</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The LESS plugin operates at compilation time only because the only task he has to do is to transform a LESS
source code into a CSS stylesheet. The runtime part is usually done by the Asset plugin.</p>
</div>
<div class="paragraph">
<p>The <code>@Less</code> annotation annotates a package containing an <code>assets</code> package. This <code>assets</code> package should contain
 the LESS files to be compiled.</p>
</div>
<div class="listingblock">
<div class="title">Annotating an application package for processing LESS files</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@Less</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">stylesheet.less</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Application</span>
<span class="keyword">package</span> <span class="namespace">myapp</span>;

<span class="keyword">import</span> <span class="include">juzu.plugin.less.Less</span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>stylesheet.less</em> file will be located in the <code>myapp.assets</code> package. The <code>assets</code> child package of the
annotated package should contain the stylesheet, this is done on purpose to coincide exactly with the
<code>assets</code> package used by the Asset plugin. During the compilation phase the <em>stylesheet.less</em> will be compiled
to the <em>stylesheet.css</em>. If we want this file to be served with the application we simply add the corresponding
<code>@Assets</code> annotation:</p>
</div>
<div class="listingblock">
<div class="title">LESS and Asset plugins in action</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@Less</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">stylesheet.less</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Assets</span>(stylesheets = <span class="annotation">@Stylesheet</span>(
  src = <span class="string"><span class="delimiter">&quot;</span><span class="content">stylesheet.css</span><span class="delimiter">&quot;</span></span>,
  location = AssetLocation.CLASSPATH)
)
<span class="annotation">@Application</span>
<span class="keyword">package</span> <span class="namespace">myapp</span>;

<span class="keyword">import</span> <span class="include">juzu.Application</span>;
<span class="keyword">import</span> <span class="include">juzu.asset.AssetLocation</span>;
<span class="keyword">import</span> <span class="include">juzu.plugin.less.Less</span>;
<span class="keyword">import</span> <span class="include">juzu.plugin.asset.Assets</span>;
<span class="keyword">import</span> <span class="include">juzu.plugin.asset.Stylesheet</span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default LESS will use a default formatting for the generated CSS. To achieve smaller CSS size, a <em>minify</em> option
can be used, this option will trim the whitespace when processing the file : <code>@Less(value = "stylesheet.less", minify = true)</code>.</p>
</div>
<div class="sect2">
<h3 id="_building"><a class="anchor" href="#_building"></a>Building</h3>
<div class="paragraph">
<p>Add the Less plugin jar to your compilation classpath.</p>
</div>
<div class="paragraph">
<p>In Maven it can achieved by adding the Less plugin dependency to your POM:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="xml language-xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.juzu<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>juzu-plugins-less<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>$[juzu.version]<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>

</div>

</div>
</div>

<h1 id="_webjars_plugin" class="sect0"><a class="anchor" href="#_webjars_plugin"></a>WebJars plugin</h1>
<div class="sect1">
<h2 id="_juzu_webjars_plugin"><a class="anchor" href="#_juzu_webjars_plugin"></a>Juzu WebJars Plugin</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="http://www.webjars.org/">WebJars</a> are client-side web libraries (e.g. jQuery &amp; Bootstrap) packaged into jar files.
WebJars allow to declaratively set the version, use a consistent version across an application, and easily deal with transitive dependencies.</p>
</div>
<div class="paragraph">
<p>Juzu provides a WebJars plugin that copies resources in jar libraries to application assets and then served by the <em>Asset</em>
plugin or the <em>AMD</em> plugin.</p>
</div>
<div class="sect2">
<h3 id="_usage_2"><a class="anchor" href="#_usage_2"></a>Usage</h3>
<div class="listingblock">
<div class="title">Annotating an application package for declaring WebJars</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@Application</span>
<span class="annotation">@WebJars</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">foo.js</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">package</span> <span class="namespace">myapp</span>;

<span class="keyword">import</span> <span class="include">juzu.Application</span>;
<span class="keyword">import</span> <span class="include">juzu.plugin.webjars.WebJars</span>;</code></pre>
</div>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="xml language-xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.webjars<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>foo<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>1.0<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>foo.js</em> file will be located in the <code>myapp.assets</code> package.</p>
</div>
<div class="paragraph">
<p>If we want this file to be served with the application we simply add the corresponding <code>@Assets</code> annotation:</p>
</div>
<div class="listingblock">
<div class="title">WebJars and Asset plugin in action</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@Application</span>
<span class="annotation">@WebJars</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">foo.js</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Assets</span>(scripts = {
  <span class="annotation">@Script</span>(
    id = <span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span>,
    src=<span class="string"><span class="delimiter">&quot;</span><span class="content">foo.js</span><span class="delimiter">&quot;</span></span>
  )
})
<span class="keyword">package</span> <span class="namespace">myapp</span>;

<span class="keyword">import</span> <span class="include">juzu.Application</span>;
<span class="keyword">import</span> <span class="include">juzu.plugin.asset.Assets</span>;
<span class="keyword">import</span> <span class="include">juzu.plugin.asset.Script</span>;
<span class="keyword">import</span> <span class="include">juzu.plugin.webjars.WebJars</span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>It can also be used as a JavaScript module with the <em>AMD</em> plugin:</p>
</div>
<div class="listingblock">
<div class="title">WebJars and AMD plugin in action</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@Application</span>
<span class="annotation">@WebJars</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">foo.js</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Defines</span>({
  <span class="annotation">@Define</span>(
    name = <span class="string"><span class="delimiter">&quot;</span><span class="content">Foo</span><span class="delimiter">&quot;</span></span>,
    path=<span class="string"><span class="delimiter">&quot;</span><span class="content">foo.js</span><span class="delimiter">&quot;</span></span>
  ),
  <span class="annotation">@Define</span>(
    name = <span class="string"><span class="delimiter">&quot;</span><span class="content">Bar</span><span class="delimiter">&quot;</span></span>,
    path=<span class="string"><span class="delimiter">&quot;</span><span class="content">bar.js</span><span class="delimiter">&quot;</span></span>,
    dependencies = {<span class="annotation">@Dependency</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">Foo</span><span class="delimiter">&quot;</span></span>)}
  )
})
<span class="keyword">package</span> <span class="namespace">myapp</span>;

<span class="keyword">import</span> <span class="include">juzu.Application</span>;
<span class="keyword">import</span> <span class="include">juzu.plugin.amd.Define</span>;
<span class="keyword">import</span> <span class="include">juzu.plugin.amd.Defines</span>;
<span class="keyword">import</span> <span class="include">juzu.plugin.amd.Dependency</span>;
<span class="keyword">import</span> <span class="include">juzu.plugin.webjars.WebJars</span>;</code></pre>
</div>
</div>

</div>
<div class="sect2">
<h3 id="_building_2"><a class="anchor" href="#_building_2"></a>Building</h3>
<div class="paragraph">
<p>Add the WebJars plugin jar to your compilation classpath.</p>
</div>
<div class="paragraph">
<p>In Maven it can achieved by adding the WebJars plugin dependency to your POM:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="xl language-xl">&lt;dependency&gt;
  &lt;groupId&gt;org.juzu&lt;/groupId&gt;
  &lt;artifactId&gt;juzu-plugins-webjars&lt;/artifactId&gt;
  &lt;version&gt;$[juzu.version]&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>

</div>

</div>
</div>

<h1 id="_servlet" class="sect0"><a class="anchor" href="#_servlet"></a>Servlet</h1>
<div class="sect1">
<h2 id="_juzu_servlet_plugin"><a class="anchor" href="#_juzu_servlet_plugin"></a>Juzu Servlet Plugin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The servlet plugin enhance Juzu servlet applications.</p>
</div>
<div class="sect2">
<h3 id="_servlet_class_generation"><a class="anchor" href="#_servlet_class_generation"></a>Servlet class generation</h3>
<div class="paragraph">
<p>A Juzu servlet application is managed by a JuzuServlet configured with the application name. Since Servlet 3.0,
configuration can be easier thanks to servlet annotations. Juzu leverages this capability and is able to generate a
servlet for an application with the juzu.plugin.servlet.Servlet annotation:</p>
</div>
<div class="listingblock">
<div class="title">Juzu servlet generation</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@Application</span>
<span class="annotation">@Servlet</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span>) <span class="comment">// <i class="conum">1</i></span>
<span class="keyword">package</span> <span class="namespace">my.application</span>;</code></pre>
</div>
</div>
<div class="colist arabic">

<table>
<tr>
<td><i class="conum">1</i></td>
<td>The application <em>url-pattern</em></td>
</tr>
</table>
</div>

</div>
<div class="sect2">
<h3 id="_asset_server_automatic_registration"><a class="anchor" href="#_asset_server_automatic_registration"></a>Asset server automatic registration</h3>
<div class="paragraph">
<p>The jar of the servlet plugin contains a <em>web-fragment.xml</em> that automatically declares the asset servlet simplifying
further more the configuration of the application.</p>
</div>

</div>

</div>
</div>

<h1 id="_portlet" class="sect0"><a class="anchor" href="#_portlet"></a>Portlet</h1>
<div class="sect1">
<h2 id="_juzu_portlet_plugin"><a class="anchor" href="#_juzu_portlet_plugin"></a>Juzu Portlet Plugin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The portlet plugin enhance Juzu portlet applications.</p>
</div>
<div class="sect2">
<h3 id="_portlet_class_generation"><a class="anchor" href="#_portlet_class_generation"></a>Portlet class generation</h3>
<div class="paragraph">
<p>A Juzu portlet application is managed by a <code>JuzuPortlet</code> configured with the application name. The
<code>@juzu.plugin.portlet.Portlet</code> annotation can be used to generate a subclass of the <code>JuzuPortlet</code> that configures
the application name for you, easing the configuration of the <em>portlet.xml</em> corresponding section.</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@Portlet</span>
<span class="keyword">package</span> <span class="namespace">my</span>;</code></pre>
</div>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="xml language-xml"><span class="tag">&lt;portlet&gt;</span>
  <span class="tag">&lt;portlet-name&gt;</span>MyApplication<span class="tag">&lt;/portlet-name&gt;</span>
  <span class="tag">&lt;display-name</span> <span class="attribute-name">xml:lang</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">EN</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>My Application<span class="tag">&lt;/display-name&gt;</span>
  <span class="tag">&lt;portlet-class&gt;</span>myapp.MyPortlet<span class="tag">&lt;/portlet-class&gt;</span>
  <span class="tag">&lt;supports&gt;</span>
    <span class="tag">&lt;mime-type&gt;</span>text/html<span class="tag">&lt;/mime-type&gt;</span>
  <span class="tag">&lt;/supports&gt;</span>
  <span class="tag">&lt;portlet-info&gt;</span>
    <span class="tag">&lt;title&gt;</span>My Application<span class="tag">&lt;/title&gt;</span>
  <span class="tag">&lt;/portlet-info&gt;</span>
<span class="tag">&lt;/portlet&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The plugin will generate the portlet using the application name with the first letter capitalized and the <em>Portlet</em> suffix.
In our example the <em>my</em> application generates the <code>MyPortlet</code> class. If you don&#8217;t like it you can change the name of the
generated class in the application:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@Portlet</span>(name <span class="string"><span class="delimiter">&quot;</span><span class="content">MyGreatPortlet</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">package</span> <span class="namespace">my</span>;</code></pre>
</div>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="xml language-xml"><span class="tag">&lt;portlet&gt;</span>
  <span class="tag">&lt;portlet-name&gt;</span>MyApplication<span class="tag">&lt;/portlet-name&gt;</span>
  <span class="tag">&lt;display-name</span> <span class="attribute-name">xml:lang</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">EN</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>My Application<span class="tag">&lt;/display-name&gt;</span>
  <span class="tag">&lt;portlet-class&gt;</span>myapp.MyGreatPortlet<span class="tag">&lt;/portlet-class&gt;</span>
  <span class="tag">&lt;supports&gt;</span>
    <span class="tag">&lt;mime-type&gt;</span>text/html<span class="tag">&lt;/mime-type&gt;</span>
  <span class="tag">&lt;/supports&gt;</span>
  <span class="tag">&lt;portlet-info&gt;</span>
    <span class="tag">&lt;title&gt;</span>My Application<span class="tag">&lt;/title&gt;</span>
  <span class="tag">&lt;/portlet-info&gt;</span>
<span class="tag">&lt;/portlet&gt;</span></code></pre>
</div>
</div>

</div>
<div class="sect2">
<h3 id="_portlet_preferences_injection"><a class="anchor" href="#_portlet_preferences_injection"></a>Portlet preferences injection</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">During the various phase of an application, the current portlet preferences can be injected</dt>
<dd>
<p>.Injecting portlet preferences</p>
</dd>
</dl>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@Inject</span> javax.portlet.PortletPreferences preferences;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">

The same restriction defined in the portlet specification applies to the provided preferences object: i.e saving preferences
can only be performed during an action phase.
</td>
</tr>
</table>
</div>

</div>
<div class="sect2">
<h3 id="_resource_bundle_injection"><a class="anchor" href="#_resource_bundle_injection"></a>Resource bundle injection</h3>
<div class="paragraph">
<p>During the various phase of an application, the portlet resource bundle for the current locale can be injected:</p>
</div>
<div class="listingblock">
<div class="title">Injecting the portlet resource bundle</div>
<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="annotation">@Inject</span> java.util.ResourceBundle bundle;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is equivalent of doing:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="predefined-type">Locale</span> locale = request.getLocale();
<span class="predefined-type">ResourceBundle</span> bundle = portlet.getConfig().getResourceBundle(locale);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This resource bundle can be configured in the <em>portlet.xml</em> deployment descriptor.</p>
</div>

</div>
<div class="sect2">
<h3 id="_building_3"><a class="anchor" href="#_building_3"></a>Building</h3>
<div class="paragraph">
<p>Add the Portlet plugin jar to your compilation classpath.</p>
</div>
<div class="paragraph">
<p>In Maven it can achieved by adding the Less plugin dependency to your POM:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="xml language-xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.juzu<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>juzu-plugins-portlet<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>$[juzu.version]<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>

</div>

</div>
</div>


</div>
<div id="footer">
<div id="footer-text">
Last updated 2013-10-08 17:10:37 CEST
</div>
</div>
</body>
</html>