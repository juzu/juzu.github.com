<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="generator" content="Asciidoctor 0.1.3">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Step 7 - Finish the job properly</title>
<link rel="stylesheet" href="./rocket-panda.css">
<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/3.1.0/css/font-awesome.min.css">
<style>
.CodeRay {
  background-color: hsl(0,0%,95%);
  border: 1px solid silver;
  color: black;
}
.CodeRay pre {
  margin: 0px;
}

span.CodeRay { white-space: pre; border: 0px; padding: 2px; }

table.CodeRay { border-collapse: collapse; width: 100%; padding: 2px; }
table.CodeRay td { padding: 2px 4px; vertical-align: top; }

.CodeRay .line-numbers {
  background-color: hsl(180,65%,90%);
  color: gray;
  text-align: right;
  -webkit-user-select: none;
  -moz-user-select: none;
  user-select: none;
}
.CodeRay .line-numbers a {
  background-color: hsl(180,65%,90%) !important;
  color: gray !important;
  text-decoration: none !important;
}
.CodeRay .line-numbers a:target { color: blue !important; }
.CodeRay .line-numbers .highlighted { color: red !important; }
.CodeRay .line-numbers .highlighted a { color: red !important; }
.CodeRay span.line-numbers { padding: 0px 4px; }
.CodeRay .line { display: block; float: left; width: 100%; }
.CodeRay .code { width: 100%; }

.CodeRay .debug { color: white !important; background: blue !important; }

.CodeRay .annotation { color:#007 }
.CodeRay .attribute-name { color:#b48 }
.CodeRay .attribute-value { color:#700 }
.CodeRay .binary { color:#509 }
.CodeRay .char .content { color:#D20 }
.CodeRay .char .delimiter { color:#710 }
.CodeRay .char { color:#D20 }
.CodeRay .class { color:#B06; font-weight:bold }
.CodeRay .class-variable { color:#369 }
.CodeRay .color { color:#0A0 }
.CodeRay .comment { color:#777 }
.CodeRay .comment .char { color:#444 }
.CodeRay .comment .delimiter { color:#444 }
.CodeRay .complex { color:#A08 }
.CodeRay .constant { color:#036; font-weight:bold }
.CodeRay .decorator { color:#B0B }
.CodeRay .definition { color:#099; font-weight:bold }
.CodeRay .delimiter { color:black }
.CodeRay .directive { color:#088; font-weight:bold }
.CodeRay .doc { color:#970 }
.CodeRay .doc-string { color:#D42; font-weight:bold }
.CodeRay .doctype { color:#34b }
.CodeRay .entity { color:#800; font-weight:bold }
.CodeRay .error { color:#F00; background-color:#FAA }
.CodeRay .escape  { color:#666 }
.CodeRay .exception { color:#C00; font-weight:bold }
.CodeRay .float { color:#60E }
.CodeRay .function { color:#06B; font-weight:bold }
.CodeRay .global-variable { color:#d70 }
.CodeRay .hex { color:#02b }
.CodeRay .imaginary { color:#f00 }
.CodeRay .include { color:#B44; font-weight:bold }
.CodeRay .inline { background-color: hsla(0,0%,0%,0.07); color: black }
.CodeRay .inline-delimiter { font-weight: bold; color: #666 }
.CodeRay .instance-variable { color:#33B }
.CodeRay .integer  { color:#00D }
.CodeRay .key .char { color: #60f }
.CodeRay .key .delimiter { color: #404 }
.CodeRay .key { color: #606 }
.CodeRay .keyword { color:#080; font-weight:bold }
.CodeRay .label { color:#970; font-weight:bold }
.CodeRay .local-variable { color:#963 }
.CodeRay .namespace { color:#707; font-weight:bold }
.CodeRay .octal { color:#40E }
.CodeRay .operator { }
.CodeRay .predefined { color:#369; font-weight:bold }
.CodeRay .predefined-constant { color:#069 }
.CodeRay .predefined-type { color:#0a5; font-weight:bold }
.CodeRay .preprocessor { color:#579 }
.CodeRay .pseudo-class { color:#00C; font-weight:bold }
.CodeRay .regexp .content { color:#808 }
.CodeRay .regexp .delimiter { color:#404 }
.CodeRay .regexp .modifier { color:#C2C }
.CodeRay .regexp { background-color:hsla(300,100%,50%,0.06); }
.CodeRay .reserved { color:#080; font-weight:bold }
.CodeRay .shell .content { color:#2B2 }
.CodeRay .shell .delimiter { color:#161 }
.CodeRay .shell { background-color:hsla(120,100%,50%,0.06); }
.CodeRay .string .char { color: #b0b }
.CodeRay .string .content { color: #D20 }
.CodeRay .string .delimiter { color: #710 }
.CodeRay .string .modifier { color: #E40 }
.CodeRay .string { background-color:hsla(0,100%,50%,0.05); }
.CodeRay .symbol .content { color:#A60 }
.CodeRay .symbol .delimiter { color:#630 }
.CodeRay .symbol { color:#A60 }
.CodeRay .tag { color:#070 }
.CodeRay .type { color:#339; font-weight:bold }
.CodeRay .value { color: #088; }
.CodeRay .variable  { color:#037 }

.CodeRay .insert { background: hsla(120,100%,50%,0.12) }
.CodeRay .delete { background: hsla(0,100%,50%,0.12) }
.CodeRay .change { color: #bbf; background: #007; }
.CodeRay .head { color: #f8f; background: #505 }
.CodeRay .head .filename { color: white; }

.CodeRay .delete .eyecatcher { background-color: hsla(0,100%,50%,0.2); border: 1px solid hsla(0,100%,45%,0.5); margin: -1px; border-bottom: none; border-top-left-radius: 5px; border-top-right-radius: 5px; }
.CodeRay .insert .eyecatcher { background-color: hsla(120,100%,50%,0.2); border: 1px solid hsla(120,100%,25%,0.5); margin: -1px; border-top: none; border-bottom-left-radius: 5px; border-bottom-right-radius: 5px; }

.CodeRay .insert .insert { color: #0c0; background:transparent; font-weight:bold }
.CodeRay .delete .delete { color: #c00; background:transparent; font-weight:bold }
.CodeRay .change .change { color: #88f }
.CodeRay .head .head { color: #f4f }

</style>
<script>
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
                m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-1292368-37', 'juzuweb.org');
    ga('send', 'pageview');

</script>
</head>
<body class="book toc2">
<div id="header">
<h1>Step 7 - Finish the job properly</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ol type="none" class="sectlevel0">
<li><a href="#_dependencies">Dependencies</a></li>
<li><a href="#_test_configuration_and_mocks">Test configuration and Mocks</a></li>
<li><a href="#_overwrite_service_implementation">Overwrite service implementation</a></li>
<li><a href="#_test_cases">Test cases</a></li>
<li><a href="#_test_rendering">Test rendering</a></li>
<li><a href="#_test_adding_secret">Test adding secret</a></li>
<li><a href="#_test_assets">Test Assets</a></li>
<li><a href="#_test_ajax_actions">Test Ajax actions</a></li>
</ol>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>JuZcret application is now finish but our <strong>project is not perfect</strong>&#8230;<br>
All through the JuZcret tutorial we ignore to tell you about <strong>Unit Test</strong> and this for sure, is not a good practice.<br>
The reason is that we wanted to keep you focus on a specific topic during each step. It’s why it’s only during this last step that we’ll talk about <strong>Unit Test in Juzu</strong>.<br>
The good point is that Juzu allow you to easily leverage <strong>selenium</strong> for simulating real application while taking advantage of the speed of <strong>JUnit</strong>.</p>
</div>
<div class="paragraph">
<p>So it&#8217;s time to write Unit Test for our JuZcret portlet. The portlet will be deploy to an embedded portlet container. <strong>Selenium and webdriver</strong> will help to simulate almost all user interactions with the application, then <strong>Arquillian</strong> will help to integrate with <strong>JUnit</strong>.</p>
</div>

</div>
</div>
<h1 id="_dependencies" class="sect0"><a class="anchor" href="#_dependencies"></a>Dependencies</h1>
<div class="paragraph">
<p>So we will use:</p>
</div>
<div class="ulist">

<ul>
<li>
<p><strong>JUnit 4</strong></p>
</li>
<li>
<p><strong>Arquillian</strong>: A testing framework for managing containers and write integration test</p>
</li>
<li>
<p><strong>ShrinkWrap</strong>: Arquillian’s little brother for creating Java archives easily</p>
</li>
<li>
<p><strong>Selenium WebDriver</strong>: A simple API for simulating browser behavior</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For making testing easy, Juzu provides a Maven dependencies called <strong>depchains</strong> containing all needed dependencies for testing an application with those tools: <code>juzu-depchain-arquillian</code> and <code>juzu-depchain-arquillian-tomcat7</code> that should be already in your <code>pom.xml</code>:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="xml language-xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>junit<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>junit<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>4.10<span class="tag">&lt;/version&gt;</span>
  <span class="tag">&lt;scope&gt;</span>test<span class="tag">&lt;/scope&gt;</span>
<span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.juzu<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>juzu-depchain-arquillian<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>1.0.0<span class="tag">&lt;/version&gt;</span>
  <span class="tag">&lt;scope&gt;</span>test<span class="tag">&lt;/scope&gt;</span>
<span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.juzu<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>juzu-depchain-arquillian-tomcat7<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>1.0.0<span class="tag">&lt;/version&gt;</span>
  <span class="tag">&lt;scope&gt;</span>test<span class="tag">&lt;/scope&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Also Juzu core provides some <strong>abstract test class</strong>, that make our test easier to interact with Arquillian. Lets add this dependency and this plugin:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="xml language-xml">       [...]

       <span class="tag">&lt;dependency&gt;</span>
          <span class="tag">&lt;groupId&gt;</span>org.juzu<span class="tag">&lt;/groupId&gt;</span>
          <span class="tag">&lt;artifactId&gt;</span>juzu-core<span class="tag">&lt;/artifactId&gt;</span>
          <span class="tag">&lt;version&gt;</span>1.0.0<span class="tag">&lt;/version&gt;</span>
          <span class="tag">&lt;type&gt;</span>test-jar<span class="tag">&lt;/type&gt;</span>
          <span class="tag">&lt;scope&gt;</span>test<span class="tag">&lt;/scope&gt;</span>
       <span class="tag">&lt;/dependency&gt;</span>

    [...]

              <span class="comment">&lt;!-- juzu-core test jar need this configuration --&gt;</span>
              <span class="tag">&lt;plugin&gt;</span>
                <span class="tag">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/groupId&gt;</span>
                <span class="tag">&lt;artifactId&gt;</span>maven-surefire-plugin<span class="tag">&lt;/artifactId&gt;</span>
                <span class="tag">&lt;version&gt;</span>2.16<span class="tag">&lt;/version&gt;</span>
                <span class="tag">&lt;configuration&gt;</span>
                <span class="tag">&lt;systemPropertyVariables&gt;</span>
                  <span class="tag">&lt;targetDir&gt;</span>${project.build.directory}<span class="tag">&lt;/targetDir&gt;</span>
                  <span class="tag">&lt;juzu.test.compiler&gt;</span>javac<span class="tag">&lt;/juzu.test.compiler&gt;</span>
                  <span class="tag">&lt;juzu.test.resources.path&gt;</span>${basedir}/src/test/resources<span class="tag">&lt;/juzu.test.resources.path&gt;</span>
                  <span class="tag">&lt;juzu.test.workspace.path&gt;</span>
                    ${project.build.directory}/workspace
                  <span class="tag">&lt;/juzu.test.workspace.path&gt;</span>
                <span class="tag">&lt;/systemPropertyVariables&gt;</span>
                <span class="tag">&lt;/configuration&gt;</span>
              <span class="tag">&lt;/plugin&gt;</span>

        [...]</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are <strong>xml parsing libraries conflicts</strong> between htmlunit webdriver and our eXo JCR. We’ll need to add some <strong>"exclusions"</strong> tag into the <code>pom.xml</code>. Update the <code>exo.jcr.component.ext</code> dependency:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="xml language-xml">     <span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.exoplatform.jcr<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>exo.jcr.component.ext<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>1.15.x-SNAPSHOT<span class="tag">&lt;/version&gt;</span>
        <span class="tag">&lt;scope&gt;</span>provided<span class="tag">&lt;/scope&gt;</span>
        <span class="tag">&lt;exclusions&gt;</span>
            <span class="tag">&lt;exclusion&gt;</span>
               <span class="tag">&lt;groupId&gt;</span>xml-apis<span class="tag">&lt;/groupId&gt;</span>
               <span class="tag">&lt;artifactId&gt;</span>xml-apis<span class="tag">&lt;/artifactId&gt;</span>
            <span class="tag">&lt;/exclusion&gt;</span>
            <span class="tag">&lt;exclusion&gt;</span>
               <span class="tag">&lt;groupId&gt;</span>org.exoplatform.core<span class="tag">&lt;/groupId&gt;</span>
               <span class="tag">&lt;artifactId&gt;</span>exo.core.component.document<span class="tag">&lt;/artifactId&gt;</span>
            <span class="tag">&lt;/exclusion&gt;</span>
         <span class="tag">&lt;/exclusions&gt;</span>
      <span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>

<h1 id="_test_configuration_and_mocks" class="sect0"><a class="anchor" href="#_test_configuration_and_mocks"></a>Test configuration and Mocks</h1>
<div class="paragraph">
<p>We need to add a <strong>configuration file</strong> for arquillian: <code>src/test/resources/arquillian.xml</code></p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="xml language-xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt;</span>
<span class="tag">&lt;arquillian</span>
  <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
  <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://jboss.org/schema/arquillian</span><span class="delimiter">&quot;</span></span>
  <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://jboss.org/schema/arquillian http://jboss.org/schema/arquillian/arquillian_1_0.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

  <span class="tag">&lt;extension</span> <span class="attribute-name">qualifier</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">webdriver</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="comment">&lt;!-- Needed for html unit web driver --&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">javascriptEnabled</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>true<span class="tag">&lt;/property&gt;</span>
  <span class="tag">&lt;/extension&gt;</span>

  <span class="tag">&lt;container</span> <span class="attribute-name">qualifier</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">tomcat</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;configuration&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">bindHttpPort</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>8080<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/configuration&gt;</span>
  <span class="tag">&lt;/container&gt;</span>

<span class="tag">&lt;/arquillian&gt;</span></code></pre>
</div>
</div>

<h1 id="_overwrite_service_implementation" class="sect0"><a class="anchor" href="#_overwrite_service_implementation"></a>Overwrite service implementation</h1>
<div class="paragraph">
<p>We only want to focus to testing the <strong>JuZcret controller</strong>, but not the JCR service. It’s better to mock the SecretService JCR implementation. The good news is we already have an in-memory service implementation (remember step-2). The bad news is that today we cannot override the service declared in <code>package-info.java</code> in the unit test. For now, we have a workaround and for the future, we plan to improve the juzu-core unit test support.</p>
</div>
<div class="paragraph">
<p>Create a mock for secret service and lets add it into <code>src/test/java/org/juzu/tutorial/services</code>:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="keyword">package</span> <span class="namespace">org.juzu.tutorial.services</span>;

<span class="keyword">import</span> <span class="include">javax.inject.Singleton</span>;

<span class="keyword">import</span> <span class="include">java.util.List</span>;
<span class="keyword">import</span> <span class="include">java.util.Set</span>;

<span class="keyword">import</span> <span class="include">org.juzu.tutorial.models.Comment</span>;
<span class="keyword">import</span> <span class="include">org.juzu.tutorial.models.Secret</span>;

<span class="annotation">@Singleton</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SecretServiceJCRImpl</span> <span class="directive">implements</span> SecretService {

  <span class="directive">private</span> SecretService delegate;

  <span class="directive">public</span> SecretServiceJCRImpl() {
    <span class="local-variable">this</span>.delegate = <span class="keyword">new</span> SecretServiceMemImpl();
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="predefined-type">List</span>&lt;Secret&gt; getSecrets() {
    <span class="keyword">return</span> delegate.getSecrets();
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">void</span> addSecret(<span class="predefined-type">String</span> message, <span class="predefined-type">String</span> imageUrl) {
    delegate.addSecret(message, imageUrl);
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> Comment addComment(<span class="predefined-type">String</span> secretId, Comment comment) {
    <span class="keyword">return</span> delegate.addComment(secretId, comment);
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; addLike(<span class="predefined-type">String</span> secretId, <span class="predefined-type">String</span> userId) {
    <span class="keyword">return</span> delegate.addLike(secretId, userId);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Classloader of the test will load this service <code>SecretServiceJCRImpl</code> instead of the one in main source. This mock service <strong>delegate</strong> all the task to our in-memory implementation.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">

If you are using IntelliJ you can get a "Duplicate class found in the file" warning due to the fact that we have two <code>SecretServiceJCRImpl</code> in the same package (one in <code>/main</code>, one in <code>/test</code>). Just ignore it.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We also have <code>SessionProviderService</code> and <code>NodeHierarchyCreator</code> which are eXo JCR service in <code>package-info.java</code>. We don’t need them for the test but we didn&#8217;t declare an implementation for them in <code>package-info.java</code>. So we will mock the <strong>eXo kernel provider</strong> to avoid to get an error when it will try to bind the implementation.</p>
</div>
<div class="paragraph">
<p>Lets mock the <strong>eXo kernel provider</strong> in <code>src/test/java/org/juzu/tutorial</code>:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="keyword">package</span> <span class="namespace">org.juzu.tutorial</span>;

<span class="keyword">import</span> <span class="include">javax.inject.Provider</span>;

<span class="keyword">import</span> <span class="include">juzu.inject.ProviderFactory</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">MockProviderFactory</span> <span class="directive">implements</span> ProviderFactory {

  <span class="annotation">@Override</span>
  <span class="directive">public</span> &lt;T&gt; <span class="predefined-type">Provider</span>&lt;? <span class="directive">extends</span> T&gt; getProvider(<span class="directive">final</span> <span class="predefined-type">Class</span>&lt;T&gt; implementationType) <span class="directive">throws</span> <span class="exception">Exception</span> {
    <span class="keyword">return</span> <span class="keyword">new</span> <span class="predefined-type">Provider</span>&lt;T&gt;() {
      <span class="annotation">@Override</span>
      <span class="directive">public</span> T get() {
        <span class="keyword">return</span> <span class="predefined-constant">null</span>;
      }
    };
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that the <strong>provider return null instance</strong>, it’s just the <strong>mock provider</strong> to satisfy the IOC container. We don’t need any JCR service instance in the test.</p>
</div>
<div class="paragraph">
<p>We need also to <strong>register the mock</strong> to service loader by creating <code>src/test/resources/META-INF/services/juzu.inject.ProviderFactory</code>:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="text language-text">org.juzu.tutorial.MockProviderFactory</code></pre>
</div>
</div>

<h1 id="_test_cases" class="sect0"><a class="anchor" href="#_test_cases"></a>Test cases</h1>
<div class="paragraph">
<p>We decide to have a dedicated test case for each result of tutorial step. We’ll simulate all available user interaction with the JuZcret portlet using Selenium.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">

There still 2 actions that can not simulated for now: changing the language, and the portlet mode. This should be improved in the future version.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We will develop our Unit Test in <code>JuZcretTestCase.java</code> file in <code>src/test/java/org/juzu/tutorial</code>:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="keyword">package</span> <span class="namespace">org.juzu.tutorial</span>;

<span class="keyword">import</span> <span class="include">juzu.test.AbstractWebTestCase</span>;
<span class="keyword">import</span> <span class="include">org.jboss.arquillian.container.test.api.Deployment</span>;
<span class="keyword">import</span> <span class="include">org.jboss.arquillian.drone.api.annotation.Drone</span>;
<span class="keyword">import</span> <span class="include">org.jboss.shrinkwrap.api.spec.WebArchive</span>;
<span class="keyword">import</span> <span class="include">org.openqa.selenium.WebDriver</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">JuZcretTestCase</span> <span class="directive">extends</span> AbstractWebTestCase {

    <span class="annotation">@Deployment</span>(testable = <span class="predefined-constant">false</span>)
    <span class="directive">public</span> <span class="directive">static</span> WebArchive createDeployment() {
        <span class="keyword">return</span> createPortletDeployment(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.juzu.tutorial</span><span class="delimiter">&quot;</span></span>);
    }

    <span class="annotation">@Drone</span>
    WebDriver driver;

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We use <code>createPortletDeployment</code> method from the <strong>abstract test class</strong> of juzu-core that allow to deploy our portlet into an embedded portlet container.<br>
<strong>WebDriver</strong> is injected by arquillian and help to <strong>simulate</strong> the <strong>user interactions</strong>.</p>
</div>

<h1 id="_test_rendering" class="sect0"><a class="anchor" href="#_test_rendering"></a>Test rendering</h1>
<div class="paragraph">
<p>After step-1, we have a <strong>running portlet</strong>, that render the <code>secretWall.gtmpl</code>. Unit test should help to make a quick test on the result of render process</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="keyword">import</span> <span class="include">org.junit.Test</span>;
<span class="keyword">import</span> <span class="include">org.openqa.selenium.By</span>;
<span class="keyword">import</span> <span class="include">org.openqa.selenium.WebElement</span>;

[...]

  <span class="annotation">@Test</span>
  <span class="directive">public</span> <span class="type">void</span> testRender() <span class="directive">throws</span> <span class="exception">Exception</span> {
    driver.get(getPortletURL().toString());
    WebElement body = driver.findElement(By.tagName(<span class="string"><span class="delimiter">&quot;</span><span class="content">body</span><span class="delimiter">&quot;</span></span>));
    assertTrue(body.getText().indexOf(<span class="string"><span class="delimiter">&quot;</span><span class="content">JuZcret Portlet</span><span class="delimiter">&quot;</span></span>) != -<span class="integer">1</span>);
    <span class="predefined-type">System</span>.out.println(driver.getPageSource());
  }

[...]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Our first test case is very simple:</p>
</div>
<div class="olist arabic">

<ol class="arabic">
<li>
<p>Make the request, get the html body element and be sure that it contains the substring <strong>"JuZcret Portlet"</strong></p>
</li>
<li>
<p>Printing out the whole server response to the console to see the result</p>
</li>
</ol>
</div>

<h1 id="_test_adding_secret" class="sect0"><a class="anchor" href="#_test_adding_secret"></a>Test adding secret</h1>
<div class="paragraph">
<p>After step-2, user is able to <strong>add new secrets</strong>. Thanks to arquillian and webdriver, we can easily simulate user input, and submit form in a JUnit test. Lets add this new test case for adding secret:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="keyword">import</span> <span class="include">org.openqa.selenium.support.ui.ExpectedCondition</span>;
<span class="keyword">import</span> <span class="include">org.openqa.selenium.support.ui.WebDriverWait</span>;

[...]

  <span class="annotation">@Test</span>
  <span class="directive">public</span> <span class="type">void</span> testSecret() <span class="directive">throws</span> <span class="exception">Exception</span> {
    driver.get(getPortletURL().toString());
    WebElement body = driver.findElement(By.tagName(<span class="string"><span class="delimiter">&quot;</span><span class="content">body</span><span class="delimiter">&quot;</span></span>));
    assertFalse(body.getText().contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">test secret text</span><span class="delimiter">&quot;</span></span>));

    <span class="comment">// add secret form</span>
    WebElement shareBtn = driver.findElement(By.cssSelector(<span class="string"><span class="delimiter">&quot;</span><span class="content">.secret-wall-heading a</span><span class="delimiter">&quot;</span></span>));
    driver.get(shareBtn.getAttribute(<span class="string"><span class="delimiter">&quot;</span><span class="content">href</span><span class="delimiter">&quot;</span></span>));
    <span class="comment">// input</span>
    WebElement secretInput = driver.findElement(By.tagName(<span class="string"><span class="delimiter">&quot;</span><span class="content">textarea</span><span class="delimiter">&quot;</span></span>));
    secretInput.sendKeys(<span class="string"><span class="delimiter">&quot;</span><span class="content">test secret text</span><span class="delimiter">&quot;</span></span>);
    <span class="comment">// submit</span>
    WebElement submitBtn = driver.findElement(By.tagName(<span class="string"><span class="delimiter">&quot;</span><span class="content">button</span><span class="delimiter">&quot;</span></span>));
    submitBtn.click();

    <span class="comment">// wait for redirecting to index page</span>
    body = <span class="keyword">new</span> WebDriverWait(driver, <span class="integer">10</span>).until(<span class="keyword">new</span> ExpectedCondition&lt;WebElement&gt;() {
      <span class="directive">public</span> WebElement apply(WebDriver drv) {
        <span class="keyword">return</span> drv.findElement(By.tagName(<span class="string"><span class="delimiter">&quot;</span><span class="content">body</span><span class="delimiter">&quot;</span></span>));
      }
    });
    assertTrue(body.getText().contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">test secret text</span><span class="delimiter">&quot;</span></span>));
  }</code></pre>
</div>
</div>
<div class="olist arabic">

<ol class="arabic">
<li>
<p>We assert that there is no text <strong>"test secret text"</strong> in the secret list</p>
</li>
<li>
<p><strong>WebDriver</strong> provide <strong>API for finding elements in a html page</strong>. We find the url for the add secret page</p>
</li>
<li>
<p>Find the textarea, and button, then fill the form, and submit. All are written using java api to simulate the actions. That’s <strong>fast and clean way for UI test</strong></p>
</li>
<li>
<p>After submitting the add secret form, the portlet will redirect to home page, notice that it may take some time, so we need to tell WebDriver to wait until we have the response from server by <code>WebDriverWait</code></p>
</li>
</ol>
</div>

<h1 id="_test_assets" class="sect0"><a class="anchor" href="#_test_assets"></a>Test Assets</h1>
<div class="paragraph">
<p>We have tested for rendering and user interactions. In step 3 we improved the portlet <strong>Look&amp;Feel</strong>. So we should test if the portlet is served with correct assets (css, and js files), to make sure all our declaration for assets in <code>package-info.java</code> are correct:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="keyword">import</span> <span class="include">java.util.HashSet</span>;
<span class="keyword">import</span> <span class="include">java.util.List</span>;
<span class="keyword">import</span> <span class="include">java.util.Set</span>;

[...]

<span class="annotation">@Test</span>
  <span class="directive">public</span> <span class="type">void</span> testAsset() <span class="directive">throws</span> <span class="exception">Exception</span> {
    driver.get(getPortletURL().toString());

    <span class="predefined-type">List</span>&lt;WebElement&gt; scripts = driver.findElements(By.tagName(<span class="string"><span class="delimiter">&quot;</span><span class="content">script</span><span class="delimiter">&quot;</span></span>));
    <span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; srcScripts = <span class="keyword">new</span> <span class="predefined-type">HashSet</span>&lt;<span class="predefined-type">String</span>&gt;();
    <span class="keyword">for</span> (WebElement elem : scripts) {
    srcScripts.add(elem.getAttribute(<span class="string"><span class="delimiter">&quot;</span><span class="content">src</span><span class="delimiter">&quot;</span></span>));
    }
    assertTrue(srcScripts.contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/juzu/assets/org/juzu/tutorial/assets/jquery/1.10.2/jquery.js</span><span class="delimiter">&quot;</span></span>));
    assertTrue(srcScripts.contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/juzu/assets/juzu/impl/plugin/ajax/script.js</span><span class="delimiter">&quot;</span></span>));
    assertTrue(srcScripts.contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/juzu/assets/org/juzu/tutorial/assets/javascripts/secret.js</span><span class="delimiter">&quot;</span></span>));

    WebElement style = driver.findElement(By.tagName(<span class="string"><span class="delimiter">&quot;</span><span class="content">link</span><span class="delimiter">&quot;</span></span>));
    assertEquals(<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/juzu/assets/org/juzu/tutorial/assets/styles/juzcret.css</span><span class="delimiter">&quot;</span></span>,
                   style.getAttribute(<span class="string"><span class="delimiter">&quot;</span><span class="content">href</span><span class="delimiter">&quot;</span></span>));
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>All necessary assets should be in the server response for rendering JuZcret. This test allow to check that all are presents:</p>
</div>
<div class="paragraph">
<p>Our portlet need 3 javascript files:</p>
</div>
<div class="ulist">

<ul>
<li>
<p><strong>scripts.js</strong>: This file is juzu-core ajax script, it provides jquery plugin to make ajax request to our juzu controller method</p>
</li>
<li>
<p><strong>jquery.js</strong>: JQuery is used by script.js and our portlet js</p>
</li>
<li>
<p><strong>secret.js</strong>: Our application js file</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <strong>juzcret.less</strong> should be compiled and served as <strong>juzcret.css</strong>.</p>
</div>

<h1 id="_test_ajax_actions" class="sect0"><a class="anchor" href="#_test_ajax_actions"></a>Test Ajax actions</h1>
<div class="paragraph">
<p>In step-5 we add some user interactions that was done by using Ajax. Fortunately, HtmlUnit do a well job on <strong>simulating browser</strong>. It can execute javascript, even ajax action.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">

Remember that we have enable js in <code>arquillian.xml</code>: <code>&lt;property name="javascriptEnabled"&gt;true&lt;/property&gt;</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Lets test the <strong>like feature</strong>:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java"><span class="keyword">import</span> <span class="include">org.openqa.selenium.support.ui.ExpectedConditions</span>;

[...]

<span class="annotation">@Test</span>
  <span class="directive">public</span> <span class="type">void</span> testLike() <span class="directive">throws</span> <span class="exception">Exception</span> {
    driver.get(getPortletURL().toString());

    <span class="comment">// like</span>
    WebElement likeBtn = driver.findElement(By.cssSelector(<span class="string"><span class="delimiter">&quot;</span><span class="content">.btn-like</span><span class="delimiter">&quot;</span></span>));
    likeBtn.click();

    <span class="comment">// wait</span>
    By selector = By.cssSelector(<span class="string"><span class="delimiter">&quot;</span><span class="content">.btn-like .numb</span><span class="delimiter">&quot;</span></span>);
    ExpectedCondition&lt;<span class="predefined-type">Boolean</span>&gt; condition = ExpectedConditions.textToBePresentInElement(selector, <span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>);
    assertTrue(<span class="keyword">new</span> WebDriverWait(driver, <span class="integer">10</span>).until(condition));
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The test is pretty simple:</p>
</div>
<div class="olist arabic">

<ol class="arabic">
<li>
<p>Requesting the index page, click the like button</p>
</li>
<li>
<p>Don’t forget to wait until we have server response, the timeout is 10 second</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The last test, the <strong>comment feature</strong> test case:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="java language-java">  <span class="annotation">@Test</span>
  <span class="directive">public</span> <span class="type">void</span> testComment() <span class="directive">throws</span> <span class="exception">Exception</span> {
    driver.get(getPortletURL().toString());
    WebElement body = driver.findElement(By.tagName(<span class="string"><span class="delimiter">&quot;</span><span class="content">body</span><span class="delimiter">&quot;</span></span>));
    assertFalse(body.getText().contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">test comment</span><span class="delimiter">&quot;</span></span>));

    <span class="comment">// input</span>
    WebElement commentInput = driver.findElement(By.cssSelector(<span class="string"><span class="delimiter">&quot;</span><span class="content">.secret-add-comment</span><span class="delimiter">&quot;</span></span>));
    commentInput.sendKeys(<span class="string"><span class="delimiter">&quot;</span><span class="content">test comment</span><span class="delimiter">&quot;</span></span>);
    <span class="comment">// submit</span>
    WebElement submitBtn = driver.findElement(By.cssSelector(<span class="string"><span class="delimiter">&quot;</span><span class="content">.btn-comment</span><span class="delimiter">&quot;</span></span>));
    submitBtn.click();
    <span class="comment">// wait</span>
    ExpectedCondition&lt;<span class="predefined-type">Boolean</span>&gt; condition = ExpectedConditions.textToBePresentInElement(By.cssSelector(<span class="string"><span class="delimiter">&quot;</span><span class="content">.secr-comments-list</span><span class="delimiter">&quot;</span></span>),
                                                                                       <span class="string"><span class="delimiter">&quot;</span><span class="content">test comment</span><span class="delimiter">&quot;</span></span>);
    assertTrue(<span class="keyword">new</span> WebDriverWait(driver, <span class="integer">10</span>).until(condition));
  }</code></pre>
</div>
</div>
<div class="olist arabic">

<ol class="arabic">
<li>
<p>Check that no comment with the substring "test comment" already exist</p>
</li>
<li>
<p>Add a new comment with the message "test comment"</p>
</li>
<li>
<p>Click on the button to submit the new comment</p>
</li>
<li>
<p>Don’t forget to wait until we have server response, the timeout is 10 second</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Now our <strong>JuZcret application is complete</strong>.</p>
</div>
<div class="paragraph">
<p>Perform a</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="CodeRay"><code class="text language-text">$ mvn clean install</code></pre>
</div>
</div>
<div class="paragraph">
<p>and ensure that all tests success.</p>
</div>
<div class="paragraph">
<p>This step is the end of the JuZcret tutorial.<br>
Apprentice, you can be proud. You are now a <strong>true Juzu developer</strong> with the capability to develop more and more funny Juzu applications and <strong>evangelize Juzu around you</strong>.</p>
</div>
<div class="paragraph">
<p>If you have any questions, <a href="http://community.exoplatform.com/portal/g/:spaces:juzu/juzu/forum">jump to the Juzu forum</a>, we will be pleased to help you.</p>
</div>
<div class="paragraph">
<p>If you want to contribute to Juzu, <a href="https://github.com/juzu">here is the Github repo</a> and don’t hesitate to contact us.</p>
</div>
<script type="text/javascript">
//Get the left menu
var leftmenu = document.getElementsByClassName("sectlevel0")[0];

//Create back to menu link
var menuLink = document.createElement("a");
menuLink.href = "./index.html";
menuLink.appendChild(document.createTextNode("Menu"));
var menu = document.createElement("li");
menu.setAttribute("class", "menuStep");
menu.appendChild(menuLink);

//Create go to previous step link
var previousStepLink = document.createElement("a");
previousStepLink.href = "./step6.html";
previousStepLink.appendChild(document.createTextNode("Back to previous Step"));
var previousStep = document.createElement("li");
previousStep.setAttribute("class", "previousStep");
previousStep.appendChild(previousStepLink);

//Add them to Left Menu
leftmenu.insertBefore(previousStep, leftmenu.firstChild);
leftmenu.insertBefore(menu, leftmenu.firstChild);
</script>

</div>
<div id="footer">
<div id="footer-text">
Last updated 2015-04-24 14:06:58 CEST
</div>
</div>
</body>
</html>