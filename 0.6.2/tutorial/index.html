
<!DOCTYPE html
  SYSTEM "">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title></title><link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap.css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.76.1"><meta name="viewport" content="width=device-width, initial-scale=1.0"><script src="js/bootstrap/jquery-1.7.1.min.js"></script><script src="js/bootstrap/bootstrap-2.2.2.min.js"></script><script src="js/bootstrap/docbook-sidebar.js"></script><script src="js/bootstrap/google-code-prettify/prettify.js"></script></head><body onload="if (prettyPrint) { prettyPrint() }"><div class="book container"><div class="titlepage"><hr></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="preface"><a href="#d5e2">Preface</a></span></dt><dt><span class="chapter"><a href="#quickstart">1. Quickstart </a></span></dt><dd><dl><dt><span class="section"><a href="#d5e10">Deploy the applications</a></span></dt><dt><span class="section"><a href="#d5e54">Interacting with the application</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e104">Packaging the application in Tomcat</a></span></dt><dt><span class="section"><a href="#d5e119">Packaging the application for the GateIn portal</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#template_overview">2. Template overwiew </a></span></dt><dt><span class="chapter"><a href="#dependency_injection">3. Dependency Injection </a></span></dt><dt><span class="chapter"><a href="#views">4. Views </a></span></dt><dt><span class="chapter"><a href="#actions">5. Actions </a></span></dt><dt><span class="chapter"><a href="#type_safe_templating">6. Type safe templating </a></span></dt><dt><span class="chapter"><a href="#styled">7. Styling the application </a></span></dt><dd><dl><dt><span class="section"><a href="#d5e309">The style</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e313">A la carte</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e324">Plugins in action</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e332">Less compilation</a></span></dt><dt><span class="section"><a href="#d5e353">Injecting CSS</a></span></dt><dt><span class="section"><a href="#d5e368">Bringing CSS to life</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#ajax">8. Adding Ajax </a></span></dt><dd><dl><dt><span class="section"><a href="#d5e399">Javascript to the rescue</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e411">Adding scripts</a></span></dt><dt><span class="section"><a href="#d5e454">The collapse plugin</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e471">Bridge the gap with Ajax</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e474">Resource controller</a></span></dt><dt><span class="section"><a href="#d5e488">JQuery</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#testing">9. Testing our application </a></span></dt><dd><dl><dt><span class="section"><a href="#d5e565">Setting up the test</a></span></dt><dt><span class="section"><a href="#d5e617">Testing the app</a></span></dt></dl></dd><dt><span class="chapter"><a href="#d5e633">10. Wrap up</a></span></dt></dl></div><div class="list-of-figures"><p><b>List of Figures</b></p><dl><dt>7.1. <a href="#d5e372">The Bootstrapized application</a></dt></dl></div><div class="list-of-examples"><p><b>List of Examples</b></p><dl><dt>3.1. <a href="#d5e183">Using Spring IOC in a servlet</a></dt><dt>3.2. <a href="#d5e190">Using Spring IOC in a portlet</a></dt><dt>7.1. <a href="#d5e318">The necessary Bootstrap less files</a></dt><dt>7.2. <a href="#d5e358">Injecting Bootstrap CSS in our application</a></dt><dt>9.1. <a href="#d5e570">Using the Arquillian runner</a></dt><dt>9.2. <a href="#d5e582">Application deployment</a></dt><dt>9.3. <a href="#d5e600">Arquillian injection</a></dt><dt>9.4. <a href="#d5e609">Creating URL for an application</a></dt><dt>9.5. <a href="#d5e621">Creating URL for an application</a></dt></dl></div>
  <div class="preface" title="Preface"><div class="titlepage"><div><div><div xmlns:d="http://docbook.org/ns/docbook" class="page-header"><h1><a name="d5e2"></a>Preface</h1></div></div></div></div>
    
    <p>Juzu is a web framework based on MVC concepts for developing applications. Juzu is an open source project developed on GitHub <a class="ulink" href="https://github.com/juzu/juzu" target="_top">project</a> licensed under the <a class="ulink" href="http://www.gnu.org/licenses/lgpl-2.1.html" target="_top">LGPL 2.1</a> license.</p>
    <p>This tutorial will make you familliar with Juzu, to reach our objective we will develop a weather application in several steps, each step introducing a new feature to gradually improve the application.</p>
  </div>
  <div class="chapter" title="Chapter&nbsp;1.&nbsp;Quickstart"><div class="titlepage"><div><div><div xmlns:d="http://docbook.org/ns/docbook" class="page-header"><h1><a name="quickstart"></a>Chapter&nbsp;1.&nbsp;Quickstart </h1></div></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d5e10">Deploy the applications</a></span></dt><dt><span class="section"><a href="#d5e54">Interacting with the application</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e104">Packaging the application in Tomcat</a></span></dt><dt><span class="section"><a href="#d5e119">Packaging the application for the GateIn portal</a></span></dt></dl></dd></dl></div>
    
    <div class="section" title="Deploy the applications"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e10"></a>Deploy the applications</h2></div></div></div>
      
      <p>Before diving in the technical part of this tutorial, we need to study how to deploy the examples and how to use them. In the package you downloaded you will find a war file adapted to your portal server in the <code class="code">/tutorial</code> directory:</p>
      <div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
          <p>
            <code class="code">juzu-tutorial-examples-tomcat.war</code> for the Tomcat server</p>
        </li><li class="listitem">
          <p>
            <code class="code">juzu-tutorial-examples-gatein.war</code> for the GateIn portal server</p>
        </li><li class="listitem">
          <p>
            <code class="code">juzu-tutorial-examples-liferay.war</code> for the Liferay portal server</p>
        </li></ul></div>
      <div class="alert alert-success alert-block" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3>
        <p>In Tomcat server the application is executed as a Servlet whereas in GateIn or Liferay, the application is executed as a Portlet.</p>
      </div>
      <p>The main reason we have several servers is that the jars are not exactly the same, each is adapted to the server you will use. When you deploy the applications, the deployment process will print information in the console, similar to:</p>
      <pre class="screen">INFO: Deploying web application archive juzu-tutorial-tomcat.war
[Weather1Portlet] Using injection CDI_WELD
[Weather1Portlet] Building application
[Weather1Portlet] Starting Weather1Application
[Weather2Portlet] Using injection CDI_WELD
[Weather2Portlet] Building application
[Weather2Portlet] Starting Weather2Application
[Weather3Portlet] Using injection INJECT_SPRING
[Weather3Portlet] Building application
[Weather3Portlet] Starting Weather3Application
....</pre>
      <p>As we can notice, there are 8 applications deployed, one for each of the topic of this tutorial</p>
      <div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
          <p>Weather1Application: <a class="xref" href="#quickstart" title="Chapter&nbsp;1.&nbsp;Quickstart">Chapter&nbsp;1, <i>Quickstart </i></a>
          </p>
        </li><li class="listitem">
          <p>Weather2Application: <a class="xref" href="#template_overview" title="Chapter&nbsp;2.&nbsp;Template overwiew">Chapter&nbsp;2, <i>Template overwiew </i></a>
          </p>
        </li><li class="listitem">
          <p>Weather3Application: <a class="xref" href="#dependency_injection" title="Chapter&nbsp;3.&nbsp;Dependency Injection">Chapter&nbsp;3, <i>Dependency Injection </i></a>
          </p>
        </li><li class="listitem">
          <p>Weather4Application: <a class="xref" href="#views" title="Chapter&nbsp;4.&nbsp;Views">Chapter&nbsp;4, <i>Views </i></a>
          </p>
        </li><li class="listitem">
          <p>Weather5Application: <a class="xref" href="#actions" title="Chapter&nbsp;5.&nbsp;Actions">Chapter&nbsp;5, <i>Actions </i></a>
          </p>
        </li><li class="listitem">
          <p>Weather6Application: <a class="xref" href="#type_safe_templating" title="Chapter&nbsp;6.&nbsp;Type safe templating">Chapter&nbsp;6, <i>Type safe templating </i></a>
          </p>
        </li><li class="listitem">
          <p>Weather7Application: <a class="xref" href="#styled" title="Chapter&nbsp;7.&nbsp;Styling the application">Chapter&nbsp;7, <i>Styling the application </i></a>
          </p>
        </li><li class="listitem">
          <p>Weather8Application: <a class="xref" href="#ajax" title="Chapter&nbsp;8.&nbsp;Adding Ajax">Chapter&nbsp;8, <i>Adding Ajax </i></a>
          </p>
        </li></ul></div>
    </div>
    <div class="section" title="Interacting with the application"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e54"></a>Interacting with the application</h2></div></div></div>
      
      <p>The first version of the application shows the most basic Juzu application. Our application is declared in the <code class="code">examples.tutorial.weather1</code> package package annotated with the <code class="code">@Application</code> annotation This annotation declares a Juzu application and does not require any mandatory value. Like classes, methods or fields, Java packages can be annotated, such packages declaration are represented by a special file named <code class="code">package-info.java</code>.</p>
      <p>The first thing to do when developping a Juzu application is to declare the application. The package of the application must be annotated with the <code class="code">@juzu.Application</code> annotation to declare the application. The Java file <span class="italic">examples/tutorial/weather1/package-info.java</span> contains the package declaration along with the annotation:</p>
      <div class="programlistingco"><pre class="prettyprint language-java">@Application
@Route("/weather1")
@Portlet
package examples.tutorial.weather1;</pre></div>
      <p>Along with the <code class="code">@Application</code> annotation there are two other annotations <code class="code">@Route</code> and <code class="code">@Portlet</code>:</p>
      <div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
          <p>The <code class="code">@Route</code> annotation defines the route of the application when the application is used as a servlet. It binds the application to the <span class="italic">/weather1</span> path.</p>
        </li><li class="listitem">
          <p>The <code class="code">@Portlet</code> annotation generates a portlet application class used by the portlet container</p>
        </li></ul></div>
      <p>Both annotations are not coupled, you can use either the <code class="code">@Route</code> or the <code class="code">@Portlet</code> annotation, or both  if you want tod deploy your application in both runtimes.</p>
      <p>This is enough to create an empty Juzu application, now let's see the application itself!</p>
      <p>Usually an application is made of controllers and templates, in this example, the <code class="code">Weather</code> Java class contains a method annotated with the <code class="code">@View</code> annotation, which turns the <code class="code">Weather</code> class into a Juzu controller. The controller method <code class="code">index()</code> is the name of the default method that Juzu will call.</p>
      <div class="programlistingco"><pre class="prettyprint language-java">  @View
  public void index() {
    index.render();
  }</pre></div>
      <p>Methods annotated by <code class="code">@View</code> have the unique purpose of providing markup, they are called <span class="italic">views</span>. In our case, the method delegates the rendering to the <code class="code">index.gtmpl</code> template. The template is injected in the controller thanks to the <code class="code">@Inject</code> annotation and the <code class="code">@Path("index.gtmpl")</code> annotation.</p>
      <div class="programlistingco"><pre class="prettyprint language-java">  @Inject
  @Path("index.gtmpl")
  Template index;</pre></div>
      <p>By default templates are located in the <code class="code">templates</code> package of the application, in our case the <code class="code">examples.tutorial.weather1.templates</code> package. The <code class="code">@Path</code> annotation specifies the path of the template in this package. The templates are located in the same source tree than the java classes because the files must be available for the Java compiler.</p>
      <p>The last step of this section is to explain how to package the application, let's see how to do that.</p>
      <div class="section" title="Packaging the application in Tomcat"><div class="titlepage"><div><div><h3 class="title"><a name="d5e104"></a>Packaging the application in Tomcat</h3></div></div></div>
        
        <p>We need to provide a <span class="italic">web.xml</span> descriptor:</p>
        <div class="programlistingco"><pre class="prettyprint">&lt;web-app xmlns="http://java.sun.com/xml/ns/javaee"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"
         version="3.0"&gt;
  &lt;context-param&gt;
    &lt;param-name&gt;juzu.run_mode&lt;/param-name&gt;
    &lt;param-value&gt;prod&lt;/param-value&gt;
  &lt;/context-param&gt;
&lt;/web-app&gt;</pre></div>
        <p>There are two servlets used for serving the application:</p>
        <div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
            <p>The <code class="code">JuzuServlet</code> serves the Juzu applications contained in the war file</p>
          </li><li class="listitem">
            <p>The <code class="code">AssetServlet</code> serves the asset of the applications such as stylesheets or JavaScript</p>
          </li></ul></div>
      </div>
      <div class="section" title="Packaging the application for the GateIn portal"><div class="titlepage"><div><div><h3 class="title"><a name="d5e119"></a>Packaging the application for the GateIn portal</h3></div></div></div>
        
        <p>Our application is annotated with the <code class="code">juzu.plugin.portlet.Portlet</code> annotation. The <code class="code">@Portlet</code> annotation generates a Java class <code class="code">examples.tutorial.weather1.Weather1Portlet</code> that we specifies in the <span class="italic">WEB-INF/portlet.xml</span> deployment descriptor of the web application:</p>
        <div class="programlistingco"><pre class="prettyprint language-xml">&lt;portlet&gt;
  &lt;portlet-name&gt;Weather1Portlet&lt;/portlet-name&gt;
  &lt;portlet-class&gt;examples.tutorial.weather1.Weather1Portlet&lt;/portlet-class&gt;
&lt;/portlet&gt;</pre></div>
      </div>
    </div>
  </div>
  <div class="chapter" title="Chapter&nbsp;2.&nbsp;Template overwiew"><div class="titlepage"><div><div><div xmlns:d="http://docbook.org/ns/docbook" class="page-header"><h1><a name="template_overview"></a>Chapter&nbsp;2.&nbsp;Template overwiew </h1></div></div></div></div>
    
    <p>Now we will improve our application by exploring a bit the templating engine.  We will show a quick overview of Juzu templating system. Templates are essentially made of static part (usually markup) and dynamic parts. In this section we will focus on explaining the use of dynamic expression in a template.</p>
    <p>The application shows how a view can provide variable input for a dynamic template with parameters. Our application has  a view controller and a template, but now the template contains the <code class="code">${ }</code> expression that makes it dynamic.</p>
    <div class="programlistingco"><pre class="prettyprint">The weather temperature in ${location} is ${temperature} degrees.</pre></div>
    <p>Like before the template is used in the view controller but now we use a <code class="code">Map</code> containing the <code class="code">location</code> and <code class="code">temperature</code> parameters.</p>
    <div class="programlistingco"><pre class="prettyprint language-java">  @View
  public void index() {
    Map&lt;String, Object&gt; parameters = new HashMap&lt;String, Object&gt;();
    parameters.put("location", "marseille");
    parameters.put("temperature", "20");
    index.render(parameters);
  }</pre></div>
    <p>During the template rendering, the <code class="code">location</code> and <code class="code">temperature</code> expressions are resolved to the value provided by the view controller. When a template is rendered, an optional map can be provided, this map will be available during the rendering of the template for resolving expression.</p>
  </div>
  <div class="chapter" title="Chapter&nbsp;3.&nbsp;Dependency Injection"><div class="titlepage"><div><div><div xmlns:d="http://docbook.org/ns/docbook" class="page-header"><h1><a name="dependency_injection"></a>Chapter&nbsp;3.&nbsp;Dependency Injection </h1></div></div></div></div>
    
    <p>The next step is to make our application obtain real data instead of the hardcoded values we used in the previous section. For this matter we use a remote service that we encapsulate into the <code class="code">WeatherService</code>.</p>
    <div class="programlistingco"><pre class="prettyprint language-java">public class WeatherService {

  /** A cache for temperatures. */
  private final HashMap&lt;String, String&gt; cache = new HashMap&lt;String, String&gt;();

  public WeatherService() {
    System.out.println("aezfzef");
  }

  /**
   * Returns the temperature for the specifed location in celsius degrees.
   *
   * @param location the location
   * @return the temperature
   */
  public String getTemperature(String location) {
    String temperature = cache.get(location);
    if (temperature == null) {
      cache.put(location, temperature = retrieveTemperature(location));
    }
    return temperature;
  }

  private String getValue(String url, String xpath) throws Exception {
    XPathExpression expr = XPathFactory.
        newInstance().newXPath().compile(xpath);
    InputSource src = new InputSource(url);
    return expr.evaluate(src);
  }

  /**
   * Retrieve the temperature.
   *
   * @param location the location
   * @return the temperature
   */
  protected String retrieveTemperature(String location) {
    try {
      // First we get the location WOEID
      String woeidURL =
          "http://query.yahooapis.com/v1/public/yql" +
              "?q=select%20*%20from%20geo.places%20where%20text%3D%22" +
              URLEncoder.encode(location, "UTF-8") +
              "%22&amp;format=xml";
      String woeid = getValue(woeidURL, "//*[local-name()='woeid']/text()");

      // Now get weather temperature
      String weatherURL =
          "http://weather.yahooapis.com/forecastrss?w=" +
              URLEncoder.encode(woeid, "UTF-8") +
              "&amp;u=c";
      return getValue(weatherURL, "//*[local-name()='condition']/@temp");
    }
    catch (Exception e) {
      // Unavailable
      return "?";
    }
  }
}</pre></div>
    <p>Juzu uses dependency injection to interact with a service layer. The <a class="ulink" href="http://jcp.org/en/jsr/detail?id=330" target="_top">JSR-330</a>,  also knowns as <code class="code">@Inject</code>, defines an API for dependency injection. The <code class="code">WeatherService</code> is injected in the  controller with the <code class="code">weatherService</code> field annotated with the <code class="code">@Inject</code> annotation:</p>
    <div class="programlistingco"><pre class="prettyprint language-java">  @Inject
  WeatherService weatherService;</pre></div>
    <p>This service is then simply used into our controller <code class="code">index()</code> method:</p>
    <div class="programlistingco"><pre class="prettyprint language-java">  @View
  public void index() {
    Map&lt;String, Object&gt; parameters = new HashMap&lt;String, Object&gt;();
    parameters.put("location", "marseille");
    parameters.put("temperature", weatherService.getTemperature("marseille"));
    index.render(parameters);
  }</pre></div>
    <p>As we can see, Juzu relies on the portable <code class="code">@Inject</code> annotation to declare sinjections. Injection is performed by the dependency injection container. At the moment the following containers are supported:</p>
    <div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
        <p>
          <a class="ulink" href="http://www.springsource.org/" target="_top">Spring Framework</a>
        </p>
      </li><li class="listitem">
        <p>
          <a class="ulink" href="http://seamframework.org/Weld" target="_top">JBoss Weld</a>
        </p>
      </li></ul></div>
    <p>There is a preliminary support for <a class="ulink" href="http://code.google.com/p/google-guice/wiki/Guice30" target="_top">Google Guice 3.0</a>, but it is not yet available. In the future more container support could be achieved.</p>
    <p>By default it uses the <span class="italic">Weld</span> container, if you want instead to use <span class="italic">Spring</span> container instead the configuration is done by a init param defined in the deployment descriptor:</p>
    <p>
      </p><div class="example"><a name="d5e183"></a><p class="title"><b>Example&nbsp;3.1.&nbsp;Using Spring IOC in a servlet</b></p><div class="example-contents">
        
        <div class="programlistingco"><pre class="prettyprint language-xml">&lt;init-param&gt;
  &lt;param-name&gt;juzu.inject&lt;/param-name&gt;
  &lt;param-value&gt;spring&lt;/param-value&gt;
&lt;/init-param&gt;
</pre></div>
      </div></div><p><br class="example-break">
    </p>
    <p>The same can be achieved for a portlet of course:</p>
    <p>
      </p><div class="example"><a name="d5e190"></a><p class="title"><b>Example&nbsp;3.2.&nbsp;Using Spring IOC in a portlet</b></p><div class="example-contents">
        
        <div class="programlistingco"><pre class="prettyprint language-xml">&lt;init-param&gt;
  &lt;name&gt;juzu.inject&lt;/name&gt;
  &lt;value&gt;spring&lt;/value&gt;
&lt;/init-param&gt;
</pre></div>
      </div></div><p><br class="example-break">
    </p>
    <p>In the case of <span class="italic">Spring</span> injection, the file <span class="italic">spring.xml</span> file is needed, it contains the service declarations for the Spring container.</p>
    <p>Juzu provides more advanced dependency injection, in particular it uses the <code class="code">Qualifier</code> and <code class="code">Scope</code> features defined   by the JSR-330 specification, however they are not covered in this tutorial.</p>
  </div>
  <div class="chapter" title="Chapter&nbsp;4.&nbsp;Views"><div class="titlepage"><div><div><div xmlns:d="http://docbook.org/ns/docbook" class="page-header"><h1><a name="views"></a>Chapter&nbsp;4.&nbsp;Views </h1></div></div></div></div>
    
    <p>So far we seen a basic view controller, in this section we will study more in depth view controllers. A view controller is invoked by Juzu when the application needs to be rendered, which can happen anytime during the lifecycle of an application.</p>
    <p>This version has still the <code class="code">index()</code> view controller, but now it has also an overloaded <code class="code">index(String location)</code> method that accept a <code class="code">location</code> argument as a view parameter.</p>
    <div class="programlistingco"><pre class="prettyprint language-java">  @View
  @Route("/show/{location}")
  public void index(String location) {
    Map&lt;String, Object&gt; parameters = new HashMap&lt;String, Object&gt;();
    parameters.put("location", location);
    parameters.put("temperature", weatherService.getTemperature(location));
    index.render(parameters);
  }</pre></div>
    <p>The <code class="code">@Route("/show/{location}")</code> annotation binds the the <code class="code">index</code> controller method to the <span class="italic">/show/*</span> route. Since our our application package is annotated with the <code class="code">@Route("/weather4")</code> annotation, an URL like <span class="italic">/weather4/show/marseille</span> invokes this controller method with the <span class="italic">marseille</span> location.</p>
    <p>View parameters are bound to the current navigation of the application and their value are managed by the framework. At this point it is normal to wonder how a view parameter value can change. Let's have a closer look at the <code class="code">index.gtmpl</code> application template.</p>
    <div class="programlistingco"><pre class="prettyprint">The weather temperature in ${location} is ${temperature} degrees.
&lt;a href="@{index(location = 'marseille')}"&gt;Marseille&lt;/a&gt;
&lt;a href="@{index(location = 'paris')}"&gt;Paris&lt;/a&gt;
</pre></div>
    <p>The template now has two links changing view parameters when they are processed. Such links are created by a special syntax that references the view method, for instance the script fragment <code class="code">@{index(location = 'paris')}</code> generates an url that updates the <code class="code">location</code> view parameter to the <code class="code">paris</code> value when it is processed.</p>
    <p>The initial controller method <code class="code">index()</code> is still there but now it simply invokes the <code class="code">index(String location)</code> controller with a predefined value.</p>
    <div class="programlistingco"><pre class="prettyprint language-java">  @View
  public void index() {
    index("marseille");
  }</pre></div>
    <p>We could't close this section without talking a bit about <span class="bold"><strong>safe urls</strong></span>. Juzu is deeply integrated at the heart of the Java compiler and performs many checks to detect applications bugs during the application compilation. Among those checks, templates are validated and the url syntax <code class="code">@{ }</code> is checked against the application controllers. In fact Juzu will resolve an url syntax until it finds one controller that resolves the specified name and parameters. If not Juzu will make the compilation fail and give detailled information about the error. This kind of feature makes Juzu really unique among all other web frameworks, we will see some other later.</p>
    <div class="alert alert-success alert-block" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3>
      <p>Juzu leverages the <a class="ulink" href="http://download.oracle.com/javase/6/docs/technotes/guides/apt/index.html" target="_top">Annotation Processing Tool</a> (APT) facility standardized since Java 6. APT works with any Java compiler and is not specific to a build system or IDE, it just works anywhere, we will see later that it even works with Eclipse incremental compiler.</p>
    </div>
  </div>
  <div class="chapter" title="Chapter&nbsp;5.&nbsp;Actions"><div class="titlepage"><div><div><div xmlns:d="http://docbook.org/ns/docbook" class="page-header"><h1><a name="actions"></a>Chapter&nbsp;5.&nbsp;Actions </h1></div></div></div></div>
    
    <p>Now it's time to introduce action controllers, actions are method annotated by the <code class="code">@Action</code> annotation.</p>
    <p>The role of an action controller is to process actions parameters. Each parameter of an action controller method is mapped to the incoming request processed by Juzu, such parameters can be encoded directly in the URL or be present in the form that triggers the action.</p>
    <div class="programlistingco"><pre class="prettyprint">The weather temperature in ${location} is ${temperature} degrees.

&lt;ul&gt;&lt;% locations.each() { location -&gt; %&gt;
&lt;li&gt;&lt;a href="@{index(location = location)}"&gt;${location}&lt;/a&gt;&lt;/li&gt;
&lt;% } %&gt;
&lt;/ul&gt;

&lt;form action="@{add()}" method="post"&gt;
   &lt;input type="text" name="location" value=""/&gt;
   &lt;input type="submit"/&gt;
&lt;/form&gt;</pre></div>
    <p>In this example, we use a form which contains the the <code class="code">location</code> action parameters. In order to create an action url we use the same syntax than view url <code class="code">@{add()}</code> but this time we don't need to set any parameter, instead the form parameters will be used when the form is submitted. However this is not mandatory and instead we could have url parameters such as <code class="code">@{add(location = 'washington'}</code>, such syntax is valid specially when it is used without a form. Obviously there is the possibility to mix form and action parameters.</p>
    <p>When the url is processed, the following action controller method will be invoked:</p>
    <div class="programlistingco"><pre class="prettyprint language-java">  @Action
  @Route("/add")
  public Response.View add(String location) {
    locations.add(location);
    return Weather_.index(location);
  }</pre></div>
    <p>The method is annotated with two annotations:</p>
    <div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
        <p>
          <code class="code">@Action</code> declares an action controller method</p>
      </li><li class="listitem">
        <p>
          <code class="code">@Route("/add")</code> binds the action on the <span class="italic">/weather5/add</span> route</p>
      </li></ul></div>
    <p>The <code class="code">location</code> parameter is not declared in the route because it can be invoked by a form and the <code class="code">location</code> parameter is part of it.</p>
    <p>The method returns a <code class="code">Response.View</code> object. This object instructs Juzu to use the <code class="code">index(String location)</code>  controller view after the action. The <code class="code">Weather_</code> controller compagnion provides a type safe way for generating  the response: <code class="code">Weather_.index(location)</code>. Our action just needs to return it, Juzu will take care of showing  the corresponding view after invoking the action.</p>
  </div>
  <div class="chapter" title="Chapter&nbsp;6.&nbsp;Type safe templating"><div class="titlepage"><div><div><div xmlns:d="http://docbook.org/ns/docbook" class="page-header"><h1><a name="type_safe_templating"></a>Chapter&nbsp;6.&nbsp;Type safe templating </h1></div></div></div></div>
    
    <p>We have seen previously how to render templates from a controller and how we can pass parameters for rendering a template. Templates use <code class="code">${ }</code> expressions that often refers to parameters passed by the controller. For this purpose we used an <code class="code">HashMap</code> for storing the various parameters used during rendering.</p>
    <p>This syntax is a generic way and uses an untyped syntax, indeed if a template parameter name changes the controller will continue to compile because of the generic parameter map.  To improve this situation, parameters can be declared thanks to a <code class="code">param</code> tag inside the template:</p>
    <div class="programlistingco"><pre class="prettyprint">#{param name=location/}
#{param name=temperature/}
#{param name=locations/}

The weather temperature in ${location} is ${temperature} degrees.

&lt;ul&gt;&lt;% locations.each() { location -&gt; %&gt;
&lt;li&gt;&lt;a href="@{index(location = location)}"&gt;${location}&lt;/a&gt;&lt;/li&gt;
&lt;% } %&gt;
&lt;/ul&gt;

&lt;form action="@{add()}" method="post"&gt;
   &lt;input type="text" name="location" value=""/&gt;
   &lt;input type="submit"/&gt;
&lt;/form&gt;</pre></div>
    <p>For example the <code class="code">location</code> parameter is declared by the <code class="code">#{param name=location/}</code> tag. During the Java compilation, Juzu leverage such parameter declarations to provide a more convenient way to render a template.</p>
    <p>The tight integration with the Java compiler allows Juzu to generate a template class for each template of the application, those template classes inherits the <code class="code">Template</code> class and adds specific methods for passing them parameters in a safe manner.</p>
    <div class="programlistingco"><pre class="prettyprint language-java">  @View
  public void index(String location) {
    index.
      with().
      location(location).
      temperature(weatherService.getTemperature(location)).
      locations(locations).
      render();
  }</pre></div>
    <p>As we can see, the <code class="code">HashMap</code> is not used anymore and now we use a type safe and compact expression for rendering the template. Each declared parameter generates a method named by the parameter name, for the <code class="code">location</code> parameter, we do have now a <code class="code">location(String location)</code> method that can be used.</p>
    <p>To make the syntax fluent, the parameter methods can be chained, finally the <code class="code">render()</code> method is invoked to render the template, however it does not require any parameter since all parameters where passed thanks to the parameter methods.</p>
    <p>The Java name of the generated template class is the name of the template in the <code class="code">templates</code> package of the application. In our case we do obtain the <code class="code">examples.tutorial.weather6.templates.index</code> class name. It is very easy to use our subclass by injecting the template subclass instead of the generic <code class="code">Template</code> class.</p>
    <div class="programlistingco"><pre class="prettyprint language-java">  @Inject
  @Path("index.gtmpl")
  examples.tutorial.weather6.templates.index index;</pre></div>
    <p>Of course it is possible to import this value and use directly the <code class="code">index</code> class name. We used directly the full qualified name of the class for the sake of the clarity.</p>
  </div>
  <div class="chapter" title="Chapter&nbsp;7.&nbsp;Styling the application"><div class="titlepage"><div><div><div xmlns:d="http://docbook.org/ns/docbook" class="page-header"><h1><a name="styled"></a>Chapter&nbsp;7.&nbsp;Styling the application </h1></div></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d5e309">The style</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e313">A la carte</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e324">Plugins in action</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e332">Less compilation</a></span></dt><dt><span class="section"><a href="#d5e353">Injecting CSS</a></span></dt><dt><span class="section"><a href="#d5e368">Bringing CSS to life</a></span></dt></dl></dd></dl></div>
    
    <p>Our application is almost complete, in this section we will work on the look and feel to make the application appealing. We will use the famous <a class="ulink" href="http://twitter.github.com/bootstrap/" target="_top">Twitter Bootstrap</a> framework and show how it integrates well in Juzu applications.</p>
    <div class="section" title="The style"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e309"></a>The style</h2></div></div></div>
      
      <p>Bootstrap provides a solid fundation for building quickly attractive applications.  Bootstrap is based on the dynamic stylesheet language <a class="ulink" href="http://lesscss.org/" target="_top">Less</a> and provides a very modular organization. We will perform trivial modifications to a subset of the Less files and integrate them in our application.</p>
      <div class="section" title="A la carte"><div class="titlepage"><div><div><h3 class="title"><a name="d5e313"></a>A la carte</h3></div></div></div>
        
        <p>We will then modify the <code class="code">bootstrap.less</code> file to keep only what is necessary for our application:</p>
        <p>
          </p><div class="example"><a name="d5e318"></a><p class="title"><b>Example&nbsp;7.1.&nbsp;The necessary Bootstrap less files</b></p><div class="example-contents">
            
            <div class="programlistingco"><pre class="prettyprint">/*!
 * Bootstrap v2.0.3
 *
 * Copyright 2012 Twitter, Inc
 * Licensed under the Apache License v2.0
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Designed and built with all the love in the world @twitter by @mdo and @fat.
 */

// CSS Reset
@import "reset.less";

// Core variables and mixins
@import "variables.less"; // Modify this for custom colors, font-sizes, etc
@import "mixins.less";

// Grid system and page structure
@import "scaffolding.less";

// Base CSS
@import "type.less";
@import "forms.less";

// Components: common
@import "component-animations.less";

// Components: Buttons &amp; Alerts
@import "buttons.less";
@import "button-groups.less";

// Components: Misc
@import "accordion.less";
</pre></div>
          </div></div><p><br class="example-break">
        </p>
        <p>This version of bootstrap.less is a trimmed down of the original files.</p>
      </div>
    </div>
    <div class="section" title="Plugins in action"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e324"></a>Plugins in action</h2></div></div></div>
      
      <p>Juzu can be extended with plugins, in this section we will use two of them</p>
      <div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
          <p>The Less plugin compiles less files into css files</p>
        </li><li class="listitem">
          <p>The Asset plugin inject asset such as stylesheet or javascript in the application page</p>
        </li></ul></div>
      <div class="section" title="Less compilation"><div class="titlepage"><div><div><h3 class="title"><a name="d5e332"></a>Less compilation</h3></div></div></div>
        
        <p>Juzu provides native support for the Less language via the Less plugin and the <code class="code">@Less</code> annotation. It allows a set of less files to be transformed into the corresponding css files during the java compilation, achieving two important steps during the compilation phase:</p>
        <div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
            <p>The less files are transformed into ready to use css files</p>
          </li><li class="listitem">
            <p>It ensures a maximum of safety: the Less parser will report any error in the source</p>
          </li></ul></div>
        <p>Our first step is to create the <code class="code">examples.tutorial.assets</code> package, we copy the Bootstrap Less files into this package and annotate the <code class="code">examples.tutorial</code> package with the <code class="code">@Less</code> annotation to trigger the compilation of the stylesheet  in the <code class="code">assets</code> package:</p>
        <div class="programlistingco"><pre class="prettyprint language-java">@Less(value = "bootstrap.less", minify = true)
package examples.tutorial;

import juzu.plugin.less.Less;</pre></div>
        <p>This annotation triggers the compilation of the <code class="code">bootstrap.less</code> in the <code class="code">assets</code> package, the <code class="code">minified</code> parameter instruct Less to minify the resulting css.</p>
      </div>
      <div class="section" title="Injecting CSS"><div class="titlepage"><div><div><h3 class="title"><a name="d5e353"></a>Injecting CSS</h3></div></div></div>
        
        <p>Now that we have worked out the CSS details we need to make our stylesheet available in the application page. The <span class="italic">asset</span> plugin will achieve this result for us. This plugin provides declarative configuration for the various assets required by an application. It works both for stylesheets and javascript, in this section we use it for stylesheet:</p>
        <p>
          </p><div class="example"><a name="d5e358"></a><p class="title"><b>Example&nbsp;7.2.&nbsp;Injecting Bootstrap CSS in our application</b></p><div class="example-contents">
            
            <div class="programlistingco"><pre class="prettyprint language-java">@Application
@Assets(stylesheets = @Stylesheet(
  src = "/examples/tutorial/assets/bootstrap.css",
  location = AssetLocation.CLASSPATH)
)
package examples.tutorial.weather7;</pre></div>
          </div></div><p><br class="example-break">
        </p>
        <p>The usage is fairly straightforward with the <code class="code">@Assets</code> and <code class="code">Stylesheet</code> annotations. We configure the <code class="code">location</code> parameter to be <code class="code">CLASSPATH</code> because the Less plugin created it there.</p>
      </div>
      <div class="section" title="Bringing CSS to life"><div class="titlepage"><div><div><h3 class="title"><a name="d5e368"></a>Bringing CSS to life</h3></div></div></div>
        
        <p>After this step we need to modify our application template to use the various styles provided by Bootstrap:</p>
        <p>
          </p><div class="figure"><a name="d5e372"></a><p class="title"><b>Figure&nbsp;7.1.&nbsp;The Bootstrapized application</b></p><div class="figure-contents">
            
            <div class="mediaobject" align="center"><img src="images/bootstrap.png" align="middle" width="378" alt="The Bootstrapized application"></div>
          </div></div><p><br class="figure-break">
        </p>
        <p>We will not explain that in details, however we will study the important modifications:</p>
        <div class="section" title="Accordion"><div class="titlepage"><div><div><h4 class="title"><a name="d5e380"></a>Accordion</h4></div></div></div>
          
          <p>The Bootstrap provides the <a class="ulink" href="http://twitter.github.com/bootstrap/javascript.html#collapse" target="_top">Collapse component</a>. We will not use the entire Collapse component here but instead reuse the CSS rules to display the available cities:</p>
          <div class="programlistingco"><pre class="prettyprint">&lt;div class="accordion-group"&gt;
  &lt;div class="accordion-heading"&gt;&lt;a class="accordion-toggle" href="@{index(location = current)}"&gt;${current}&lt;/a&gt;&lt;/div&gt;
  &lt;div class="accordion-body"&gt;
    &lt;div class="accordion-inner"&gt;The weather temperature in ${current} is ${temperature}&amp;deg; ${grade.toUpperCase()}.&lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;</pre></div>
        </div>
        <div class="section" title="Adding a city"><div class="titlepage"><div><div><h4 class="title"><a name="d5e387"></a>Adding a city</h4></div></div></div>
          
          <p>Finally the form for adding is modified to reuse <a class="ulink" href="http://twitter.github.com/bootstrap/base-css.html#forms" target="_top">Bootstrap form support</a>:</p>
          <div class="programlistingco"><pre class="prettyprint">&lt;form action="@{add()}" method="post"&gt;
  &lt;fieldset&gt;
    &lt;div class="controls"&gt;
      &lt;div class="input-append"&gt;
         &lt;input class="span2" type="text" size="16"name="location" value=""/&gt;
         &lt;button type="submit" class="btn"&gt;Add&lt;/button&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/fieldset&gt;
&lt;/form&gt;</pre></div>
        </div>
      </div>
    </div>
  </div>
  <div class="chapter" title="Chapter&nbsp;8.&nbsp;Adding Ajax"><div class="titlepage"><div><div><div xmlns:d="http://docbook.org/ns/docbook" class="page-header"><h1><a name="ajax"></a>Chapter&nbsp;8.&nbsp;Adding Ajax </h1></div></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d5e399">Javascript to the rescue</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e411">Adding scripts</a></span></dt><dt><span class="section"><a href="#d5e454">The collapse plugin</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e471">Bridge the gap with Ajax</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e474">Resource controller</a></span></dt><dt><span class="section"><a href="#d5e488">JQuery</a></span></dt></dl></dd></dl></div>
    
    <p>Now that our application look great, we are going to add a final touch to our application and make it more dynamic.</p>
    <p>In the previous section we introduced the accordion user interface component, but it was used in a static way. In this section we will make it dynamic and introduce the Ajax plugin.</p>
    <p>The accordion component can be combined to the JQuery collapse plugin providing the capability to unfold an item to display the weather of the location. When the item is unfolded an ajax request is performed to the application to retrieve the markup that will be inserted.</p>
    <div class="section" title="Javascript to the rescue"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e399"></a>Javascript to the rescue</h2></div></div></div>
      
      <p>The application will use several Javascript libraries:</p>
      <div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
          <p>The JQuery library provides the fundations for building our application</p>
        </li><li class="listitem">
          <p>The Bootstrap accordion component provides scripts as a JQuery plugin</p>
        </li><li class="listitem">
          <p>Juzu provides Ajax helpers as a JQuery plugin</p>
        </li><li class="listitem">
          <p>A small custom script to setup the accordion plugin with the ajax plugin</p>
        </li></ul></div>
      <div class="section" title="Adding scripts"><div class="titlepage"><div><div><h3 class="title"><a name="d5e411"></a>Adding scripts</h3></div></div></div>
        
        <p>The Asset plugin was introduced in the previous section to handle the serving of the Bootstrap stylesheets. The <code class="code">@Asset</code> annotation can be used also for embedding scripts, but it provides more control about the script, in particular a dependency mechanism to control the order of scripts that we will use: indeed JQuery plugins have to be loaded after the JQuery library is loaded.</p>
        <p>We extend the <code class="code">@Asset</code> annotation to add our scripts:</p>
        <div class="programlistingco"><pre class="prettyprint language-java">@Assets(
   scripts = {
      @Script(
         id = "jquery", <span class="co" id="callout-0__"><img src="images/callouts/1.png" alt="(1)"></span> 
         src = "jquery-1.7.1.min.js",
         location = AssetLocation.CLASSPATH),
      @Script(
         id = "transition",
         src = "bootstrap-transition.js", <span class="co" id="callout-1__"><img src="images/callouts/2.png" alt="(2)"></span> 
         location = AssetLocation.CLASSPATH,
         depends = "jquery"), <span class="co" id="callout-2__"><img src="images/callouts/1.png" alt="(1)"></span> 
      @Script(
         id = "collapse",
         src = "bootstrap-collapse.js",
         location = AssetLocation.CLASSPATH,
         depends = {
            "jquery", // 1
            "transition"}), <span class="co" id="callout-3__"><img src="images/callouts/2.png" alt="(2)"></span> 
      @Script(
         src = "weather.js",
         location = AssetLocation.CLASSPATH,
         depends = {
            "jquery",  <span class="co" id="callout-4__"><img src="images/callouts/1.png" alt="(1)"></span> 
            "collapse"}) <span class="co" id="callout-5_"><img src="images/callouts/3.png" alt="(3)"></span> 
   },
   stylesheets = @Stylesheet(src = "/examples/tutorial/assets/bootstrap.css", location = AssetLocation.CLASSPATH)
)
package examples.tutorial.weather8;


</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><img src="images/callouts/1.png" alt="1" border="0"></p></td><td valign="top" align="left">
              <p>All other scripts than JQuery depends on JQuery</p>
            </td></tr><tr><td width="5%" valign="top" align="left"><p><img src="images/callouts/2.png" alt="2" border="0"></p></td><td valign="top" align="left">
              <p>The <span class="italic">collapse</span> JQuery plugin depends on the <span class="italic">transition</span> script</p>
            </td></tr><tr><td width="5%" valign="top" align="left"><p><img src="images/callouts/3.png" alt="3" border="0"></p></td><td valign="top" align="left">
              <p>Our <span class="italic">weather</span> script depends also on the JQuery <span class="italic">collapse</span> plugin</p>
            </td></tr></table></div></div>
        <p>The declaration is straightforward, any <code class="code">@Script</code> annotation may configure</p>
        <div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
            <p>an optional <code class="code">id</code> used for creating dependencies between scripts</p>
          </li><li class="listitem">
            <p>a mandatory <code class="code">src</code> for the script name</p>
          </li><li class="listitem">
            <p>an optional <code class="code">location</code> for resolving the script</p>
          </li><li class="listitem">
            <p>an optional <code class="code">depends</code> that declares the ids a script depends on</p>
          </li></ul></div>
      </div>
      <div class="section" title="The collapse plugin"><div class="titlepage"><div><div><h3 class="title"><a name="d5e454"></a>The collapse plugin</h3></div></div></div>
        
        <p>The Bootstrap collapse plugin allows the user to unfold a city to display its weather, you can see how it works in the <a class="ulink" href="http://twitter.github.com/bootstrap/javascript.html#collapse" target="_top">Bootstrap manual</a>. In our case we modify the <code class="code">index.gtmpl</code> to use it, in particular the <code class="code">accordion-group</code> part:</p>
        <div class="programlistingco"><pre class="prettyprint">&lt;div class="accordion-group"&gt;
  &lt;div class="accordion-heading"&gt;
    &lt;a class="accordion-toggle" href="#${current}" data-parent="${id}" data-toggle="collapse"&gt;${current}&lt;/a&gt;
  &lt;/div&gt;
  &lt;% def expanded = i != index ? 'in' : ''; %&gt;
  &lt;div id="${current}" class="accordion-body collapse ${expanded}"&gt;
    &lt;div class="accordion-inner"&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;</pre></div>
        <p>There are two noticeable points to explain:</p>
        <div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
            <p>The <code class="code">accordion-inner</code> is empty now, the reason is that the weather will be loaded using JQuery ajax capabilities</p>
          </li><li class="listitem">
            <p>The <code class="code">div.collapse</code> element id is set to the current item location, this value will be reused during an ajax interaction, we will see more about this later.</p>
          </li></ul></div>
      </div>
    </div>
    <div class="section" title="Bridge the gap with Ajax"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e471"></a>Bridge the gap with Ajax</h2></div></div></div>
      
      <p>Now our application loads a set of dynamic tabs managed by JQuery and the collapse plugin, it's time to develop the ajax part: our goal is to load a markup fragment to insert in an accordion item when it is unfolded. We will develop a bit of client side Javascript and a resource controller on the Weather controller.</p>
      <div class="section" title="Resource controller"><div class="titlepage"><div><div><h3 class="title"><a name="d5e474"></a>Resource controller</h3></div></div></div>
        
        <p>We need a controller method to server the markup of the weather of a particular city. Until now we have studied view and action controllers, for this use case we will use a new type of controller : the <span class="italic">resource</span> controller.</p>
        <p>Resource controllers are pretty much like a view controllers except that they must produce the entire response sent to the client and that is precisely what we want to achieve on the server side.</p>
        <p>Our application requires a single resource controller method that we will call <code class="code">getFragment</code>, it will render a markup fragment for a specific city location:</p>
        <div class="programlistingco"><pre class="prettyprint language-java">  @Inject
  @Path("fragment.gtmpl")
  examples.tutorial.weather8.templates.fragment fragment;

  @Ajax
  @Resource
  @Route("/fragment")
  public void getFragment(String location) {
    fragment.
      with().
      location(location).
      temperature(weatherService.getTemperature(location)).
      render();
  }</pre></div>
        <p>The fragment template is very simple and only renders the portion of the screen that will be updated by the client side javascript code when an item is unfolded:</p>
        <div class="programlistingco"><pre class="prettyprint language-java">#{param name=location/}
#{param name=temperature/}
&lt;p&gt;The weather temperature in ${location} is ${temperature} degrees C&lt;/p&gt;
</pre></div>
      </div>
      <div class="section" title="JQuery"><div class="titlepage"><div><div><h3 class="title"><a name="d5e488"></a>JQuery</h3></div></div></div>
        
        <p>The last part of our application is the javascript part that will react on the collapse plugin component to load the markup from the <code class="code">getFragment</code> controller when the item is unfolded. We create the javascript file <code class="code">weather.js</code> in the <code class="code">examples.tutorial.weather8.assets</code>:</p>
        <div class="programlistingco"><pre class="prettyprint language-java">$(function () {

  // Setup an event listener on the .collapse element when it is shown
  $('.collapse').on('show', function () {

    // Get the location attribute from the dom
    var location = $(this).attr("id");

    // Update the .accordion-inner fragment
    $(this).
      closest(".accordion-group").
      find(".accordion-inner").
      each(function () {

      // Load the fragment from the resource controller
      $(this).jzLoad(
        "Weather.getFragment()",
        {"location":location});

    });
  });

  // Setup the collapse component
  $(".collapse").collapse();
});
</pre></div>
        <p>The following construct is important because it ensures that the code inside the function will be executed  when JQuery is loaded:</p>
        <div class="programlistingco"><pre class="prettyprint">$(function() {
  //
});</pre></div>
        <p>If you take time to read the collapse plugin component <a class="ulink" href="http://twitter.github.com/bootstrap/javascript.html#collapse" target="_top">documentation</a> you will see that there are two important things to do for integrating it in our application:</p>
        <div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
            <p>We must setup an event listener on <code class="code">.collapse</code> elements to react to the <code class="code">shown</code> event</p>
          </li><li class="listitem">
            <p>The collapase component is setup with the <code class="code">$(".collapse").collapse()</code> code</p>
          </li></ul></div>
        <p>The important code is inside the <code class="code">show</code> event listener:</p>
        <div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
            <p>The location to display is extracted from the element <code class="code">id</code> on the <code class="code">div.collapse</code> component</p>
          </li><li class="listitem">
            <p>We find the appropriate element to update with the <code class="code">$(this).closest(".accordion-group").find(".accordion-inner")</code> selectors</p>
          </li><li class="listitem">
            <p>On the <code class="code">.accordion-inner</code> element we invoke the resource controller with the <code class="code">jzLoad(...)</code> function</p>
          </li></ul></div>
        <p>The <code class="code">jzLoad</code> function is a JQuery plugin provided by the Juzu ajax plugin. It allows to invoke a controller method using  ajax and cares about propagating the call to the resource controller method. It replaces the standard JQuery <code class="code">load</code> function  and accepts the same argument. However the url part is replaced by a controller method, <code class="code">Weather.getFragment()</code> in our case.</p>
        <p>The Juzu ajax plugin takes care of finding the right URL for invoking the controller method. It is designed to work in a standalone javascript file without requiring <code class="code">&lt;script&gt;</code> tags in the page and works even when multiples instances of the portlets are on the same page.</p>
        <p>When the ajax plugin operates on <code class="code">@Ajax</code> controller method, it wraps the markup with a DOM structure that contains the URL for the <code class="code">@Ajax</code> method of the application:</p>
        <div class="programlistingco"><pre class="prettyprint">&lt;div class="jz"&gt;
  &lt;div data-method-id="Weather.getFragment()" data-url="http://localhost:8080/....."/&gt;
  ...
&lt;/div&gt;</pre></div>
        <p>The <code class="code">jzLoad</code> function is invoked on a portion of the DOM that is wrapped by the <code class="code">div.jz</code> element and this function will simply locate the correct URL using the <code class="code">data-method-id</code> attribute. This makes the same script work with different portlets on the same page.</p>
        <p>Note also that in our code we never used any JQuery selector containing id in order to allow several instances of the same application to work without conflicts.</p>
      </div>
    </div>
  </div>
  <div class="chapter" title="Chapter&nbsp;9.&nbsp;Testing our application"><div class="titlepage"><div><div><div xmlns:d="http://docbook.org/ns/docbook" class="page-header"><h1><a name="testing"></a>Chapter&nbsp;9.&nbsp;Testing our application </h1></div></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d5e565">Setting up the test</a></span></dt><dt><span class="section"><a href="#d5e617">Testing the app</a></span></dt></dl></div>
    
    <p>The last chapter of our tutorial will teach you how to test a Juzu application. Juzu applications can be tested using existing tools, we will use in this chapter the following tools:</p>
    <div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
        <p>
          <a class="ulink" href="http://www.junit.org" target="_top">JUnit 4</a>
        </p>
      </li><li class="listitem">
        <p>
          <a class="ulink" href="http://arquillian.org" target="_top">Arquillian</a> : a framework for managing web containers</p>
      </li><li class="listitem">
        <p>
          <a class="ulink" href="http://www.jboss.org/shrinkwrap" target="_top">ShrinkWrap</a>: Arquillian's little brother for creating Java archives easily</p>
      </li><li class="listitem">
        <p>
          <a class="ulink" href="http://seleniumhq.org/docs/03_webdriver.html" target="_top">Selenium WebDriver</a> : a simple API for simulating browser behavior</p>
      </li></ul></div>
    <p>For making testing easy, Juzu provides a  Maven dependencies containing all the required dependencies for testing an application:</p>
    <div class="programlistingco"><pre class="prettyprint language-xml">&lt;dependency&gt;
  &lt;groupId&gt;junit&lt;/groupId&gt;
  &lt;artifactId&gt;junit&lt;/artifactId&gt;
  &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;org.juzu&lt;/groupId&gt;
  &lt;artifactId&gt;juzu-bom-arquillian&lt;/artifactId&gt;
  &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;org.juzu&lt;/groupId&gt;
  &lt;artifactId&gt;juzu-bom-arquillian-tomcat7&lt;/artifactId&gt;
  &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</pre></div>
    <p>The <span class="italic">juzu-bom-arquillian</span> and <span class="italic">juzu-bom-arquillian-tomcat7</span> provides setup for Arquillian and Selenium for Tomcat7 based testing.</p>
    <div class="section" title="Setting up the test"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e565"></a>Setting up the test</h2></div></div></div>
      
      <p>Let's start by setting up our test class with Arquillian, the goal is to run the Weather application during the test. We will rely on the <a class="ulink" href="http://tomcat.apache.org" target="_top">Tomcat</a> servlet container for running our application and on the Arquillian framework for starting and stopping Tomcat. Arquillian provides a JUnit runner for managing a web container during a unit test:</p>
      <p>
        </p><div class="example"><a name="d5e570"></a><p class="title"><b>Example&nbsp;9.1.&nbsp;Using the Arquillian runner</b></p><div class="example-contents">
          
          <div class="programlistingco"><pre class="prettyprint language-java">@RunWith(Arquillian.class)
public class WeatherTestCase {
}</pre></div>
        </div></div><p><br class="example-break">
      </p>
      <div class="alert alert-success alert-block" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3>
        <p>Arquillian supports also the TestNG framework</p>
      </div>
      <p>This only setup Tomcat during the test, we need to deploy the Weather application and for this we use Arquillian  <code class="code">@Deployment</code> annotation and we return a ShrinkWrap <code class="code">WebArchive</code> object that will be deployed in Tomcat by Arquillian. <code class="code">WebArchive</code> are easy to build programmatically, however we will use an helper provided by Juzu to build the base archive:</p>
      <p>
        </p><div class="example"><a name="d5e582"></a><p class="title"><b>Example&nbsp;9.2.&nbsp;Application deployment</b></p><div class="example-contents">
          
          <div class="programlistingco"><pre class="prettyprint language-java">  @Deployment
  public static WebArchive deployment() {
    WebArchive war = Helper.createBaseServletDeployment(); <span class="co" id="callout-6_"><img src="images/callouts/1.png" alt="(1)"></span> 
    war.addAsWebInfResource(new File("src/test/resources/spring.xml")); <span class="co" id="callout-7_"><img src="images/callouts/2.png" alt="(2)"></span> 
    war.addPackages(true, "examples.tutorial"); <span class="co" id="callout-8_"><img src="images/callouts/3.png" alt="(3)"></span> 
    return war;
  }</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><img src="images/callouts/1.png" alt="1" border="0"></p></td><td valign="top" align="left">
                <p>Create the base servlet deployment</p>
              </td></tr><tr><td width="5%" valign="top" align="left"><p><img src="images/callouts/2.png" alt="2" border="0"></p></td><td valign="top" align="left">
                <p>Add the spring.xml descriptor</p>
              </td></tr><tr><td width="5%" valign="top" align="left"><p><img src="images/callouts/3.png" alt="3" border="0"></p></td><td valign="top" align="left">
                <p>Add the examples.tutorial package</p>
              </td></tr></table></div></div>
        </div></div><p><br class="example-break">
      </p>
      <p>For testing our application we will use Selenium WebDriver managed by Arquillian. Arquillian can inject WebDriver thanks to the <span class="italic">Drone</span> extension and it is quite easy to achieve. We also need the base URL of the Weather application after it is deployed:</p>
      <p>
        </p><div class="example"><a name="d5e600"></a><p class="title"><b>Example&nbsp;9.3.&nbsp;Arquillian injection</b></p><div class="example-contents">
          
          <div class="programlistingco"><pre class="prettyprint language-java">  @Drone
  WebDriver driver;

  @ArquillianResource
  URL deploymentURL;</pre></div>
        </div></div><p><br class="example-break">
      </p>
      <p>The last step of the setup is a little helper method for creating application URL for our applications <span class="italic">weather1</span>, <span class="italic">weather2</span>, ...</p>
      <p>
        </p><div class="example"><a name="d5e609"></a><p class="title"><b>Example&nbsp;9.4.&nbsp;Creating URL for an application</b></p><div class="example-contents">
          
          <div class="programlistingco"><pre class="prettyprint language-java">  public URL getApplicationURL(String application) {
    try {
      return deploymentURL.toURI().resolve(application).toURL();
    }
    catch (Exception e) {
      AssertionFailedError afe = new AssertionFailedError();
      afe.initCause(e);
      throw afe;
    }
  }</pre></div>
        </div></div><p><br class="example-break">
      </p>
      <p>This method simply generates an URL based on the application name, for example <code class="code">getApplicationURL("weather1")</code> returns  the URL for the <span class="italic">weather1</span> application.</p>
    </div>
    <div class="section" title="Testing the app"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e617"></a>Testing the app</h2></div></div></div>
      
      <p>Now that our test class is done we can write a few tests for the application:</p>
      <p>
        </p><div class="example"><a name="d5e621"></a><p class="title"><b>Example&nbsp;9.5.&nbsp;Creating URL for an application</b></p><div class="example-contents">
          
          <div class="programlistingco"><pre class="prettyprint language-java">  @Test
  @RunAsClient
  public void testWeather1() throws Exception {
    URL url = getApplicationURL("weather1"); <span class="co" id="callout-9_"><img src="images/callouts/1.png" alt="(1)"></span> 
    driver.get(url.toString());
    WebElement body = driver.findElement(By.tagName("body"));
    assertTrue(body.getText().contains("The weather application")); <span class="co" id="callout-10_"><img src="images/callouts/2.png" alt="(2)"></span> 
  }</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><img src="images/callouts/1.png" alt="1" border="0"></p></td><td valign="top" align="left">
                <p>Retrieve the application</p>
              </td></tr><tr><td width="5%" valign="top" align="left"><p><img src="images/callouts/2.png" alt="2" border="0"></p></td><td valign="top" align="left">
                <p>Check markup is correct</p>
              </td></tr></table></div></div>
        </div></div><p><br class="example-break">
      </p>
    </div>
  </div>
  <div class="chapter" title="Chapter&nbsp;10.&nbsp;Wrap up"><div class="titlepage"><div><div><div xmlns:d="http://docbook.org/ns/docbook" class="page-header"><h1><a name="d5e633"></a>Chapter&nbsp;10.&nbsp;Wrap up</h1></div></div></div></div>
    
    <p>We reached the ends our walk through Juzu, now you can learn more and study the Booking application. This application can be found in the package you downloaded in the <code class="code">booking</code> directory.</p>
  </div>
</div></body></html>